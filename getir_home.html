<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Rol Kontrolü Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase Modüllerini İçe Aktar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase yapılandırması ve uygulama kimliği, Canvas ortamından sağlanır.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Log seviyesini ayarla (Hata ayıklama için)
        setLogLevel('Debug');

        // Firebase'i Başlat
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase başlatılırken hata oluştu:", error);
        }

        let currentUserId = null;

        // Yetkilendirme durumu değiştiğinde çalışacak listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('user-info').textContent = `Kullanıcı ID: ${currentUserId}`;
                await checkAdminRole();
            } else {
                // Eğer token yoksa anonim olarak oturum açmayı dene
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (error) {
                        console.error("Özel Token ile oturum açma başarısız. Anonim oturum açılıyor:", error);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        // Kullanıcının admin rolünü kontrol eden ana fonksiyon
        async function checkAdminRole() {
            if (!currentUserId || !db) {
                console.warn("Kullanıcı ID veya Firestore hazır değil.");
                return;
            }

            // Firestore rol belgesinin yolu: /artifacts/{appId}/users/{userId}/app_data/admin_role
            const rolePath = `/artifacts/${appId}/users/${currentUserId}/app_data/admin_role`;
            const roleDocRef = doc(db, rolePath);

            try {
                const docSnap = await getDoc(roleDocRef);
                const isAdmin = docSnap.exists() && docSnap.data().isAdmin === true;

                if (isAdmin) {
                    // Admin içeriğini göster
                    document.getElementById('admin-content').classList.remove('hidden');
                    document.getElementById('access-denied').classList.add('hidden');
                    document.getElementById('grant-role-container').classList.add('hidden');
                    document.getElementById('status-message').textContent = 'Durum: Yetkili Admin';
                } else {
                    // Yetkisiz içeriği göster ve yetki verme butonunu göster
                    document.getElementById('admin-content').classList.add('hidden');
                    document.getElementById('access-denied').classList.remove('hidden');
                    document.getElementById('grant-role-container').classList.remove('hidden');
                    document.getElementById('status-message').textContent = 'Durum: Yetkisiz Kullanıcı';
                }
            } catch (error) {
                console.error("Admin rolü kontrol edilirken hata oluştu:", error);
                document.getElementById('admin-content').classList.add('hidden');
                document.getElementById('access-denied').classList.remove('hidden');
                document.getElementById('grant-role-container').classList.remove('hidden');
                document.getElementById('status-message').textContent = 'Durum: Rol Kontrol Hatası';
            }
        }

        // Buton tıklandığında admin yetkisi veren ve sayfayı yenileyen fonksiyon
        window.grantAdminRole = async function() {
            if (!currentUserId || !db) {
                console.error("Kullanıcı ID veya Firestore hazır değil. Lütfen bekleyin.");
                return;
            }

            const button = document.getElementById('grant-role-btn');
            button.disabled = true;
            button.textContent = 'Yetki Veriliyor...';

            const rolePath = `/artifacts/${appId}/users/${currentUserId}/app_data/admin_role`;
            const roleDocRef = doc(db, rolePath);

            try {
                // isAdmin: true bilgisini Firestore'a kaydet
                await setDoc(roleDocRef, { 
                    isAdmin: true, 
                    grantedAt: new Date().toISOString(),
                    // Kullanıcının rolü yalnızca kendi özel alanına kaydedilir (Güvenlik Kuralı)
                });
                
                // Başarılı olursa kullanıcıya bilgi ver
                document.getElementById('status-message').textContent = 'Yetki başarıyla kaydedildi. Sayfa yenileniyor...';
                
                // HATA BURADAYDI: Yetkiyi verdikten sonra içeriğin değişmesi için sayfayı yenilemeliyiz.
                setTimeout(() => {
                    window.location.reload(); 
                }, 1000); // 1 saniye sonra yenile
                
            } catch (error) {
                console.error("Admin yetkisi verilirken hata oluştu:", error);
                document.getElementById('status-message').textContent = 'Hata: Yetki verilemedi. Konsolu kontrol edin.';
                button.disabled = false;
                button.textContent = 'Kendime Admin Yetkisi Ver';
            }
        };
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white shadow-2xl rounded-xl p-8 w-full max-w-lg">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">Zoetle Güvenlik Kontrolü</h1>
        
        <div id="user-info" class="text-sm text-gray-500 text-center mb-4">Oturum Açılıyor...</div>
        <div id="status-message" class="text-lg font-semibold text-center mb-6 text-orange-600">Durum: Kontrol Ediliyor...</div>

        <!-- 
            ==============================================
            BÖLÜM 1: ERİŞİM ENGELİ (Yetkisiz Kullanıcı İçin)
            ==============================================
        -->
        <div id="access-denied" class="hidden text-center p-6 bg-red-100 border-l-4 border-red-500 rounded-lg">
            <p class="text-xl font-bold text-red-700 mb-2">Erişim Engellendi</p>
            <p class="text-gray-700">Bu içerik yalnızca yetkili sistem yöneticileri tarafından görüntülenebilir.</p>
        </div>

        <!-- 
            ==============================================
            BÖLÜM 2: YETKİ VERME BUTONU (Yetkisiz Kullanıcı İçin Görünür)
            ==============================================
        -->
        <div id="grant-role-container" class="hidden mt-6 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-600 mb-3 text-center">Test Amaçlı: Yetkisizseniz, kendinize admin rolü atayabilirsiniz.</p>
            <button 
                id="grant-role-btn"
                onclick="grantAdminRole()"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md"
            >
                Kendime Admin Yetkisi Ver
            </button>
        </div>

        <!-- 
            ==============================================
            BÖLÜM 3: ADMIN İÇERİĞİ (Yetkili Admin İçin Görünür)
            ==============================================
        -->
        <div id="admin-content" class="hidden mt-8">
            <div class="p-6 bg-green-100 border-l-4 border-green-500 rounded-lg">
                <p class="text-xl font-bold text-green-700 mb-4">Hoş Geldiniz, Yönetici!</p>
                <p class="text-gray-800 font-semibold mb-3">Admin Panel İçeriği:</p>
                
                <ul class="list-disc list-inside space-y-2 text-gray-700 ml-4">
                    <li>Kullanıcı Raporlarını Görüntüle</li>
                    <li>Sistem Ayarlarını Yapılandır</li>
                    <li>Yeni Ürünleri Onayla</li>
                    <li>Sunucu Sağlığını Kontrol Et</li>
                </ul>
                
                <p class="mt-4 text-sm text-green-600">Bu içerik, rolünüz Firestore'da `isAdmin: true` olarak ayarlandığı için görünmektedir.</p>
            </div>
        </div>
    </div>
</body>
</html>
