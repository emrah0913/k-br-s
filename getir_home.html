<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getir Admin - Ürün Yönetimi</title>
    <!-- Tailwind CSS CDN'i -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Getir'e özgü renk paleti (Mor ve Sarı) */
        :root {
            --getir-purple: #4e2e8e;
            --getir-yellow: #ffd93a;
        }
        .text-getir-purple { color: var(--getir-purple); }
        .bg-getir-purple { background-color: var(--getir-purple); }
        .bg-getir-yellow { background-color: var(--getir-yellow); }
        .border-getir-purple { border-color: var(--getir-purple); }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f5fb; /* Açık mor/gri arka plan */
        }
        /* Basit bir dönme animasyonu */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Başlık Alanı -->
    <header class="bg-getir-purple shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white">Getir. Admin Ürünler</h1>
            <!-- Geri Dön Butonu -->
            <a href="index.html" class="px-4 py-2 bg-getir-yellow text-getir-purple font-semibold rounded-full shadow-lg transition duration-200 hover:opacity-90">
                &larr; Ana Sayfaya Dön
            </a>
        </div>
    </header>

    <!-- Ana İçerik Konteyneri -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex flex-col items-center">
        
        <!-- Mesaj Kutusu -->
        <div id="message-box" class="hidden max-w-lg w-full"></div>
        <p id="user-id-display" class="text-sm text-gray-500 mt-2"></p>

        <!-- 1. Yükleniyor Göstergesi -->
        <div id="loading-indicator" class="flex flex-col items-center justify-center p-12 mt-12">
            <svg class="animate-spin-slow h-10 w-10 text-getir-purple" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-getir-purple font-semibold">Yetki Kontrol Ediliyor...</p>
        </div>

        <!-- 2. Erişim Engellendi Mesajı (Admin olmayanlar için) -->
        <div id="access-denied" class="hidden text-center p-12 mt-12 bg-red-50 rounded-xl shadow-lg border border-red-200 max-w-lg w-full">
            <h2 class="text-3xl font-extrabold text-red-600">Erişim Engellendi!</h2>
            <p class="mt-4 text-lg text-gray-700">Bu sayfa yalnızca yönetici (admin) yetkisine sahip kullanıcılar tarafından görüntülenebilir.</p>
        </div>
        
        <!-- Admin Olmayanlar İçin Test İşlemi -->
        <div id="admin-actions" class="hidden text-center p-6 mt-6 bg-yellow-50 rounded-xl border border-yellow-200 max-w-lg w-full">
            <p class="text-sm text-yellow-800 mb-4">
                **SADECE TEST AMAÇLI:** Şu anki kullanıcınızın admin rolü Firestore'da tanımlı değil. Kendinize geçici admin yetkisi vermek için aşağıdaki düğmeyi kullanabilirsiniz.
            </p>
            <button id="grant-admin-btn" class="w-full py-3 bg-getir-yellow text-getir-purple font-bold rounded-lg shadow-md hover:bg-yellow-400 transition">
                Kendime Admin Yetkisi Ver
            </button>
        </div>


        <!-- 3. Admin İçeriği (Admin olanlar için) -->
        <div id="admin-content" class="hidden w-full">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-getir-purple">Ürün Kataloğu (Admin Modu)</h2>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 sm:gap-6">
                <!-- Ürün 1: Süt -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-gray-100">
                    <img src="https://placehold.co/600x400/805ad5/ffffff?text=Süt" alt="[Süt Görseli]" class="w-full h-32 sm:h-40 object-cover">
                    <div class="p-3 sm:p-4 text-center">
                        <p class="text-sm text-gray-500">İçecekler</p>
                        <h3 class="font-bold text-gray-800 mt-1 mb-2 truncate">Taze Günlük Süt (1L)</h3>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-lg font-extrabold text-getir-purple">59,90 TL</span>
                            <button class="w-8 h-8 flex items-center justify-center bg-getir-purple text-white rounded-full text-xl hover:scale-105 transition">
                                +
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ürün 2: Yumurta -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-gray-100">
                    <img src="https://placehold.co/600x400/9e7bbd/ffffff?text=Yumurta" alt="[Yumurta Görseli]" class="w-full h-32 sm:h-40 object-cover">
                    <div class="p-3 sm:p-4 text-center">
                        <p class="text-sm text-gray-500">Kahvaltılık</p>
                        <h3 class="font-bold text-gray-800 mt-1 mb-2 truncate">Organik Köy Yumurtası (10'lu)</h3>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-lg font-extrabold text-getir-purple">84,50 TL</span>
                            <button class="w-8 h-8 flex items-center justify-center bg-getir-purple text-white rounded-full text-xl hover:scale-105 transition">
                                +
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ürün 3: Gazlı İçecek -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-gray-100">
                    <img src="https://placehold.co/600x400/ffd93a/4e2e8e?text=Kola" alt="[Gazlı İçecek Görseli]" class="w-full h-32 sm:h-40 object-cover">
                    <div class="p-3 sm:p-4 text-center">
                        <p class="text-sm text-gray-500">İçecekler</p>
                        <h3 class="font-bold text-gray-800 mt-1 mb-2 truncate">Popüler Gazlı İçecek (330ml)</h3>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-lg font-extrabold text-getir-purple">29,00 TL</span>
                            <button class="w-8 h-8 flex items-center justify-center bg-getir-purple text-white rounded-full text-xl hover:scale-105 transition">
                                +
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Diğer ürün kartları... (Kısaltıldı) -->
                <!-- Ürün 4: Cips -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-gray-100">
                    <img src="https://placehold.co/600x400/4e2e8e/ffd93a?text=Cips" alt="[Cips Görseli]" class="w-full h-32 sm:h-40 object-cover">
                    <div class="p-3 sm:p-4 text-center">
                        <p class="text-sm text-gray-500">Atıştırmalık</p>
                        <h3 class="font-bold text-gray-800 mt-1 mb-2 truncate">Büyük Boy Baharatlı Cips</h3>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-lg font-extrabold text-getir-purple">42,95 TL</span>
                            <button class="w-8 h-8 flex items-center justify-center bg-getir-purple text-white rounded-full text-xl hover:scale-105 transition">
                                +
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-12 p-6 text-center text-sm text-gray-600 border-t border-gray-200">
        <p>Getir - Her şey birkaç dakikada kapınızda.</p>
    </footer>

    <!-- Firebase Scriptleri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Gerekli Global Değişkenleri Al
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Başarılı veya hatalı mesajları gösterir.
         * @param {string} message Görüntülenecek mesaj.
         * @param {'success'|'error'} type Mesaj tipi.
         */
        function alertMessage(message, type) {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = 'p-3 rounded-lg font-semibold text-center mt-4 max-w-lg mx-auto w-full';
            if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-800');
            }
            box.classList.remove('hidden');
        }

        /**
         * Kullanıcının admin yetkisini Firestore'da kontrol eder.
         */
        async function initializeFirebaseAndCheckAdmin() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const adminContent = document.getElementById('admin-content');
            const accessDenied = document.getElementById('access-denied');
            const adminActions = document.getElementById('admin-actions');
            const userIdDisplay = document.getElementById('user-id-display');
            
            loadingIndicator.classList.remove('hidden');

            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                setLogLevel('Debug'); // Debug loglarını etkinleştir

                let userId;

                // 1. Kimlik Doğrulama
                await setPersistence(auth, browserSessionPersistence);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || 'Anonim Kullanıcı';
                userIdDisplay.textContent = `Kullanıcı ID: ${userId}`;

                // 2. Admin Rolünü Kontrol Etme
                // Özel kullanıcı verisi yolunu kullanıyoruz: /artifacts/{appId}/users/{userId}/app_data/admin_role
                const roleDocRef = doc(db, `artifacts/${appId}/users/${userId}/app_data/admin_role`);
                const roleDocSnap = await getDoc(roleDocRef);
                
                let isAdmin = false;

                if (roleDocSnap.exists()) {
                    const data = roleDocSnap.data();
                    if (data.isAdmin === true) {
                        isAdmin = true;
                    }
                }

                // 3. İçeriği Render Etme
                if (isAdmin) {
                    loadingIndicator.classList.add('hidden');
                    adminContent.classList.remove('hidden');
                    console.log("Admin yetkisi onaylandı. Ürünler yükleniyor.");
                } else {
                    loadingIndicator.classList.add('hidden');
                    accessDenied.classList.remove('hidden');
                    adminActions.classList.remove('hidden'); // Admin yetkisi verme butonunu göster

                    document.getElementById('grant-admin-btn').addEventListener('click', () => grantAdmin(db, userId, roleDocRef));
                    console.warn(`Admin yetkisi bulunamadı. Kullanıcı ID: ${userId}`);
                }

            } catch (error) {
                console.error("Yetki kontrol edilirken hata oluştu:", error);
                loadingIndicator.classList.add('hidden');
                accessDenied.classList.remove('hidden');
                document.getElementById('access-denied').innerHTML = `<h2 class="text-3xl font-extrabold text-red-600">Hata!</h2><p class="mt-2 text-red-500">Sistem hatası nedeniyle yetki kontrol edilemedi. Konsolu kontrol edin.</p><p class="mt-4 text-sm text-gray-500">App ID: ${appId}</p>`;
                adminActions.classList.add('hidden');
            }
        }

        /**
         * Mevcut kullanıcıya admin yetkisi verir (yalnızca test için).
         * @param {Firestore} db Firestore instance.
         * @param {string} userId Kullanıcı ID'si.
         * @param {DocumentReference} roleDocRef Rol belgesine referans.
         */
        async function grantAdmin(db, userId, roleDocRef) {
            try {
                // isAdmin: true ile belgeyi oluştur/güncelle
                await setDoc(roleDocRef, { 
                    isAdmin: true, 
                    grantedAt: new Date().toISOString(),
                    userId: userId
                });
                alertMessage("Admin Yetkisi Başarıyla Verildi! Sayfa Yenileniyor...", 'success');
                // Sayfayı yenileyerek yetki kontrolünü tekrar çalıştır
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                console.error("Admin yetkisi verilirken hata oluştu:", error);
                alertMessage("Yetki verme hatası: " + error.message, 'error');
            }
        }

        window.onload = initializeFirebaseAndCheckAdmin;
    </script>
</body>
</html>
