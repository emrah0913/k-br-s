<!-- ... (önceki kodlarınız değişmeden kalır) ... -->
<div id="calculator-section" class="bg-white rounded-lg shadow-md mx-4 p-4 mb-8">
  <h3 class="text-lg font-semibold mb-4 text-primary">Sipariş Modülü</h3>
  <form id="calculator-form" class="space-y-4">
    <!-- ... (form alanlarınız değişmeden kalır) ... -->

    <!-- ESKİ SUBMIT BUTTON KALDIRILDI 
    <button type="submit" class="w-full bg-primary text-white py-3 rounded-button font-medium hover:bg-primary/90 transition-colors cursor-pointer !rounded-button">
      Siparişi Onayla
    </button>
    -->

    <!-- YENİ: JS ile eklenecek buton için placeholder -->
    <div id="two-step-btn-wrapper"></div>
  </form>
  <div id="calculation-result" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
    <!-- ... (diğer içerikler aynı kalır) ... -->
  </div>
  <!-- YENİ: Sipariş başarı mesajı kutusu -->
  <div id="order-success-message" class="hidden mt-6 px-4 py-3 rounded-lg bg-green-100 text-green-800 flex items-center gap-2 text-sm font-medium border border-green-200">
    <span class="text-xl">✔️</span>
    <span>Siparişiniz onaylandı!</span>
  </div>
</div>
<!-- ... (sonraki kodlarınız değişmeden kalır) ... -->

<script id="calculator-script">
document.addEventListener('DOMContentLoaded', function() {
const calculatorSection = document.getElementById('calculator-section');
const calculatorForm = document.getElementById('calculator-form');
const citySelection = document.getElementById('city-selection');
const deliveryRadios = document.querySelectorAll('input[name="delivery-type"]');
const calculationResult = document.getElementById('calculation-result');
const resultCityRow = document.getElementById('result-city-row');
const orderMethod = document.getElementById('order-method');
const orderCodeInput = document.getElementById('order-code-input');
const citySelect = document.getElementById('city');
const deliveryAddressInput = document.getElementById('delivery-address-input');
const twoStepBtnWrapper = document.getElementById('two-step-btn-wrapper');
const orderSuccessMessage = document.getElementById('order-success-message');
let step = 1;

citySelect.addEventListener('change', function() {
if (this.value) {
deliveryAddressInput.classList.remove('hidden');
} else {
deliveryAddressInput.classList.add('hidden');
}
});
orderMethod.addEventListener('change', function() {
if (this.value === 'self') {
orderCodeInput.classList.remove('hidden');
} else {
orderCodeInput.classList.add('hidden');
}
});

// Toggle calculator section
window.toggleCalculatorSection = function() {
calculatorSection.classList.toggle('hidden');
if (!calculatorSection.classList.contains('hidden')) {
calculatorSection.scrollIntoView({ behavior: 'smooth' });
}
};
// Handle delivery type change
function handleDeliveryTypeChange(radio) {
document.querySelectorAll('.delivery-radio div').forEach(dot => {
dot.classList.add('hidden');
});
radio.parentElement.querySelector('.delivery-radio div').classList.remove('hidden');
if (radio.value === 'home') {
citySelection.classList.remove('hidden');
} else {
citySelection.classList.add('hidden');
}
}
deliveryRadios.forEach(radio => {
radio.addEventListener('change', function() {
handleDeliveryTypeChange(this);
});
const customRadio = radio.parentElement.querySelector('.delivery-radio');
customRadio.addEventListener('click', function() {
radio.checked = true;
handleDeliveryTypeChange(radio);
});
});
const defaultRadio = document.querySelector('input[name="delivery-type"]:checked');
if (defaultRadio) {
handleDeliveryTypeChange(defaultRadio);
}

// İKİ AŞAMALI BUTON KURULUMU
function renderTwoStepButton() {
  twoStepBtnWrapper.innerHTML = '';
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'w-full bg-primary text-white py-3 rounded-button font-medium hover:bg-primary/90 transition-colors cursor-pointer !rounded-button';
  btn.textContent = step === 1 ? 'Hesapla' : 'Siparişi Onayla';
  btn.id = 'two-step-action-btn';
  twoStepBtnWrapper.appendChild(btn);
}
renderTwoStepButton();

// Sonuç kutusu ve başarı mesajı sıfırlama
function resetStates() {
  calculationResult.classList.add('hidden');
  orderSuccessMessage.classList.add('hidden');
}

// İKİ AŞAMALI BUTON TIKLAMA
twoStepBtnWrapper.addEventListener('click', async function(e) {
  // Sadece butona tıklama
  if (!e.target || e.target.id !== 'two-step-action-btn') return;
  e.preventDefault();

  if (step === 1) {
    // Adım 1: Hesapla
    resetStates();
    // Hesaplama için formdan değerleri çek
    const orderMethodVal = document.getElementById('order-method').value;
    const fullName = document.getElementById('full-name').value;
    const phone = document.getElementById('phone').value;
    const price = parseFloat(document.getElementById('product-price').value) || 0;
    const orderCode = document.getElementById('order-code').value;
    const productLink = document.getElementById('product-link').value;
    const category = document.getElementById('product-category').value;
    const deliveryType = document.querySelector('input[name="delivery-type"]:checked').value;
    const city = document.getElementById('city').value;
    const deliveryAddress = document.getElementById('delivery-address') ? document.getElementById('delivery-address').value : '';

    if (!fullName.trim()) {
      showToast('Lütfen ad soyad girin');
      return;
    }
    if (orderMethodVal === 'self' && !orderCode.trim()) {
      showToast('Lütfen sipariş kodunu girin');
      return;
    }
    if (!phone.trim()) {
      showToast('Lütfen telefon numarası girin');
      return;
    }
    // Simple phone number validation
    const phoneRegex = /^[0-9\s]{10,15}$/;
    if (!phoneRegex.test(phone.replace(/\D/g, ''))) {
      showToast('Lütfen geçerli bir telefon numarası girin');
      return;
    }
    if (!orderMethodVal) {
      showToast('Lütfen sipariş yöntemi seçin');
      return;
    }
    if (price <= 0) {
      showToast('Lütfen geçerli bir fiyat girin');
      return;
    }
    if (!category) {
      showToast('Lütfen bir kategori seçin');
      return;
    }
    // Calculate costs
    const categoryRates = {
      'furniture': 0.70,
      'electronics': 0.70,
      'clothing': 0.45,
      'cosmetics': 0.70,
      'stationery': 0.40
    };
    const categoryFee = price * categoryRates[category];
    let deliveryFee = 0;
    if (deliveryType === 'home') {
      deliveryFee = 200; // Fixed delivery fee
    }
    const total = price + categoryFee + deliveryFee;
    // Update result
    document.getElementById('result-price').textContent = `${price.toFixed(2)} ₺`;
    document.getElementById('result-category-fee').textContent = `${categoryFee.toFixed(2)} ₺`;
    document.getElementById('result-delivery-fee').textContent = `${deliveryFee.toFixed(2)} ₺`;
    document.getElementById('result-total').textContent = `${total.toFixed(2)} ₺`;
    // Show/hide city fee row
    if (deliveryType === 'home') {
      resultCityRow.classList.remove('hidden');
    } else {
      resultCityRow.classList.add('hidden');
    }
    calculationResult.classList.remove('hidden');
    calculationResult.scrollIntoView({ behavior: 'smooth' });
    step = 2;
    renderTwoStepButton();
  } else if (step === 2) {
    // Adım 2: Sipariş Onayla (kaydedecek)
    // Formdan değerleri çek
    const orderMethodVal = document.getElementById('order-method').value;
    const fullName = document.getElementById('full-name').value;
    const phone = document.getElementById('phone').value;
    const price = parseFloat(document.getElementById('product-price').value) || 0;
    const orderCode = document.getElementById('order-code').value;
    const productLink = document.getElementById('product-link').value;
    const category = document.getElementById('product-category').value;
    const deliveryType = document.querySelector('input[name="delivery-type"]:checked').value;
    const city = document.getElementById('city').value;
    const deliveryAddress = document.getElementById('delivery-address') ? document.getElementById('delivery-address').value : '';
    const categoryRates = {
      'furniture': 0.70,
      'electronics': 0.70,
      'clothing': 0.45,
      'cosmetics': 0.70,
      'stationery': 0.40
    };
    const categoryFee = price * categoryRates[category];
    let deliveryFee = 0;
    if (deliveryType === 'home') {
      deliveryFee = 200;
    }
    const total = price + categoryFee + deliveryFee;
    // --- FIREBASE: Save order to Firestore ---
    if (typeof firebase !== "undefined" && firebase.firestore) {
      try {
        await db.collection('orders').add({
          fullName,
          phone,
          productLink,
          productPrice: price,
          orderMethod: orderMethodVal,
          orderCode: orderMethodVal === 'self' ? orderCode : '',
          category,
          categoryFee,
          deliveryType,
          city: deliveryType === 'home' ? city : '',
          deliveryAddress: deliveryType === 'home' ? deliveryAddress : '',
          deliveryFee,
          total,
          createdAt: new Date(),
          user: firebase.auth().currentUser ? firebase.auth().currentUser.uid : null
        });
        // Başarı mesajı göster
        orderSuccessMessage.classList.remove('hidden');
        orderSuccessMessage.scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        showToast("Sipariş kaydedilemedi: " + (err.message || "Bilinmeyen hata"));
        return;
      }
    }
    step = 1;
    renderTwoStepButton();
  }
});

// Form reset veya yeni girişte step ve butonu sıfırla
calculatorForm.addEventListener('input', function() {
  if (step !== 1) {
    step = 1;
    renderTwoStepButton();
    resetStates();
  }
});
});
</script>
<!-- ... (diğer scriptler ve sayfa değişmeden devam eder) ... -->
