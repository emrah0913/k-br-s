<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sipariş Ver - Getir Kıbrıs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#5d3ebc',
            secondary: '#ffd300',
          },
          borderRadius: {
            'button': '8px',
          },
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; background: #f9f9f9; }
    .copy-btn:active { transform: scale(0.97); }
  </style>
</head>
<body class="bg-gray-50">
<div class="w-full max-w-md mx-auto min-h-screen pb-16 relative">
  <!-- Header -->
  <header class="fixed top-0 w-full max-w-md mx-auto bg-white shadow-sm z-50 px-4 py-3 flex justify-between items-center">
    <div class="w-8"></div>
    <div class="flex flex-col items-center">
      <img src="https://getirkibris.com/logo.png" alt="Getir Kıbrıs" class="h-12">
      <span class="text-primary font-medium text-xs mt-1">Sipariş Ver</span>
    </div>
    <div id="auth-buttons" class="w-8 h-8 flex items-center justify-center">
      <button id="loginBtn" class="text-xs text-primary font-medium cursor-pointer" title="Google ile Giriş">
        <i class="ri-google-fill ri-lg"></i>
      </button>
      <div id="profileContainer" class="hidden">
        <img id="profileImg" src="" alt="Profil" class="w-8 h-8 rounded-full cursor-pointer border border-primary">
      </div>
      <button id="logoutBtn" class="hidden text-xs text-red-600 ml-2" title="Çıkış Yap">
        <i class="ri-logout-box-line ri-lg"></i>
      </button>
    </div>
  </header>

  <main class="pt-24 pb-10">
    <!-- Navigation -->
    <div class="grid grid-cols-2 gap-4 px-4 mb-8">
      <button onclick="goPageOrWarn('index.html')" class="bg-white shadow p-4 rounded-button flex flex-col items-center justify-center h-28 border border-gray-100 hover:border-primary/30 transition-all">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mb-2">
          <i class="ri-home-line ri-xl text-primary"></i>
        </div>
        <span class="text-sm font-medium">Ana Sayfa</span>
      </button>
      <button onclick="scrollToCalc()" class="bg-white shadow p-4 rounded-button flex flex-col items-center justify-center h-28 border border-gray-100 hover:border-primary/30 transition-all">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mb-2">
          <i class="ri-calculator-line ri-xl text-primary"></i>
        </div>
        <span class="text-sm font-medium">Hesapla</span>
      </button>
      <button onclick="goPageOrWarn('siparislerim.html')" class="bg-white shadow p-4 rounded-button flex flex-col items-center justify-center h-28 border border-gray-100 hover:border-primary/30 transition-all">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mb-2">
          <i class="ri-file-list-3-line ri-xl text-primary"></i>
        </div>
        <span class="text-sm font-medium">Siparişlerim</span>
      </button>
      <button onclick="goPageOrWarn('kargotakip.html')" class="bg-white shadow p-4 rounded-button flex flex-col items-center justify-center h-28 border border-gray-100 hover:border-primary/30 transition-all">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mb-2">
          <i class="ri-truck-line ri-xl text-primary"></i>
        </div>
        <span class="text-sm font-medium">Kargo Takip</span>
      </button>
    </div>

    <!-- Order & Calculator Form -->
    <section class="bg-white rounded-lg shadow-md mx-4 p-4 mb-8" id="calcFormSection">
      <h3 class="text-lg font-semibold mb-4 text-primary text-center">Sipariş ve Hesaplama Modülü</h3>
      <form id="calcForm" autocomplete="off" class="space-y-4">
        <div>
          <label for="adSoyad" class="block text-sm font-medium text-gray-700 mb-1">Ad Soyad</label>
          <div class="relative">
            <i class="ri-user-line ri-lg absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="adSoyad" class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-button focus:outline-none focus:border-primary" placeholder="Ad Soyad" required>
          </div>
        </div>
        <div>
          <label for="telefon" class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
          <div class="relative">
            <i class="ri-phone-line ri-lg absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="tel" id="telefon" class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-button focus:outline-none focus:border-primary" placeholder="Telefon" required>
          </div>
        </div>
        <div>
          <label for="urunLinki" class="block text-sm font-medium text-gray-700 mb-1">Ürün Linki</label>
          <div class="relative">
            <i class="ri-link ri-lg absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="url" id="urunLinki" class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-button focus:outline-none focus:border-primary" placeholder="https://www.trendyol.com/..." required>
          </div>
        </div>
        <div>
          <label for="siparisKodu" class="block text-sm font-medium text-gray-700 mb-1">Sipariş Kodu</label>
          <div class="relative">
            <i class="ri-barcode-line ri-lg absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="siparisKodu" class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-button focus:outline-none focus:border-primary" placeholder="Sipariş kodu" required>
          </div>
        </div>
        <div>
          <label for="urunFiyati" class="block text-sm font-medium text-gray-700 mb-1">Ürün Fiyatı (TL)</label>
          <div class="relative">
            <i class="ri-money-lira-circle-line ri-lg absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="number" id="urunFiyati" min="1" class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-button focus:outline-none focus:border-primary" placeholder="örn: 1000" required>
          </div>
        </div>
        <div>
          <label for="kategori" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
          <div class="relative">
            <i class="ri-price-tag-3-line ri-lg absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <select id="kategori" class="w-full pl-10 pr-10 py-2 border border-gray-200 rounded-button focus:outline-none focus:border-primary appearance-none bg-white text-sm" required>
              <option value="">Seçiniz</option>
              <option value="Mobilya">Mobilya</option>
              <option value="Giyim">Giyim</option>
              <option value="Elektronik">Elektronik</option>
              <option value="Kırtasiye">Kırtasiye</option>
              <option value="Kozmetik">Kozmetik</option>
            </select>
            <i class="ri-arrow-down-s-line ri-lg absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
          </div>
        </div>
        <div>
          <span class="block text-sm font-medium text-gray-700 mb-2">Teslimat Tipi</span>
          <div class="flex space-x-4">
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="teslimatTipi" value="Depodan Teslim" class="sr-only" checked>
              <div class="w-5 h-5 border border-gray-300 rounded-full flex items-center justify-center mr-2 bg-white">
                <div class="w-3 h-3 bg-primary rounded-full hidden"></div>
              </div>
              <span class="text-sm">Depodan Teslim</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="teslimatTipi" value="Eve Teslim" class="sr-only">
              <div class="w-5 h-5 border border-gray-300 rounded-full flex items-center justify-center mr-2 bg-white">
                <div class="w-3 h-3 bg-primary rounded-full hidden"></div>
              </div>
              <span class="text-sm">Eve Teslim</span>
            </label>
          </div>
        </div>
        <!-- Şehir ve Adres -->
        <div id="adresRow" class="hidden">
          <label for="adresSecimi" class="block text-sm font-medium text-gray-700 mb-1">Teslimat Adresi (Şehir)</label>
          <div class="relative">
            <i class="ri-building-line ri-lg absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <select id="adresSecimi" class="w-full pl-10 pr-10 py-2 border border-gray-200 rounded-button focus:outline-none focus:border-primary bg-white text-sm">
              <option value="">Şehir Seçiniz</option>
              <option value="Mağusa">Mağusa</option>
              <option value="Lefkoşa">Lefkoşa</option>
              <option value="Girne">Girne</option>
              <option value="İskele">İskele</option>
              <option value="Güzelyurt">Güzelyurt</option>
              <option value="Lefke">Lefke</option>
              <option value="Karpaz">Karpaz</option>
            </select>
            <i class="ri-arrow-down-s-line ri-lg absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
          </div>
          <div id="acikAdresRow" class="hidden mt-3">
            <label for="acikAdres" class="block text-sm font-medium text-gray-700 mb-1">Açık Teslimat Adresi</label>
            <div class="relative">
              <i class="ri-map-pin-line ri-lg absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input type="text" id="acikAdres" class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-button focus:outline-none focus:border-primary" placeholder="Açık adresinizi giriniz">
            </div>
          </div>
        </div>
        <!-- Hesapla/Onayla -->
        <div class="flex gap-2 mt-2">
          <button type="button" class="bg-primary text-white py-2 px-4 rounded-button font-medium flex-1 hover:bg-primary/90 transition-colors" id="hesaplaBtn">Hesapla</button>
          <button type="button" class="bg-green-600 text-white py-2 px-4 rounded-button font-medium flex-1 hover:bg-green-700 transition-colors hidden" id="onaylaBtn">Onayla</button>
        </div>
        <!-- Sonuç ve Bilgilendirme -->
        <div id="resultInfo" class="mt-4 p-3 bg-blue-50 rounded text-blue-600 font-semibold text-center hidden"></div>
        <div id="successInfo" class="mt-4 p-3 bg-green-50 rounded text-green-700 font-semibold text-center hidden"></div>
        <div id="errorInfo" class="mt-4 p-3 bg-red-50 rounded text-red-600 font-semibold text-center hidden"></div>
      </form>
    </section>
  </main>
</div>
<script>
  // FIREBASE CONFIG (Senin config'in)
  const firebaseConfig = {
    apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
    authDomain: "kibris-6b4f7.firebaseapp.com",
    projectId: "kibris-6b4f7",
    storageBucket: "kibris-6b4f7.firebasestorage.app",
    messagingSenderId: "141262926171",
    appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
    measurementId: "G-JL9P6BRZTD"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // UI Elements
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const profileImg = document.getElementById('profileImg');
  const profileContainer = document.getElementById('profileContainer');
  const hesaplaBtn = document.getElementById('hesaplaBtn');
  const onaylaBtn = document.getElementById('onaylaBtn');
  const calcForm = document.getElementById('calcForm');
  const resultInfo = document.getElementById('resultInfo');
  const successInfo = document.getElementById('successInfo');
  const errorInfo = document.getElementById('errorInfo');
  let user = null, toplamTutar = null;

  // Giriş kontrolü: Sayfa sadece giriş yapanlara açık (Sipariş onaylamak için)
  auth.onAuthStateChanged(function(currentUser) {
    user = currentUser;
    updateAuthUI(currentUser);
  });

  function updateAuthUI(currentUser) {
    user = currentUser;
    if (user) {
      loginBtn.classList.add('hidden');
      profileContainer.classList.remove('hidden');
      profileImg.src = user.photoURL || '';
      profileImg.alt = user.displayName || '';
      logoutBtn.classList.remove('hidden');
    } else {
      loginBtn.classList.remove('hidden');
      profileContainer.classList.add('hidden');
      logoutBtn.classList.add('hidden');
    }
  }

  loginBtn.onclick = function() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e=>alert('Giriş başarısız! '+e.message));
  };
  logoutBtn.onclick = function() {
    auth.signOut().then(()=>location.reload());
  };
  profileContainer.onclick = function() {
    if (confirm('Çıkış yapmak istediğinize emin misiniz?')) {
      auth.signOut().then(()=>location.reload());
    }
  };

  // Navigasyon ve erişim
  function goPageOrWarn(page) {
    if (user) {
      window.location.href = page;
    } else {
      showError("Lütfen giriş yapınız.");
    }
  }
  function scrollToCalc() {
    document.getElementById('calcFormSection').scrollIntoView({behavior: 'smooth'});
  }

  // Teslimat tipi radio UI ve şehir/adres gösterimi
  function updateTeslimatUI() {
    const radios = document.querySelectorAll('input[name="teslimatTipi"]');
    let selected = 'Depodan Teslim';
    radios.forEach(radio => {
      const dot = radio.parentElement.querySelector('div div');
      if (radio.checked) {
        dot.classList.remove('hidden');
        selected = radio.value;
      } else {
        dot.classList.add('hidden');
      }
    });
    document.getElementById('adresRow').classList.toggle('hidden', selected !== 'Eve Teslim');
    if(selected !== 'Eve Teslim') {
      document.getElementById('adresSecimi').value = '';
      document.getElementById('acikAdres').value = '';
      document.getElementById('acikAdresRow').classList.add('hidden');
    }
  }
  document.querySelectorAll('input[name="teslimatTipi"]').forEach(radio => {
    radio.addEventListener('change', updateTeslimatUI);
    // Custom radio click
    const customRadio = radio.parentElement.querySelector('div');
    customRadio.addEventListener('click', () => {
      radio.checked = true;
      updateTeslimatUI();
    });
  });
  updateTeslimatUI();

  document.getElementById('adresSecimi').addEventListener('change', function() {
    document.getElementById('acikAdresRow').classList.toggle('hidden', !this.value);
    if (!this.value) document.getElementById('acikAdres').value = '';
  });

  // Hesaplama kuralları
  const kategoriYuzdeleri = {
    'Mobilya': 0.7,
    'Giyim': 0.45,
    'Elektronik': 0.7,
    'Kırtasiye': 0.4,
    'Kozmetik': 0.7
  };
  const kargoUcretleri = {
    'Mağusa': 500,
    'Lefkoşa': 200,
    'Girne': 350,
    'İskele': 550,
    'Güzelyurt': 350,
    'Lefke': 450,
    'Karpaz': 750
  };

  function showError(msg) {
    errorInfo.textContent = msg;
    errorInfo.classList.remove('hidden');
    successInfo.classList.add('hidden');
    resultInfo.classList.add('hidden');
    setTimeout(() => errorInfo.classList.add('hidden'), 3000);
  }
  function showSuccess(msg) {
    successInfo.textContent = msg;
    successInfo.classList.remove('hidden');
    errorInfo.classList.add('hidden');
    resultInfo.classList.add('hidden');
  }
  function showResult(msg) {
    resultInfo.innerHTML = msg;
    resultInfo.classList.remove('hidden');
    errorInfo.classList.add('hidden');
    successInfo.classList.add('hidden');
  }

  // Hesapla
  hesaplaBtn.onclick = function() {
    const adSoyad = document.getElementById('adSoyad').value.trim();
    const telefon = document.getElementById('telefon').value.trim();
    const link = document.getElementById('urunLinki').value.trim();
    const siparisKodu = document.getElementById('siparisKodu').value.trim();
    const fiyat = parseFloat(document.getElementById('urunFiyati').value.trim());
    const kategori = document.getElementById('kategori').value;
    const teslimat = document.querySelector('input[name="teslimatTipi"]:checked').value;
    const sehir = document.getElementById('adresSecimi').value;
    const acikAdres = document.getElementById('acikAdres').value.trim();

    errorInfo.classList.add('hidden');
    successInfo.classList.add('hidden');

    if (!adSoyad || !telefon) return showError("Lütfen ad soyad ve telefon bilgilerinizi giriniz.");
    if (!link || !fiyat || !kategori || !teslimat || !siparisKodu) return showError("Lütfen tüm alanları doldurunuz.");
    if (teslimat === 'Eve Teslim' && !sehir) return showError("Teslimat şehrini seçiniz.");
    if (teslimat === 'Eve Teslim' && sehir && !acikAdres) return showError("Teslimat adresinizi giriniz.");

    let ekYuzde = kategoriYuzdeleri[kategori] || 0;
    let araFiyat = fiyat + (fiyat * ekYuzde);
    let kargo = 0;
    if (teslimat === 'Eve Teslim') {
      kargo = kargoUcretleri[sehir] || 0;
    }
    toplamTutar = Math.round(araFiyat + kargo);

    showResult(`Toplam Tutar: <b>${toplamTutar} TL</b> <br> 
      (${kategori} için +%${(ekYuzde*100).toFixed(0)}, 
      ${teslimat === 'Eve Teslim' ? sehir+' '+kargo+' TL kargo dahil' : 'kargo ücreti yok'})`);
    onaylaBtn.classList.remove('hidden');
  };

  // Onayla
  onaylaBtn.onclick = async function() {
    if (!user) return showError("Sipariş vermek için giriş yapmanız gereklidir.");
    const adSoyad = document.getElementById('adSoyad').value.trim();
    const telefon = document.getElementById('telefon').value.trim();
    const link = document.getElementById('urunLinki').value.trim();
    const siparisKodu = document.getElementById('siparisKodu').value.trim();
    const fiyat = parseFloat(document.getElementById('urunFiyati').value.trim());
    const kategori = document.getElementById('kategori').value;
    const teslimat = document.querySelector('input[name="teslimatTipi"]:checked').value;
    const sehir = document.getElementById('adresSecimi').value;
    const acikAdres = document.getElementById('acikAdres').value.trim();

    if (!adSoyad || !telefon) return showError("Lütfen ad soyad ve telefon bilgilerinizi giriniz.");
    if (!link || !fiyat || !kategori || !teslimat || !siparisKodu) return showError("Lütfen tüm alanları doldurunuz.");
    if (teslimat === 'Eve Teslim' && (!sehir || !acikAdres)) return showError("Teslimat şehri ve açık adres gerekli.");
    if (toplamTutar === null) return showError("Lütfen önce Hesapla butonuna basınız.");

    onaylaBtn.disabled = true;
    try {
      await db.collection("siparisler").add({
        uid: user.uid,
        email: user.email,
        adSoyad: adSoyad,
        telefon: telefon,
        urunLinki: link,
        siparisKodu: siparisKodu,
        urunFiyati: fiyat,
        kategori,
        teslimatTipi: teslimat,
        sehir: teslimat === 'Eve Teslim' ? sehir : "",
        acikAdres: teslimat === 'Eve Teslim' ? acikAdres : "",
        toplamTutar,
        createdAt: new Date()
      });
      showSuccess("Siparişiniz başarıyla kaydedildi!");
      setTimeout(() => window.location.href = "siparislerim.html", 1300);
      calcForm.reset();
      document.getElementById('adresRow').classList.add('hidden');
      document.getElementById('acikAdresRow').classList.add('hidden');
      toplamTutar = null;
      onaylaBtn.classList.add('hidden');
    } catch (e) {
      showError("Bir hata oluştu, lütfen tekrar deneyin.");
    }
    onaylaBtn.disabled = false;
  };

  // Form sıfırlama
  Array.from(calcForm.elements).forEach(el => {
    el.addEventListener('input', function() {
      errorInfo.classList.add('hidden');
      successInfo.classList.add('hidden');
      onaylaBtn.classList.add('hidden');
      resultInfo.classList.add('hidden');
      toplamTutar = null;
    });
  });
</script>
</body>
</html>
