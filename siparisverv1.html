<!-- ... ön kısmı ve tüm görsel yapı aynı ... -->
<script id="calculator-script">
document.addEventListener('DOMContentLoaded', function() {
const calculatorSection = document.getElementById('calculator-section');
const calculatorForm = document.getElementById('calculator-form');
const citySelection = document.getElementById('city-selection');
const deliveryRadios = document.querySelectorAll('input[name="delivery-type"]');
const calculationResult = document.getElementById('calculation-result');
const resultCityRow = document.getElementById('result-city-row');
const orderMethod = document.getElementById('order-method');
const orderCodeInput = document.getElementById('order-code-input');
const citySelect = document.getElementById('city');
const deliveryAddressInput = document.getElementById('delivery-address-input');

// Onay mesajı elementi ekle
let approvalMsg = document.createElement("div");
approvalMsg.id = "order-approval-message";
approvalMsg.className = "hidden mt-4 text-center";
calculatorForm.parentElement.insertBefore(approvalMsg, calculatorForm.nextSibling);

let calculationState = "calculate";
let lastOrderData = null;

citySelect.addEventListener('change', function() {
    if (this.value) {
        deliveryAddressInput.classList.remove('hidden');
    } else {
        deliveryAddressInput.classList.add('hidden');
    }
});
orderMethod.addEventListener('change', function() {
    if (this.value === 'self') {
        orderCodeInput.classList.remove('hidden');
    } else {
        orderCodeInput.classList.add('hidden');
    }
});
window.toggleCalculatorSection = function() {
    calculatorSection.classList.toggle('hidden');
    if (!calculatorSection.classList.contains('hidden')) {
        calculatorSection.scrollIntoView({ behavior: 'smooth' });
    }
};
function handleDeliveryTypeChange(radio) {
    document.querySelectorAll('.delivery-radio div').forEach(dot => {
        dot.classList.add('hidden');
    });
    radio.parentElement.querySelector('.delivery-radio div').classList.remove('hidden');
    if (radio.value === 'home') {
        citySelection.classList.remove('hidden');
    } else {
        citySelection.classList.add('hidden');
    }
}
deliveryRadios.forEach(radio => {
    radio.addEventListener('change', function() {
        handleDeliveryTypeChange(this);
    });
    const customRadio = radio.parentElement.querySelector('.delivery-radio');
    customRadio.addEventListener('click', function() {
        radio.checked = true;
        handleDeliveryTypeChange(radio);
    });
});
const defaultRadio = document.querySelector('input[name="delivery-type"]:checked');
if (defaultRadio) {
    handleDeliveryTypeChange(defaultRadio);
}

const calculateOrOrderBtn = document.createElement('button');
calculateOrOrderBtn.type = "button";
calculateOrOrderBtn.id = "calculate-or-order-btn";
calculateOrOrderBtn.className = "w-full bg-primary text-white py-3 rounded-button font-medium hover:bg-primary/90 transition-colors cursor-pointer !rounded-button";
calculateOrOrderBtn.textContent = "Hesapla";

// Eski submit butonunu değiştir
const oldSubmitBtn = calculatorForm.querySelector('button[type="submit"]');
if (oldSubmitBtn) {
    oldSubmitBtn.parentNode.replaceChild(calculateOrOrderBtn, oldSubmitBtn);
}

calculateOrOrderBtn.addEventListener('click', function() {
    // Onay mesajını gizle
    approvalMsg.classList.add("hidden");
    approvalMsg.innerHTML = "";

    if (calculationState === "calculate") {
        const orderMethodVal = document.getElementById('order-method').value;
        const fullName = document.getElementById('full-name').value;
        const phone = document.getElementById('phone').value;
        const price = parseFloat(document.getElementById('product-price').value) || 0;
        const orderCode = document.getElementById('order-code') ? document.getElementById('order-code').value : '';
        const productLink = document.getElementById('product-link').value;
        const category = document.getElementById('product-category').value;
        const deliveryType = document.querySelector('input[name="delivery-type"]:checked').value;
        const city = document.getElementById('city') ? document.getElementById('city').value : '';
        const deliveryAddress = document.getElementById('delivery-address') ? document.getElementById('delivery-address').value : '';
        if (!fullName.trim()) { showToast('Lütfen ad soyad girin'); return; }
        if (orderMethodVal === 'self' && !orderCode.trim()) { showToast('Lütfen sipariş kodunu girin'); return; }
        if (!phone.trim()) { showToast('Lütfen telefon numarası girin'); return; }
        const phoneRegex = /^[0-9\s]{10,15}$/;
        if (!phoneRegex.test(phone.replace(/\D/g, ''))) { showToast('Lütfen geçerli bir telefon numarası girin'); return; }
        if (!orderMethodVal) { showToast('Lütfen sipariş yöntemi seçin'); return; }
        if (price <= 0) { showToast('Lütfen geçerli bir fiyat girin'); return; }
        if (!category) { showToast('Lütfen bir kategori seçin'); return; }
        const categoryRates = {
            'furniture': 0.70,
            'electronics': 0.70,
            'clothing': 0.45,
            'cosmetics': 0.70,
            'stationery': 0.40
        };
        const categoryFee = price * categoryRates[category];
        let deliveryFee = 0;
        if (deliveryType === 'home') {
            deliveryFee = 200;
        }
        const total = price + categoryFee + deliveryFee;
        document.getElementById('result-price').textContent = `${price.toFixed(2)} ₺`;
        document.getElementById('result-category-fee').textContent = `${categoryFee.toFixed(2)} ₺`;
        document.getElementById('result-delivery-fee').textContent = `${deliveryFee.toFixed(2)} ₺`;
        document.getElementById('result-total').textContent = `${total.toFixed(2)} ₺`;
        if (deliveryType === 'home') {
            resultCityRow.classList.remove('hidden');
        } else {
            resultCityRow.classList.add('hidden');
        }
        calculationResult.classList.remove('hidden');
        calculationResult.scrollIntoView({ behavior: 'smooth' });

        lastOrderData = {
            fullName,
            phone,
            productLink,
            productPrice: price,
            orderMethod: orderMethodVal,
            orderCode: orderMethodVal === 'self' ? orderCode : '',
            category,
            categoryFee,
            deliveryType,
            city: deliveryType === 'home' ? city : '',
            deliveryAddress: deliveryType === 'home' ? deliveryAddress : '',
            deliveryFee,
            total,
            createdAt: new Date(),
            user: firebase.auth().currentUser ? firebase.auth().currentUser.uid : null
        };
        calculateOrOrderBtn.textContent = "Siparişi Onayla";
        calculationState = "order";
    } else {
        // Siparişi kaydet
        if (!lastOrderData) return;
        if (typeof firebase !== "undefined" && firebase.firestore && lastOrderData.user) {
            db.collection('orders').add(lastOrderData).then(() => {
                // Onay mesajı göster
                approvalMsg.innerHTML = '<div class="bg-green-100 border border-green-300 text-green-800 font-semibold rounded-lg px-4 py-3 inline-block">✔️ Siparişiniz onaylandı!</div>';
                approvalMsg.classList.remove("hidden");
                // Formu ve state'i sıfırla
                calculatorForm.reset();
                calculationResult.classList.add('hidden');
                calculateOrOrderBtn.textContent = "Hesapla";
                calculationState = "calculate";
            }).catch(err => {
                showToast("Sipariş kaydedilemedi: " + (err.message || "Bilinmeyen hata"));
            });
        } else {
            showToast("Giriş yapmadan sipariş veremezsiniz.");
        }
    }
});
calculatorForm.addEventListener('submit', function(e) { e.preventDefault(); });
});
</script>
<!-- ... diğer scriptler ve alt kısım aynı ... -->
