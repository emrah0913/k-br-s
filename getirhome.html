<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title id="page-title">Getir Kıbrıs - Anasayfa</title>
<meta name="description" content="Kıbrıs'ın en büyük online alışveriş platformu. Binlerce ürünü kapına teslim al.">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">

<script>
    // Tailwind Konfigürasyonu: Getir'in ana rengini (primary) tanımla
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#5D3EBC', // Getir Moru
                    secondary: '#FFD300', // Getir Sarısı
                    'getir-yellow': '#FFD300',
                },
                fontFamily: {
                    inter: ['Inter', 'sans-serif'],
                },
            },
        }
    }
</script>

<style>
    body { font-family: 'Inter', sans-serif; }
    /* Product card için hover efekti sadece anasayfada görünmeli */
    #products-grid .product-card { transition: all 0.2s; }
    #products-grid .product-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05); }
</style>

</head>
<body class="bg-gray-50 min-h-screen">

<header class="sticky top-0 w-full bg-white shadow-md z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <!-- Logo/Anasayfa Bağlantısı (Hash Routing ile güncellendi) -->
        <a href="#" onclick="navigate('/')" class="text-2xl font-extrabold text-primary hover:text-primary/90 transition-colors">Getir Kıbrıs</a>
        <div class="flex items-center gap-4">
            <a href="/sepet.html" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition-colors">
                <i class="ri-shopping-cart-2-fill"></i> Sepetim
            </a>
            <div class="h-8 w-px bg-gray-200"></div> <div class="flex items-center gap-3">
                <span id="user-email" class="text-sm font-medium text-gray-600 truncate max-w-[100px]">Misafir</span>
                <button id="loginBtn" class="text-primary hover:text-primary/80 font-semibold transition-colors">Giriş</button>
                <button id="logoutBtn" class="text-red-500 hover:text-red-700 font-semibold hidden transition-colors">Çıkış</button>
            </div>
        </div>
    </div>
</header>

<!-- HERO SECTION - Sadece Anasayfada Görünecek -->
<section id="hero-section" class="bg-primary/90 text-white pt-10 pb-16">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
        <div>
            <h2 class="text-4xl lg:text-5xl font-extrabold mb-3 leading-tight">
                Getir Kıbrıs'la<br><span class="text-secondary">Binlerce Ürün Kapında.</span>
            </h2>
            <p class="text-lg opacity-90 mb-6">Türkiye'deki ürünlere Kıbrıs'tan komisyonlu sipariş imkanı!</p>
            <div class="flex gap-4">
                <a href="#" class="bg-white text-primary px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:shadow-xl transition-shadow">
                    <i class="ri-apple-fill ri-lg"></i> App Store
                </a>
                <a href="#" class="bg-getir-yellow text-gray-900 px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:shadow-xl transition-shadow">
                    <i class="ri-google-play-fill ri-lg"></i> Google Play
                </a>
            </div>
        </div>
        <img src="https://picsum.photos/400/300?random=1" alt="Getir Kurye" class="hidden md:block w-96 h-auto object-cover rounded-xl shadow-2xl">
    </div>
</section>

<!-- ANA İÇERİK BÖLÜMÜ - Anasayfa veya Detay Sayfası burada yüklenecek -->
<main id="app-container">
    <!-- JS ile içerik buraya yüklenecek -->
</main>

<div id="msg" class="fixed bottom-4 right-4 z-[100] px-4 py-2 rounded-lg text-white font-medium shadow-xl hidden transition-all duration-300"></div>

<footer class="mt-16 border-t bg-white py-8">
    <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500">
        <p>&copy; 2024 Getir Kıbrıs. Tüm hakları saklıdır. | Powered by Firebase</p>
        <p class="mt-2">Hizmet Şartları | Gizlilik Politikası</p>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // --- Kullanıcının Sağladığı Firebase Konfigürasyonu ---
    const firebaseConfig = {
        apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
        authDomain: "kibris-6b4f7.firebaseapp.com",
        projectId: "kibris-6b4f7",
        storageBucket: "kibris-6b4f7.appspot.com",
        messagingSenderId: "141262926171",
        appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
        measurementId: "G-JL9P6BRZTD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // --- Mock Ürün Verisi (Detay sayfasını çalıştırmak için zorunlu) ---
    const mockProducts = [
        { id: 'pro123', name: 'Ultra Hızlı Şarj Adaptörü', price: '450', category: 'ELEKTRONIK', active: true, description: '120W, GaN teknolojisi, hızlı ve güvenilir.', image: 'https://placehold.co/300x200/5D3EBC/FFFFFF?text=SARJ+ADAPTORU', 
          mockImages: ['https://picsum.photos/id/201/600/400', 'https://picsum.photos/id/202/600/400', 'https://picsum.photos/id/203/600/400'] },
        { id: 'pro456', name: 'Premium Espresso Kapsülleri', price: '120', category: 'GIDA', active: true, description: 'İtalyan kavurma, yoğun lezzet, 10 adet.', image: 'https://placehold.co/300x200/FFD300/5D3EBC?text=KAHVE+KAPSUL',
          mockImages: ['https://picsum.photos/id/210/600/400', 'https://picsum.photos/id/211/600/400'] },
        { id: 'pro789', name: 'Çilekli Yoğurt (1.5KG)', price: '65', category: 'SUT+URUNLERI', active: true, description: 'Taptaze çilek parçacıklarıyla dolu, büyük boy.', image: 'https://placehold.co/300x200/F06292/FFFFFF?text=CILEKLI+YOGURT',
          mockImages: ['https://picsum.photos/id/220/600/400'] },
        { id: 'pro101', name: 'Organik Tam Buğday Ekmeği', price: '35', category: 'TEMEL+GIDA', active: true, description: 'Geleneksel yöntemlerle hazırlanmış, besleyici.', image: 'https://placehold.co/300x200/A1887F/FFFFFF?text=EKMEK',
          mockImages: ['https://picsum.photos/id/230/600/400', 'https://picsum.photos/id/231/600/400', 'https://picsum.photos/id/232/600/400'] },
        { id: 'pro102', name: 'Güneş Kremi SPF50', price: '280', category: 'KOZMETIK', active: true, description: 'Yüksek koruma, suya dayanıklı formül.', image: 'https://placehold.co/300x200/4FC3F7/FFFFFF?text=GUNES+KREMI',
          mockImages: ['https://picsum.photos/id/240/600/400', 'https://picsum.photos/id/241/600/400'] }
    ];

    // --- DOM Elementleri ---
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userEmailSpan = document.getElementById("user-email");
    const appContainer = document.getElementById("app-container"); // Main content container
    const msgDiv = document.getElementById("msg");
    const pageTitle = document.getElementById("page-title");

    let allProducts = []; // Tüm ürünleri tutacak global dizi
    let productsLoaded = false;

    // --- Yardımcı Fonksiyonlar (Mesaj Gösterme) ---
    function showMsg(text, isError=false){
        msgDiv.textContent=text;
        msgDiv.className = `fixed bottom-4 right-4 z-[100] px-4 py-2 rounded-lg text-white font-medium shadow-xl transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        msgDiv.classList.remove("hidden");
        setTimeout(()=>msgDiv.classList.add("hidden"),3000);
    }

    // --- Yönlendirme ve Sayfa Yönetimi MANTIĞI (HASH ROUTING) ---
    function navigate(path) {
        // Hash ile yönlendirme yap
        location.hash = path === '/' ? '' : path;
        // Hash değişimi renderPage'i tetikleyeceği için burada manuel çağırmaya gerek yok.
        // Ancak tarayıcı hash'i değişmese bile (örneğin ana sayfada navigate('/') çağrılırsa) renderPage'i çağırıyoruz.
        renderPage(); 
    }

    // Geri/İleri tuşları ve hash değişiklikleri için onhashchange kullan
    window.onhashchange = renderPage; 

    function getRouteParams() {
        const hash = window.location.hash.substring(1); // # işaretini kaldırır (örn: /detail?id=pro123)

        let view = 'home';
        let id = null;

        if (hash.startsWith('/detail')) {
            view = 'detail';
            // /detail kısmı hariç sorgu dizisini alır (örn: ?id=pro123)
            const queryString = hash.substring('/detail'.length); 
            const urlParams = new URLSearchParams(queryString);
            id = urlParams.get('id');
        } else if (hash.length === 0 || hash === '/') {
            view = 'home';
        }

        return { 
            path: hash, 
            id: id,
            view: view
        };
    }

    function renderPage() {
        const { view, id } = getRouteParams();
        
        // Hero bölümünün sadece anasayfada görünmesini sağla
        const heroSection = document.getElementById("hero-section");
        if (heroSection) {
            heroSection.style.display = view === 'home' ? 'block' : 'none';
        }

        appContainer.innerHTML = '';
        
        // Sayfa başlığını güncelle
        pageTitle.textContent = view === 'detail' ? 'Getir Kıbrıs - Ürün Detayı' : 'Getir Kıbrıs - Anasayfa';

        if (!productsLoaded) {
            // Ürünler yüklenmediyse yükleme ekranını göster
            appContainer.innerHTML = `<div class="text-center py-20 text-gray-500 font-medium">
                <i class="ri-loader-4-line ri-2x animate-spin"></i> Uygulama Başlatılıyor...
            </div>`;
            return;
        }

        if (view === 'detail' && id) {
            renderDetailPage(id);
        } else {
            renderHomePage();
        }
    }

    // --- AUTH MANTIK (Aynı kaldı) ---
    loginBtn.addEventListener("click", async ()=>{ 
        try{ await signInWithPopup(auth,provider); } 
        catch(e){ showMsg("Giriş hatası: "+e.message, true); } 
    });

    logoutBtn.addEventListener("click", async ()=>{ 
        await signOut(auth); 
    });

    onAuthStateChanged(auth, user=>{
        if(user){
            userEmailSpan.textContent=user.email;
            loginBtn.classList.add("hidden");
            logoutBtn.classList.remove("hidden");
        }else{
            userEmailSpan.textContent="Misafir";
            loginBtn.classList.remove("hidden");
            logoutBtn.classList.add("hidden");
        }
        // AUTH state değiştiğinde bir şey yapmamız gerekmiyorsa burayı boş bırakabiliriz.
        // Ürün yükleme, uygulama başlatılırken (loadProducts) yapılıyor.
    });

    // --- ÜRÜN KARTI RENDER FONKSİYONU ---
    function renderProductCards(productsToRender, productsListContainer) {
        // productsListContainer'ı temizlemeden önce loading indicator'ı gizle
        const loadingIndicator = document.getElementById("loading-indicator-home");
        if(loadingIndicator) loadingIndicator.classList.add("hidden");

        productsListContainer.innerHTML = ''; // Önceki ürünleri temizle

        const productGrid = document.createElement('div');
        productGrid.id = "products-grid";
        productGrid.className = "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6";

        if (productsToRender.length === 0) {
            productGrid.innerHTML = "<p class='col-span-full text-center py-10 text-gray-500'>Seçilen kategoride aktif ürün bulunamadı.</p>";
            productsListContainer.appendChild(productGrid);
            return;
        }

        productsToRender.forEach(p => {
            const card = document.createElement("a");
            card.href = `#`; // Hash routing kullandığımız için href'i temiz tutuyoruz
            card.onclick = (e) => {
                e.preventDefault(); // Varsayılan <a> davranışını engelle
                navigate(`/detail?id=${p.id}`); // Hash ile detay sayfasına git
            };
            card.className = "product-card bg-white p-4 rounded-xl shadow-lg flex flex-col overflow-hidden cursor-pointer";
            
            card.innerHTML = `
                <div class="h-40 overflow-hidden mb-4 rounded-lg bg-gray-100">
                    <img src="${p.image || 'https://picsum.photos/300/200'}" 
                        alt="${p.name}" 
                        class="w-full h-full object-cover transition-transform duration-300 hover:scale-[1.03]"
                    />
                </div>
                <span class="text-xs text-primary font-semibold uppercase mb-1">${p.category || 'GENEL'}</span>
                <h3 class="font-bold text-base text-gray-800 truncate mb-1">${p.name}</h3>
                <p class="text-sm text-gray-500 mb-3 line-clamp-2">${p.description || "Hızlı teslimat ve uygun fiyat garantisiyle."}</p>
                
                <div class="flex justify-between items-center mt-auto pt-3 border-t">
                    <span class="font-extrabold text-xl text-primary">${p.price} ₺</span>
                    <button data-id="${p.id}" class="add-to-cart-btn bg-getir-yellow text-primary px-4 py-2 rounded-lg font-semibold hover:bg-getir-yellow/80 transition-colors flex items-center gap-1 text-sm">
                        <i class="ri-add-line"></i> Ekle
                    </button>
                </div>
            `;
            productGrid.appendChild(card);
        });

        productsListContainer.appendChild(productGrid);

        // Sepete Ekle butonlarına listener'ları ekle
        productGrid.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
                event.stopPropagation(); // Kart tıklamasını engelle
                handleAddToCart(event);
            });
        });
    }

    // --- KATEGORİ FİLTRELEME MANTIĞI (Anasayfa için) ---
    function populateCategories(filterSelect, productsListContainer) {
        // Tüm ürünlerden benzersiz kategorileri al
        const categories = [...new Set(allProducts.map(p => p.category).filter(c => c))];
        
        // Kategori seçeneklerini oluştur
        const optionsHtml = categories.map(cat => 
            `<option value="${cat}">${cat.toUpperCase()}</option>`
        ).join('');
        
        filterSelect.innerHTML = `<option value="all">Tüm Ürünler</option>` + optionsHtml;

        // Filtre değişince ürünleri yeniden render et
        filterSelect.onchange = () => {
            const selectedCategory = filterSelect.value;
            let filteredProducts = allProducts;
            
            if (selectedCategory !== 'all') {
                filteredProducts = allProducts.filter(p => p.category === selectedCategory);
            }
            
            renderProductCards(filteredProducts, productsListContainer);
        };
    }

    // --- ANASAYFA RENDER FONKSİYONU ---
    function renderHomePage() {
        const homeContent = document.createElement('div'); // ana içeriği main tag'ı zaten kapsıyor
        homeContent.className = "max-w-7xl mx-auto p-6";

        homeContent.innerHTML = `
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h2 class="text-3xl font-bold text-gray-800">Tüm Kategorilerde Fırsatlar</h2>
                <select id="category-filter-home" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition-colors">
                    <option value="all">Yükleniyor...</option>
                </select>
            </div>
            <div id="products-list-container">
                <div id="loading-indicator-home" class="text-center py-10 text-gray-500 font-medium">
                    <i class="ri-loader-4-line ri-2x animate-spin"></i> Ürünler Yükleniyor...
                </div>
            </div>
        `;
        appContainer.appendChild(homeContent);

        // DOM elementlerini al
        const filterSelect = document.getElementById("category-filter-home");
        const productsListContainer = document.getElementById("products-list-container");
        
        if (allProducts.length > 0) {
            populateCategories(filterSelect, productsListContainer);
            renderProductCards(allProducts, productsListContainer);
        }
    }

    // --- ÜRÜN DETAY SAYFASI RENDER FONKSİYONU (Görselleri Gösteren Sayfa) ---
    function renderDetailPage(productId) {
        const product = allProducts.find(p => p.id === productId);

        if (!product) {
            appContainer.innerHTML = `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="text-center py-20">
                        <h2 class="text-4xl font-bold text-red-500 mb-4">Ürün Bulunamadı :(</h2>
                        <p class="text-lg text-gray-600">Aradığınız ürün ID'si (${productId}) ile eşleşen bir kayıt bulunamadı.</p>
                        <button onclick="navigate('/')" class="mt-6 bg-primary text-white px-6 py-3 rounded-xl font-bold hover:bg-primary/90 transition-colors">
                            <i class="ri-arrow-left-line"></i> Anasayfaya Dön
                        </button>
                    </div>
                </div>
            `;
            return;
        }

        const imagesHtml = product.mockImages.map((imgSrc, index) => `
            <div class="w-full h-80 rounded-xl overflow-hidden shadow-lg border border-gray-100">
                <img src="${imgSrc}" alt="${product.name} Görsel ${index + 1}" class="w-full h-full object-cover">
            </div>
        `).join('');

        appContainer.innerHTML = `
            <div class="max-w-7xl mx-auto p-6">
                <button onclick="navigate('/')" class="text-primary hover:text-primary/80 font-semibold mb-6 flex items-center gap-2 transition-colors">
                    <i class="ri-arrow-left-line"></i> Tüm Ürünlere Geri Dön
                </button>
                
                <div class="bg-white p-6 md:p-10 rounded-2xl shadow-xl">
                    <div class="flex flex-col lg:flex-row gap-10">
                        <!-- Görsel Alanı (Gallery) -->
                        <div class="lg:w-1/2">
                            <h2 class="text-4xl font-extrabold text-gray-800 mb-6">${product.name} Görselleri</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${imagesHtml}
                            </div>
                        </div>

                        <!-- Detay Alanı -->
                        <div class="lg:w-1/2">
                            <span class="text-sm text-primary font-bold uppercase">${product.category}</span>
                            <p class="text-xl text-gray-600 my-4">${product.description}</p>
                            
                            <div class="my-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                                <span class="text-2xl font-extrabold text-primary">${product.price} ₺</span>
                                <p class="text-sm text-gray-500 mt-1">Komisyon dahil tahmini Kıbrıs fiyatıdır.</p>
                            </div>

                            <button data-id="${product.id}" id="detail-add-to-cart-btn" class="w-full bg-getir-yellow text-primary px-6 py-3 rounded-lg font-extrabold text-lg hover:bg-getir-yellow/80 transition-colors flex items-center justify-center gap-2 shadow-md">
                                <i class="ri-shopping-cart-2-fill"></i> Sepete Ekle
                            </button>

                            <div class="mt-8 pt-4 border-t border-gray-200">
                                <h4 class="font-semibold text-gray-700 mb-2">Ek Bilgiler</h4>
                                <ul class="text-sm text-gray-500 space-y-1">
                                    <li><i class="ri-check-line text-green-500"></i> Hızlı Teslimat Garantisi</li>
                                    <li><i class="ri-check-line text-green-500"></i> Güvenli Ödeme</li>
                                    <li><i class="ri-check-line text-green-500"></i> İade İmkanı (Koşullu)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        // Detay sayfasındaki Sepete Ekle butonuna listener ekle
        document.getElementById('detail-add-to-cart-btn').addEventListener('click', handleAddToCart);
    }

    // --- ÜRÜN YÜKLEME (ANA) FONKSİYON ---
    async function loadProducts(){
        productsLoaded = false;
        renderPage(); // Yükleniyor ekranını göster

        try {
            // Gerçek Firestore bağlantısı:
            // const snap = await getDocs(collection(db,"homeProducts"));
            // allProducts = snap.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() })).filter(p => p.active); 
            
            // UI testi için Mock data:
            await new Promise(resolve => setTimeout(resolve, 500)); 
            allProducts = mockProducts.filter(p => p.active);
            
            productsLoaded = true;
        } catch(e) {
            showMsg("Ürünler yüklenirken hata oluştu: " + e.message, true);
        } finally {
            renderPage(); // Ürünler yüklendikten sonra ana içeriği render et
        }
    }

    // --- SEPETE EKLEME MANTIĞI ---
    async function handleAddToCart(event){
        const user = auth.currentUser;
        if(!user){ showMsg("Sepete eklemek için giriş yapmalısınız!", true); return;}
        
        const btn = event.currentTarget;
        const productId = btn.dataset.id;
        const product = allProducts.find(p => p.id === productId);

        if (!product) { showMsg("Ürün bulunamadı.", true); return; }

        btn.disabled = true;
        btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Yükleniyor...'; 

        try{
            // Firestore işlemi:
            const itemRef = doc(db, "users", user.uid, "cart", productId);
            await setDoc(itemRef, {
                userId: user.uid,
                productLink: product.name, 
                productPrice: parseFloat(product.price) || 0, 
                category: product.category || 'cosmetics', 
                orderMethod: 'service', 
                quantity: 1, 
                addedAt: new Date()
            }, { merge: true });

            showMsg(`"${product.name}" sepete eklendi!`);
        }catch(e){ 
            showMsg("Sepete eklenirken hata: "+e.message, true);
        } finally {
            btn.disabled = false;
            // Buton metnini geri yükle (Anasayfa veya Detay butonu olabilir)
            if (btn.id === 'detail-add-to-cart-btn') {
                 btn.innerHTML = '<i class="ri-shopping-cart-2-fill"></i> Sepete Ekle';
            } else {
                 btn.innerHTML = '<i class="ri-add-line"></i> Ekle';
            }
        }
    }

    // Uygulamayı başlat
    loadProducts();
</script>
</body>
</html>
