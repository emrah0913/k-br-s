<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Getir Home | Getir Kıbrıs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // === Firebase Bağlantısı ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    // YENİ: addDoc (ekleme için), getAuth, onAuthStateChanged (kullanıcı kontrolü için)
    import { getFirestore, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js"; 

    const firebaseConfig = {
      apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
      authDomain: "kibris-6b4f7.firebaseapp.com",
      projectId: "kibris-6b4f7",
      storageBucket: "kibris-6b4f7.firebasestorage.app",
      messagingSenderId: "141262926171",
      appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
      measurementId: "G-JL9P6BRZTD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app); 
    let currentUser = null; 

    // YENİ: Sayfa yüklendiğinde kullanıcı durumunu dinle
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
    });

    // === Dinamik Banner ===
    async function loadBanners() {
      const bannerContainer = document.getElementById("banner-slider");
      const q = query(collection(db, "homeBanners"));
      try {
        const snapshot = await getDocs(q);
        let banners = [];
        snapshot.forEach(doc => {
          let data = doc.data();
          if (data.aktif) banners.push(data.resimURL);
        });
        if (banners.length === 0) return;

        let index = 0;
        bannerContainer.style.backgroundImage = `url(${banners[0]})`;
        setInterval(() => {
          index = (index + 1) % banners.length;
          bannerContainer.style.backgroundImage = `url(${banners[index]})`;
        }, 4000);
      } catch (error) {
        console.error("Banner yüklenirken hata:", error);
        // Kullanıcıya gösterilecek bir hata mesajı eklenebilir.
      }
    }

    // === Kategoriler ===
    async function loadCategories() {
      const catContainer = document.getElementById("kategori-listesi");
      try {
        const snapshot = await getDocs(collection(db, "homeCategories"));
        catContainer.innerHTML = "";
        snapshot.forEach(doc => {
          const cat = doc.data();
          if (cat.aktif) {
            const btn = document.createElement("button");
            btn.className = "px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700";
            btn.textContent = cat.kategoriAdi;
            btn.onclick = () => loadProducts(doc.id, cat.kategoriAdi);
            catContainer.appendChild(btn);
          }
        });
      } catch (error) {
        console.error("Kategori yüklenirken hata:", error);
      }
    }
    
    // === Sepete Ekleme Fonksiyonu (GÜNCELLENMİŞ) ===
    /**
     * Ürünü Firebase'de kullanıcının sepetine ekler ve sepet sayfasına yönlendirir.
     * Özel kategori ve orderMethod kullanarak sepet sayfasında komisyon eklenmesini engeller.
     */
    async function addToCart(urunAdi, urunFiyati, resimURL) {
        if (!currentUser) {
            alert("Sepete ürün eklemek için lütfen giriş yapınız.");
            window.location.href = '/index.html'; 
            return;
        }

        try {
            const cartRef = collection(db, 'users', currentUser.uid, 'cart');
            
            const newCartItem = {
                productLink: `GETIR HOME: ${urunAdi}`, 
                productPrice: parseFloat(urunFiyati), // Gönderilen SON FİYAT
                quantity: 1, 
                
                // KRİTİK: Sepet sayfasının komisyonu SIFIR (0) olarak hesaplamasını sağlayacak ayarlar:
                category: 'directBuyHome', // Firestore'da %0 oran tanımlanacak
                orderMethod: 'service', // Sepet sayfasının komisyon formülünü tetikler (productPrice + komisyon)

                urunAdi: urunAdi,
                resimURL: resimURL
            };

            await addDoc(cartRef, newCartItem);
            
            alert(`${urunAdi} sepete eklendi!`);
            // Başarılı eklemeden sonra kullanıcıyı sepet sayfasına yönlendir
            window.location.href = '/sepet.html';

        } catch (error) {
            console.error("Ürün sepete eklenirken hata oluştu:", error);
            alert("Ürün sepete eklenemedi: " + error.message);
        }
    }

    // === Ürünler ===
    async function loadProducts(kategoriId = null, kategoriAdi = null) {
      const urunContainer = document.getElementById("urun-listesi");
      urunContainer.innerHTML = "<p class='text-gray-400'>Yükleniyor...</p>";

      let q = collection(db, "homeProducts");
      if (kategoriId) q = query(q, where("kategoriId", "==", kategoriId));

      try {
        const snapshot = await getDocs(q);
        urunContainer.innerHTML = "";

        snapshot.forEach(doc => {
          const urun = doc.data();
          if (!urun.aktif) return;

          const card = document.createElement("div");
          card.className = "border rounded-xl p-4 shadow hover:shadow-lg transition bg-white";

          // GÜNCELLENDİ: Sepete Ekle butonu addToCart fonksiyonunu çağırıyor
          card.innerHTML = `
            <img src="${urun.resimURL}" alt="${urun.urunAdi}" class="w-full h-48 object-cover rounded-lg mb-3">
            <h3 class="text-lg font-semibold mb-1">${urun.urunAdi}</h3>
            <p class="text-gray-600 text-sm mb-2">${urun.aciklama || ""}</p>
            <p class="text-blue-600 font-bold mb-3">${urun.fiyat} ₺</p>
            <button onclick="window.addToCart('${urun.urunAdi.replace(/'/g, "\\'")}', ${urun.fiyat}, '${urun.resimURL}')"
                    class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
              Sepete Ekle
            </button>
          `;
          urunContainer.appendChild(card);
        });
      } catch (error) {
        console.error("Ürün yüklenirken hata:", error);
        urunContainer.innerHTML = "<p class='text-red-500'>Ürünler yüklenemedi. Yetki veya bağlantı hatası olabilir.</p>";
      }

      document.getElementById("secili-kategori").textContent = kategoriAdi || "Tüm Ürünler";
    }

    // === Sayfa Yüklendiğinde ===
    window.addEventListener("DOMContentLoaded", async () => {
      await loadBanners();
      await loadCategories();
      await loadProducts();
    });
    
    // YENİ: addToCart fonksiyonunu HTML'den çağrılabilir hale getir
    window.addToCart = addToCart;
    
  </script>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

    <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-xl font-bold text-blue-700">Getir Home</h1>
      <nav class="flex gap-4">
        <a href="/index.html" class="text-gray-600 hover:text-blue-700">Ana Sayfa</a>
        <a href="/getirhome.html" class="text-blue-700 font-semibold">Home</a>
        <a href="/sepet.html" class="text-gray-600 hover:text-blue-700">Sepetim</a>
      </nav>
    </div>
  </header>

    <section id="banner-slider"
           class="w-full h-60 bg-center bg-cover transition-all duration-700 flex items-center justify-center text-white text-2xl font-bold">
    <div class="bg-black/40 w-full h-full flex items-center justify-center">
      <span>Getir Home Kampanyaları</span>
    </div>
  </section>

    <section class="max-w-7xl mx-auto px-4 py-6">
    <div id="kategori-listesi" class="flex flex-wrap gap-3 justify-center"></div>
  </section>

    <main class="max-w-7xl mx-auto px-4 pb-10">
    <h2 class="text-2xl font-semibold mb-4 text-gray-800 text-center">
      <span id="secili-kategori">Tüm Ürünler</span>
    </h2>
    <div id="urun-listesi" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
  </main>

    <footer class="bg-gray-100 py-6 mt-auto text-center text-gray-500 text-sm">
    © 2025 Getir Kıbrıs | Tüm hakları saklıdır.
  </footer>

</body>
</html>
