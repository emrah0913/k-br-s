<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Getir Home | Getir Kıbrıs</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script type="module">
		// === Firebase Bağlantısı ve Zorunlu Global Değişkenler ===
		// Canvas ortamı için gerekli olan en güncel SDK'lar ve yöntemler korunmuştur.
		import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
		import { getFirestore, collection, getDocs, query, where, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
		import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 

		// Zorunlu Global Değişkenlerin Tanımlanması (Canvas Ortamı için KRİTİK)
		const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
		
		const firebaseConfig = (() => {
			if (typeof __firebase_config !== 'undefined' && __firebase_config) {
				try {
					return JSON.parse(__firebase_config);
				} catch (e) {
					console.error("HATA: __firebase_config JSON ayrıştırılamadı. Yedek projectId kullanılıyor.", e);
					return { projectId: 'parse-error-fallback' };
				}
			}
			return { projectId: 'undefined-config-fallback' };
		})();

		const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
		
		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		const auth = getAuth(app);
		setLogLevel('Debug'); // Firestore loglarını aç

		let currentUser = null;
		let userId = null;
		const provider = new GoogleAuthProvider(); // Google Auth Sağlayıcısı
        
        // Halka açık (public) koleksiyon yolunu döndüren yardımcı fonksiyon (Canvas'ın zorunlu yolu)
        function getPublicCollectionRef(collectionName) {
            // Path: /artifacts/{appId}/public/data/{collectionName}
            return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
        }

		// Basit Kök Koleksiyon yolunu döndüren yardımcı fonksiyon (Eski/Basit yol)
		function getRootCollectionRef(collectionName) {
            // Path: /{collectionName}
            return collection(db, collectionName);
        }

		// YENİ: Firebase Authentication'ı başlat ve zorunlu oturum açma tokenını kullan
		async function ensureAuthAndLoadData() {
			try {
				if (initialAuthToken) {
					// Özel token varsa, bununla oturum aç
					await signInWithCustomToken(auth, initialAuthToken);
				} else {
					// Yoksa anonim olarak oturum aç (Veri okumak için minimum yetki)
					await signInAnonymously(auth);
				}
			} catch (error) {
				console.error("Firebase oturum açma başarısız:", error);
			}

			// Sayfa yüklendiğinde kullanıcı durumunu dinle
			onAuthStateChanged(auth, (user) => {
				currentUser = user;
				userId = user ? user.uid : crypto.randomUUID(); 
				
				// Kullanıcı durumu belirlendikten sonra verileri yükle
				loadBanners();
				loadCategories();
				loadProducts();

				// Navigasyon çubuğunu kullanıcı durumuna göre güncelle
				updateUserUI(user);
			});
		}

		// Kullanıcı Arayüzünü Güncelleyen Fonksiyon (Önceki kodunuzdan korundu)
		function updateUserUI(user) {
			const authContainer = document.getElementById('auth-container');
			if (!authContainer) return;

			if (!user || user.isAnonymous) {
				authContainer.innerHTML = `
					<button onclick="window.googleSignIn()" class="bg-yellow-500 text-gray-800 py-1.5 px-4 rounded-lg hover:bg-yellow-600 transition font-semibold flex items-center shadow-md text-sm">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 48 48" fill="none">
							<path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.309c-.751 3.511-3.155 6.44-6.427 8.353v5.82h7.323c4.279-3.951 6.75-9.763 6.75-16.176 0-1.127-.101-2.226-.294-3.284z"/>
							<path fill="#FF3D00" d="M24 44c6.315 0 11.536-2.071 15.385-5.636l-7.323-5.82c-2.029 1.353-4.595 2.156-8.062 2.156-6.195 0-11.41-4.143-13.344-9.72H3.77v5.908C8.257 39.525 15.708 44 24 44z"/>
							<path fill="#4CAF50" d="M3.77 28h8.893c-.381-1.353-.604-2.784-.604-4s.223-2.647.604-4H3.77v5.908C8.257 39.525 15.708 44 24 44z"/>
							<path fill="#1976D2" d="M24 4c-5.187 0-9.825 2.05-13.344 5.378l-7.323-5.82C8.257 4.475 15.708 0 24 0c7.11 0 13.433 2.607 18.293 7.07l-6.75 5.25C31.272 8.143 28.025 6 24 6c-3.791 0-7.234 1.34-9.816 3.585L16.29 14.992l-4.996 4.996L3.996 12.5C8.257 4.475 15.708 0 24 0z"/>
						</svg>
						Giriş Yap
					</button>
				`;
			} else {
				const emailDisplay = user.email || "Kullanıcı";
				authContainer.innerHTML = `
					<div class="text-sm font-medium text-gray-700 mr-4 hidden sm:block truncate max-w-[120px]" title="${emailDisplay}">${emailDisplay}</div>
					<button onclick="window.handleSignOut()" class="bg-gray-200 text-gray-800 py-1.5 px-4 rounded-lg hover:bg-gray-300 transition font-semibold shadow-sm text-sm">
						Çıkış Yap
					</button>
				`;
			}
		}

		// Google ile Giriş Yöneticisi (Önceki kodunuzdan korundu)
		async function googleSignIn() {
			try {
				await signInWithPopup(auth, provider);
				showToast("Google ile başarıyla giriş yapıldı!");
			} catch (error) {
				console.error("Google girişinde hata:", error);
				showToast("Giriş yaparken hata oluştu: " + error.message, true);
			}
		}

		// Çıkış Yap Yöneticisi (Önceki kodunuzdan korundu)
		async function handleSignOut() {
			try {
				await signOut(auth);
				await signInAnonymously(auth); 
				showToast("Başarıyla çıkış yapıldı.");
			} catch (error) {
				console.error("Çıkış yaparken hata:", error);
				showToast("Çıkış yaparken hata oluştu.", true);
			}
		}
		
		// === Toast Bildirim Fonksiyonu (Önceki kodunuzdan korundu) ===
		function showToast(message, isError = false) {
			const toastContainer = document.getElementById('toast-container');
			const toast = document.getElementById('toast-message');
			
			if (isError) {
				toastContainer.classList.remove('bg-green-600');
				toastContainer.classList.add('bg-red-600');
			} else {
				toastContainer.classList.remove('bg-red-600');
				toastContainer.classList.add('bg-green-600');
			}

			toast.textContent = message;
			toastContainer.classList.remove('hidden', 'opacity-0');
			toastContainer.classList.add('opacity-100');

			setTimeout(() => {
				toastContainer.classList.remove('opacity-100');
				toastContainer.classList.add('opacity-0');
				setTimeout(() => toastContainer.classList.add('hidden'), 300);
			}, 3000);
		}


		// === Dinamik Banner (Fallback eklendi) ===
		async function loadBanners() {
			const bannerContainer = document.getElementById("banner-slider");
			let snapshot;
			
			// 1. Deneme: Canvas Public Yolu
			try {
				snapshot = await getDocs(query(getPublicCollectionRef("homeBanners")));
			} catch(e) {
				console.warn("Canvas Public Path'te Banner yüklenirken ilk deneme başarısız oldu.");
			}
			
			// 2. Deneme: Basit Kök Yolu (Kullanıcının çalışan kodundan gelen yol)
			if (!snapshot || snapshot.empty) {
				try {
					snapshot = await getDocs(query(getRootCollectionRef("homeBanners")));
					if (!snapshot.empty) {
						console.warn("Bannerlar, Basit Kök Yolu (/homeBanners) kullanılarak yüklendi.");
					}
				} catch(e) {
					console.error("Banner yüklenirken her iki yolda da hata:", e);
					return;
				}
			}

			if (!snapshot || snapshot.empty) return;
			
			let banners = [];
			snapshot.forEach(doc => {
				let data = doc.data();
				if (data.aktif) banners.push(data.resimURL);
			});
			if (banners.length === 0) return;

			let index = 0;
			bannerContainer.style.backgroundImage = `url(${banners[0]})`; 

			setInterval(() => {
				index = (index + 1) % banners.length;
				bannerContainer.style.backgroundImage = `url(${banners[index]})`;
			}, 4000);
		}

		// === Kategoriler (Fallback eklendi) ===
		async function loadCategories() {
			const catContainer = document.getElementById("kategori-listesi");
			let snapshot;

			// 1. Deneme: Canvas Public Yolu
			try {
				snapshot = await getDocs(getPublicCollectionRef("homeCategories"));
			} catch(e) {
				console.warn("Canvas Public Path'te Kategoriler yüklenirken ilk deneme başarısız oldu.");
			}

			// 2. Deneme: Basit Kök Yolu (Kullanıcının çalışan kodundan gelen yol)
			if (!snapshot || snapshot.empty) {
				try {
					snapshot = await getDocs(getRootCollectionRef("homeCategories"));
					if (!snapshot.empty) {
						console.warn("Kategoriler, Basit Kök Yolu (/homeCategories) kullanılarak yüklendi.");
					}
				} catch(e) {
					console.error("Kategori yüklenirken her iki yolda da hata:", e);
					return;
				}
			}

			if (!snapshot || snapshot.empty) {
				catContainer.innerHTML = "<p class='text-gray-500'>Kategori bulunamadı.</p>";
				return;
			}
			
			catContainer.innerHTML = "";
			snapshot.forEach(doc => {
				const cat = doc.data();
				if (cat.aktif) {
					const btn = document.createElement("button");
					btn.className = "px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 transition duration-150 shadow-sm font-medium";
					btn.textContent = cat.kategoriAdi;
					// Kategori filtrelemesi için doc.id kullanıldı
					btn.onclick = () => loadProducts(doc.id, cat.kategoriAdi);
					catContainer.appendChild(btn);
				}
			});
		}
		
		// Sepete Ekleme Fonksiyonu (Canvas uyumlu yolu korundu ve alert yerine toast kullanıldı)
		async function addToCart(urunAdi, urunFiyati, resimURL, urunLink) {
			if (!currentUser || currentUser.isAnonymous) {
				showToast("Sepete ürün eklemek için lütfen Google ile giriş yapın.", true);
				
				try {
					await signInWithPopup(auth, provider);
					currentUser = auth.currentUser; 
					showToast("Giriş başarılı, şimdi ürünü ekleyebilirsiniz.");
				} catch(e) {
					console.log("Kullanıcı giriş yapmayı reddetti veya işlem başarısız oldu.");
					showToast("Giriş yapılmadan sepet işlemi gerçekleştirilemez.", true);
					return;
				}
			}

			if (!currentUser || currentUser.isAnonymous) return;

			try {
				// Sepet yolu doğru: /artifacts/{appId}/users/{userId}/cart
				const cartRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'cart');
				
				const newCartItem = {
					productLink: urunLink || `GETIR HOME: ${urunAdi}`,
					urunAdi: urunAdi,
					resimURL: resimURL,
					
					productPrice: parseFloat(urunFiyati),
					quantity: 1,
					
					category: 'directBuyHome',
					orderMethod: 'service',
					timestamp: new Date()
				};

				await addDoc(cartRef, newCartItem);
				
				showToast(`${urunAdi} sepete eklendi! Sepete yönlendiriliyor...`);
				
				setTimeout(() => {
					window.location.href = '/sepet.html'; 
				}, 1500); 

			} catch (error) {
				console.error("Ürün sepete eklenirken hata oluştu:", error);
				showToast("Ürün sepete eklenemedi: " + error.message, true);
			}
		}

		// === Ürünler (Fallback eklendi) ===
		async function loadProducts(kategoriId = null, kategoriAdi = null) {
			const urunContainer = document.getElementById("urun-listesi");
			urunContainer.innerHTML = "<p class='text-gray-400 col-span-full text-center'>Yükleniyor...</p>";

			let q;
			let snapshot;

			// 1. Deneme: Canvas Public Yolu
			try {
				let publicRef = getPublicCollectionRef("homeProducts");
				q = kategoriId ? query(publicRef, where("kategoriId", "==", kategoriId)) : query(publicRef);
				snapshot = await getDocs(q);
			} catch(e) {
				console.warn("Canvas Public Path'te Ürünler yüklenirken ilk deneme başarısız oldu.");
			}

			// 2. Deneme: Basit Kök Yolu (Kullanıcının çalışan kodundan gelen yol)
			if (!snapshot || snapshot.empty) {
				try {
					let rootRef = getRootCollectionRef("homeProducts");
					q = kategoriId ? query(rootRef, where("kategoriId", "==", kategoriId)) : query(rootRef);
					snapshot = await getDocs(q);
					if (!snapshot.empty) {
						console.warn("Ürünler, Basit Kök Yolu (/homeProducts) kullanılarak yüklendi.");
					}
				} catch(e) {
					console.error("Ürün yüklenirken her iki yolda da hata:", e);
					urunContainer.innerHTML = `<p class='text-red-500 col-span-full text-center'>Ürünler yüklenemedi. Yetki veya bağlantı hatası olabilir: ${e.message}</p>`;
					document.getElementById("secili-kategori").textContent = kategoriAdi || "Tüm Ürünler";
					return;
				}
			}
			
			urunContainer.innerHTML = "";
			
			if (snapshot.empty) {
				urunContainer.innerHTML = "<p class='text-gray-500 text-center col-span-full'>Gösterilecek ürün bulunmamaktadır. Lütfen Firebase verilerinizi kontrol edin.</p>";
				document.getElementById("secili-kategori").textContent = kategoriAdi || "Tüm Ürünler";
				return;
			}


			snapshot.forEach(doc => {
				const urun = doc.data();
				if (!urun.aktif) return;

				const card = document.createElement("div");
				card.className = "border border-gray-100 rounded-xl p-4 shadow-md hover:shadow-xl transition duration-300 bg-white flex flex-col";

				const urunLink = urun.link || "#";
				// Tırnak işaretlerini kaçış karakteri ile temizleme
				const cleanUrunAdi = urun.urunAdi ? urun.urunAdi.replace(/'/g, "\\'").replace(/"/g, '\\"') : "Ürün Adı Yok"; 
				const urunResim = urun.resimURL || 'https://placehold.co/400x300/e5e7eb/4b5563?text=Resim+Yok'; 

				card.innerHTML = `
					<img src="${urunResim}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e5e7eb/4b5563?text=Resim+Yok';" 
						alt="${urun.urunAdi}" class="w-full h-48 object-cover rounded-lg mb-3 shadow-sm">
					<h3 class="text-lg font-semibold mb-1 truncate">${urun.urunAdi}</h3>
					<p class="text-gray-600 text-sm mb-2 line-clamp-2">${urun.aciklama || "Açıklama mevcut değil."}</p>
					<div class="mt-auto">
						<p class="text-blue-600 text-xl font-bold mb-3">${urun.fiyat} ₺</p>
						<button onclick="window.addToCart('${cleanUrunAdi}', ${urun.fiyat}, '${urunResim}', '${urunLink}')"
								class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition duration-150 transform hover:scale-[1.01] shadow-lg text-sm font-medium">
							Sepete Ekle
						</button>
					</div>
				`;
				urunContainer.appendChild(card);
			});

			document.getElementById("secili-kategori").textContent = kategoriAdi || "Tüm Ürünler";
		}

		// === Sayfa Yüklendiğinde ===
		window.addEventListener("DOMContentLoaded", ensureAuthAndLoadData);
		
		// Global erişim için
		window.addToCart = addToCart;
		window.googleSignIn = googleSignIn;
		window.handleSignOut = handleSignOut;
		
	</script>
    <!-- Tailwind CSS'i Inter fontu ile yükle -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col font-sans">

	<header class="bg-white shadow sticky top-0 z-50">
		<div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
			<h1 class="text-2xl font-extrabold text-blue-700">Getir Home</h1>
			<nav class="flex gap-6 items-center">
				<a href="/index.html" class="text-gray-600 hover:text-blue-700 transition font-medium">Ana Sayfa</a>
				<a href="/getirhome.html" class="text-blue-700 font-extrabold border-b-2 border-blue-500">Home</a>
				<a href="/sepet.html" class="text-gray-600 hover:text-blue-700 transition font-medium flex items-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
					</svg>
					Sepetim
				</a>
				<!-- Auth Durumunu Gösteren Alan -->
				<div id="auth-container" class="ml-4">
					<!-- İçerik JS tarafından doldurulacak -->
					<div class="animate-pulse bg-gray-200 w-28 h-8 rounded-lg"></div>
				</div>
			</nav>
		</div>
	</header>

	<section id="banner-slider"
			class="w-full h-60 bg-gray-600 bg-center bg-cover transition-all duration-700 flex items-center justify-center text-white text-3xl font-extrabold mb-8 shadow-inner"
			style="background-image: url('https://placehold.co/1200x300/4c348f/ffffff?text=Getir+Home+Kampanyalar%C4%B1')">
		<div class="bg-black/40 w-full h-full flex items-center justify-center">
			<span>Getir Home Kampanyaları</span>
		</div>
	</section>

	<section class="max-w-7xl mx-auto px-4 py-2 w-full">
		<div id="kategori-listesi" class="flex flex-wrap gap-3 justify-center border-b pb-4 mb-4">
			<p class="text-gray-400">Kategoriler Yükleniyor...</p>
		</div>
	</section>

	<main class="max-w-7xl mx-auto px-4 pb-10 w-full flex-grow">
		<h2 class="text-3xl font-extrabold mb-8 text-gray-800 text-center">
			<span id="secili-kategori" class="text-blue-600">Tüm Ürünler</span>
		</h2>
		<div id="urun-listesi" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
			<p class='text-gray-400 col-span-full text-center'>Ürünler Yükleniyor...</p>
		</div>
	</main>

	<!-- Toast Bildirim Alanı -->
	<div id="toast-container" class="fixed bottom-5 right-5 hidden opacity-0 transition-opacity duration-300 bg-green-600 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center space-x-2 transform translate-y-0">
		<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
		</svg>
		<span id="toast-message" class="font-medium text-lg"></span>
	</div>


	<footer class="bg-blue-700 py-6 mt-auto text-center text-white text-sm border-t shadow-inner">
		© 2025 Getir Kıbrıs | Tüm hakları saklıdır.
	</footer>

</body>
</html>
