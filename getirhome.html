<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title id="page-title">Getir Home - Anasayfa</title>
<meta name="description" content="Kıbrıs'ın en büyük online shopping platformu.">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#5D3EBC',
                    secondary: '#FFD300',
                    'getir-yellow': '#FFD300',
                },
                fontFamily: { inter: ['Inter', 'sans-serif'] },
            },
        }
    }
</script>

<style>
    body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
    #products-grid .product-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    #products-grid .product-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; border-radius: 0.75rem; }
    .video-container iframe, .video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
    .carousel-container { position: relative; overflow: hidden; height: auto; border-radius: 1rem; }
    .carousel-wrapper { display: flex; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; }
    .carousel-slide { flex: 0 0 100%; min-width: 100%; }
    .banner-content { height: auto; min-height: 250px; display: flex; align-items: center; justify-content: center; background-color: #5D3EBC; }
    .banner-image-contain { width: 100%; height: auto; max-height: 500px; object-fit: contain; }
    .variant-button.active { border-color: #5D3EBC; background-color: #5D3EBC08; box-shadow: 0 0 0 3px #5D3EBC30; }
    .category-link.active { background-color: #5D3EBC15; color: #5D3EBC; font-weight: 700; border-right: 4px solid #5D3EBC; }
    .ri-arrow-right-s-line.rotated { transform: rotate(90deg); }
    .toggle-icon { transition: transform 0.3s ease; }
    .category-thumb { width: 24px; height: 24px; object-fit: cover; border-radius: 6px; }
    .related-products-scroll { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 1rem; padding: 1rem 0; scrollbar-width: none; }
    .related-products-scroll::-webkit-scrollbar { display: none; }
    .related-products-scroll > a { flex: 0 0 200px; scroll-snap-align: start; }
    #cart-count { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
</style>
</head>

<body class="bg-gray-50 min-h-screen text-gray-900">

<div id="mobile-menu-overlay" class="fixed inset-0 bg-black/60 z-[90] hidden backdrop-blur-sm opacity-0 transition-opacity duration-300" onclick="toggleMobileMenu()"></div>
<div id="mobile-menu" class="fixed top-0 left-0 w-72 h-full bg-white z-[100] shadow-2xl transform -translate-x-full transition-transform duration-300 overflow-y-auto p-5">
    <div class="flex justify-between items-center mb-6 pb-4 border-b">
        <h3 class="text-2xl font-extrabold text-primary">Kategoriler</h3>
        <button onclick="toggleMobileMenu()" class="text-gray-400 hover:text-primary"><i class="ri-close-circle-fill ri-2x"></i></button>
    </div>
    <div id="mobile-category-menu"></div>
</div>

<header class="sticky top-0 w-full bg-white/95 backdrop-blur-md shadow-sm z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <button onclick="toggleMobileMenu()" class="lg:hidden text-primary p-2 bg-gray-100 rounded-lg"><i class="ri-menu-2-line ri-xl"></i></button>
            <div class="flex items-center space-x-3 sm:space-x-8">
                <a href="index.html" class="hidden sm:block opacity-60 hover:opacity-100 transition-all">
                    <img src="getirkibris-logo.png" alt="Getir Kıbrıs" class="h-9 w-auto" onerror="this.src='https://placehold.co/120x30/5D3EBC/FFFFFF?text=getirkıbrıs'">
                </a>
                <div class="hidden sm:block h-8 w-px bg-gray-200"></div>
                <a href="#" onclick="navigate('/')" class="group">
                    <img src="getirhome-logo.png" alt="Getir Home" class="h-10 sm:h-12 w-auto group-hover:scale-105 transition-transform" onerror="this.src='https://placehold.co/150x40/5D3EBC/FFD300?text=getirhome'">
                </a>
            </div>
        </div>
        
        <div class="flex items-center gap-2 sm:gap-6">
            <a href="/sepet.html" class="relative bg-primary text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 hover:bg-primary/90 transition-all shadow-lg shadow-primary/20">
                <i class="ri-shopping-basket-2-fill text-xl"></i>
                <span class="hidden md:inline">Sepetim</span>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-[11px] w-6 h-6 rounded-full flex items-center justify-center hidden border-2 border-white shadow-md font-black">0</span>
            </a>
            
            <div class="flex items-center bg-gray-100 p-1.5 rounded-2xl border border-gray-200 gap-3">
                <div id="user-profile-display" class="flex items-center gap-2 pl-2">
                    <span id="user-email" class="text-xs sm:text-sm font-bold text-gray-700 truncate max-w-[100px]">Yükleniyor...</span>
                </div>
                <button id="loginBtn" class="bg-white text-primary px-4 py-1.5 rounded-xl font-bold text-sm shadow-sm hover:bg-gray-50">Giriş</button>
                <button id="logoutBtn" class="hidden bg-red-50 text-red-600 px-4 py-1.5 rounded-xl font-bold text-sm hover:bg-red-100 transition-colors">Çıkış</button>
            </div>
        </div>
    </div>
</header>

<section id="hero-section" class="bg-primary/5"></section>
<main id="app-container" class="min-h-screen"></main>
<div id="msg" class="fixed bottom-6 right-6 z-[110] px-6 py-3 rounded-2xl text-white font-bold shadow-2xl hidden transform transition-all duration-300"></div>

<footer class="bg-white border-t mt-20 py-12">
    <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-10 text-center md:text-left">
        <div>
            <img src="getirhome-logo.png" class="h-10 mb-4 mx-auto md:mx-0 opacity-50">
            <p class="text-gray-400 text-sm">Kıbrıs'ın en büyük online platformu üzerinden dilediğiniz ürüne tek tıkla ulaşın.</p>
        </div>
        <div class="text-gray-500 text-sm flex flex-col gap-2">
            <h4 class="font-bold text-gray-900">Kurumsal</h4>
            <a href="#">Hakkımızda</a>
            <a href="#">Kullanım Koşulları</a>
            <a href="#">Gizlilik Politikası</a>
        </div>
        <div class="text-gray-500 text-sm flex flex-col gap-2">
            <h4 class="font-bold text-gray-900">Destek</h4>
            <a href="#">Sıkça Sorulan Sorular</a>
            <a href="#">İletişim</a>
            <a href="#">Yardım Merkezi</a>
        </div>
    </div>
    <div class="border-t mt-12 pt-6 text-center text-gray-400 text-xs">
        &copy; 2024 Getir Kıbrıs. Powered by Firebase Firestore.
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, setDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
        authDomain: "kibris-6b4f7.firebaseapp.com",
        projectId: "kibris-6b4f7",
        storageBucket: "kibris-6b4f7.appspot.com",
        messagingSenderId: "141262926171",
        appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
        measurementId: "G-JL9P6BRZTD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // GLOBAL VARIABLES & DOM
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userEmailSpan = document.getElementById("user-email");
    const appContainer = document.getElementById("app-container"); 
    const heroSection = document.getElementById("hero-section");
    const msgDiv = document.getElementById("msg");
    const cartCountBadge = document.getElementById("cart-count");

    let allProducts = [], allCategories = {}, allBanners = [], productsLoaded = false;
    let currentActiveCategory = 'all', currentSearchTerm = '', currentCalculatedPrice = 0, currentSelectedVariant = null;
    let currentSlide = 0, carouselWrapper, totalSlides, autoSlideInterval;

    // --- TOAST NOTIFICATION ---
    function showMsg(text, isError=false){
        msgDiv.textContent = text;
        msgDiv.className = `fixed bottom-6 right-6 z-[110] px-6 py-3 rounded-2xl text-white font-bold shadow-2xl transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        msgDiv.classList.remove("hidden");
        setTimeout(() => msgDiv.classList.add("hidden"), 3500);
    }

    // --- REAL-TIME CART LISTENER (En Önemli Kısım) ---
    function listenToCart(user) {
        if (!user) return;
        const cartRef = collection(db, "users", user.uid, "cart");
        onSnapshot(cartRef, (snapshot) => {
            let total = 0;
            snapshot.forEach(doc => {
                const data = doc.data();
                total += (data.quantity || 1);
            });
            if (total > 0) {
                cartCountBadge.textContent = total;
                cartCountBadge.classList.remove('hidden');
            } else {
                cartCountBadge.classList.add('hidden');
            }
        });
    }

    // --- AUTH TAKİBİ & PROFİL RESMİ ---
    onAuthStateChanged(auth, (user) => {
        if (user && !user.isAnonymous) {
            const photo = user.photoURL ? `<img src="${user.photoURL}" class="w-7 h-7 rounded-full border-2 border-primary shadow-sm">` : '<i class="ri-user-smile-fill ri-xl text-primary"></i>';
            userEmailSpan.innerHTML = `<div class="flex items-center gap-2">${photo} <span class="hidden sm:inline">${user.displayName || user.email.split('@')[0]}</span></div>`;
            loginBtn.classList.add("hidden");
            logoutBtn.classList.remove("hidden");
            listenToCart(user);
        } else {
            userEmailSpan.textContent = "Misafir";
            loginBtn.classList.remove("hidden");
            logoutBtn.classList.add("hidden");
            cartCountBadge.classList.add('hidden');
        }
    });

    loginBtn.onclick = () => signInWithPopup(auth, provider).catch(e => showMsg(e.message, true));
    logoutBtn.onclick = () => signOut(auth).then(() => window.location.reload());

    // --- NAVIGASYON VE ROUTING ---
    window.navigate = (path) => {
        location.hash = path === '/' ? '' : path;
        renderPage();
    };

    function getRouteParams() {
        const hash = window.location.hash.substring(1);
        if (hash.startsWith('/detail')) return { view: 'detail', id: new URLSearchParams(hash.split('?')[1]).get('id') };
        if (hash.startsWith('/category')) {
            currentActiveCategory = new URLSearchParams(hash.split('?')[1]).get('name') || 'all';
            return { view: 'home', id: null };
        }
        return { view: 'home', id: null };
    }

    // --- KATEGORİ AKORDİYON SİSTEMİ (Orijinal Mantık) ---
    window.toggleCategoryAccordion = function(element, isLeaf, name) {
        if (isLeaf) {
            handleCategorySelect(name);
            if (window.innerWidth < 1024) toggleMobileMenu();
            return;
        }
        const parentLi = element.closest('li');
        const childUl = parentLi.querySelector('.category-children');
        const icon = element.querySelector('.toggle-icon');
        if (childUl) {
            childUl.classList.toggle('hidden');
            icon.classList.toggle('rotated');
        }
    }

    window.toggleMobileMenu = () => {
        const m = document.getElementById("mobile-menu");
        const o = document.getElementById("mobile-menu-overlay");
        const isOpen = m.classList.contains('translate-x-0');
        if (isOpen) {
            m.classList.replace('translate-x-0', '-translate-x-full');
            o.classList.add('hidden'); o.classList.replace('opacity-100', 'opacity-0');
        } else {
            m.classList.replace('-translate-x-full', 'translate-x-0');
            o.classList.remove('hidden'); setTimeout(() => o.classList.replace('opacity-0', 'opacity-100'), 10);
        }
    };

    // --- ANA RENDER DÖNGÜSÜ ---
    function renderPage() {
        if (autoSlideInterval) clearInterval(autoSlideInterval);
        const { view, id } = getRouteParams();
        heroSection.style.display = view === 'home' ? 'block' : 'none';
        appContainer.innerHTML = '';
        
        if (!productsLoaded) {
            appContainer.innerHTML = '<div class="py-40 text-center"><div class="inline-block w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div><p class="mt-4 text-gray-500 font-bold">Veriler Getiriliyor...</p></div>';
            return;
        }

        if (view === 'detail' && id) renderDetailPage(id);
        else renderHomePage();
        
        if (view === 'home') renderHeroSection();
        window.scrollTo(0,0);
    }

    // --- ANASAYFA & ÜRÜN KARTLARI ---
    function renderHomePage() {
        appContainer.innerHTML = `
            <div class="max-w-7xl mx-auto p-4 sm:p-8 flex flex-col lg:flex-row gap-8">
                <aside class="lg:w-72 hidden lg:block">
                    <div class="bg-white p-6 rounded-2xl shadow-xl shadow-gray-200/50 sticky top-28 border border-gray-100">
                        <h2 class="text-xl font-black text-gray-800 mb-6 border-b pb-3 flex items-center gap-2"><i class="ri-apps-2-line text-primary"></i> Kategoriler</h2>
                        <div id="category-menu-desktop" class="space-y-1"></div>
                    </div>
                </aside>
                <div class="flex-grow">
                    <div class="relative mb-8 group">
                        <input type="text" id="product-search-input" placeholder="Binlerce ürün arasından ara..." 
                               class="w-full p-4 pl-12 bg-white border-2 border-transparent rounded-2xl shadow-lg shadow-gray-200/50 focus:border-primary focus:ring-0 transition-all text-lg"
                               oninput="handleSearch(event)" value="${currentSearchTerm}">
                        <i class="ri-search-eye-line absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl group-focus-within:text-primary transition-colors"></i>
                    </div>
                    <div id="products-list-container"></div>
                </div>
            </div>
        `;
        renderCategoryMenu();
        filterAndRenderProducts();
    }

    window.handleSearch = (e) => {
        currentSearchTerm = e.target.value.toLowerCase();
        filterAndRenderProducts();
    };

    function filterAndRenderProducts() {
        const container = document.getElementById('products-list-container');
        let filtered = allProducts;
        if (currentActiveCategory !== 'all') {
            filtered = allProducts.filter(p => p.hierarchy && p.hierarchy.includes(currentActiveCategory));
        }
        if (currentSearchTerm) {
            filtered = filtered.filter(p => p.name.toLowerCase().includes(currentSearchTerm) || (p.description && p.description.toLowerCase().includes(currentSearchTerm)));
        }
        
        container.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6" id="products-grid">
            ${filtered.map(p => `
                <div class="product-card bg-white p-4 rounded-3xl shadow-md border border-gray-50 flex flex-col cursor-pointer relative overflow-hidden" onclick="navigate('/detail?id=${p.id}')">
                    ${p.old_price > p.price ? `<div class="absolute top-3 left-3 bg-red-500 text-white text-[10px] font-black px-2 py-1 rounded-lg z-10 shadow-lg">İNDİRİM</div>` : ''}
                    <div class="h-36 sm:h-44 flex items-center justify-center bg-gray-50 rounded-2xl p-4 mb-4">
                        <img src="${p.image}" class="max-h-full object-contain" onerror="this.src='https://placehold.co/200'">
                    </div>
                    <h3 class="font-bold text-gray-800 text-sm sm:text-base line-clamp-1 mb-1">${p.name}</h3>
                    <p class="text-xs text-gray-400 mb-3 line-clamp-2">${p.description || ''}</p>
                    <div class="mt-auto pt-3 border-t flex justify-between items-center">
                        <div class="flex flex-col">
                            ${p.old_price > p.price ? `<span class="text-[10px] text-gray-400 line-through">${p.old_price.toFixed(2)} ₺</span>` : ''}
                            <span class="text-primary font-black text-lg">${p.price.toFixed(2)} ₺</span>
                        </div>
                        <button onclick="event.stopPropagation(); handleAddToCart(event)" data-id="${p.id}" class="bg-getir-yellow text-primary w-10 h-10 rounded-xl flex items-center justify-center hover:scale-110 transition-transform shadow-lg shadow-getir-yellow/20">
                            <i class="ri-add-fill ri-xl"></i>
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>`;
    }

    // --- DETAY SAYFASI & GELİŞMİŞ MEDYA ---
    function renderDetailPage(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return navigate('/');

        currentCalculatedPrice = parseFloat(product.price);
        const images = [product.image, ...(product.extraImages || [])].filter(Boolean);
        const videos = product.video ? [product.video] : [];

        appContainer.innerHTML = `
            <div class="max-w-7xl mx-auto p-4 sm:p-8">
                <button onclick="navigate('/')" class="mb-8 flex items-center gap-2 text-primary font-black hover:gap-4 transition-all"><i class="ri-arrow-left-s-line ri-xl"></i> ALIŞVERİŞE DEVAM ET</button>
                <div class="bg-white p-6 md:p-12 rounded-[2.5rem] shadow-2xl shadow-gray-200/50 flex flex-col lg:flex-row gap-12 border border-gray-50">
                    <div class="lg:w-1/2">
                        <div id="main-media-display" class="aspect-square rounded-3xl overflow-hidden bg-gray-50 border-2 border-gray-50 flex items-center justify-center mb-6 shadow-inner"></div>
                        <div id="thumbnail-gallery" class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide"></div>
                    </div>
                    <div class="lg:w-1/2 flex flex-col">
                        <nav class="flex gap-2 text-[10px] font-black uppercase tracking-widest text-primary/50 mb-4">
                            ${(product.hierarchy || []).map(h => `<span>${h}</span>`).join('<i class="ri-arrow-right-s-line"></i>')}
                        </nav>
                        <h1 class="text-3xl sm:text-5xl font-black text-gray-900 leading-tight mb-4">${product.name}</h1>
                        <p class="text-gray-500 text-lg mb-8 leading-relaxed">${product.description || 'Bu ürün Kıbrıs stoklarımızda mevcuttur.'}</p>
                        
                        <div class="bg-primary/5 p-8 rounded-3xl border-2 border-primary/10 mb-8">
                            <div class="flex items-baseline gap-4">
                                <span id="dynamic-price" class="text-4xl sm:text-6xl font-black text-primary">${currentCalculatedPrice.toFixed(2)} ₺</span>
                                ${product.old_price > product.price ? `<span class="text-xl text-gray-400 line-through">${product.old_price.toFixed(2)} ₺</span>` : ''}
                            </div>
                            <p class="text-xs text-primary/60 font-bold mt-2 italic">* Gümrük ve komisyon dahil tahmini kapı teslim fiyattır.</p>
                        </div>

                        <div id="variant-area" class="mb-8"></div>
                        
                        <button data-id="${product.id}" onclick="handleAddToCart(event, currentSelectedVariant, currentCalculatedPrice)" 
                                class="w-full bg-getir-yellow text-primary py-5 rounded-2xl font-black text-xl shadow-xl shadow-getir-yellow/30 hover:translate-y-[-2px] active:translate-y-[1px] transition-all flex items-center justify-center gap-3">
                            <i class="ri-shopping-basket-line ri-xl"></i> SEPETE EKLE
                        </button>
                    </div>
                </div>
                <div class="mt-20">
                    <h3 class="text-3xl font-black text-gray-800 mb-8 flex items-center gap-3"><span class="w-2 h-8 bg-primary rounded-full"></span> Sizin İçin Seçtiklerimiz</h3>
                    <div id="related-products-container"></div>
                </div>
            </div>
        `;
        initMediaGallery(product.name, images, videos);
        if (product.variants?.length) renderVariants(product);
        renderRelated(product);
    }

    function initMediaGallery(name, imgs, vids) {
        const main = document.getElementById('main-media-display');
        const gallery = document.getElementById('thumbnail-gallery');
        const media = [...imgs.map(u => ({u, t:'i'})), ...vids.map(u => ({u, t:'v'}))];
        
        const setMain = (m) => {
            if(m.t === 'i') main.innerHTML = `<img src="${m.u}" class="max-h-full object-contain p-8">`;
            else {
                const id = m.u.split('v=')[1] || m.u.split('/').pop();
                main.innerHTML = `<div class="video-container"><iframe src="https://www.youtube.com/embed/${id}?autoplay=1&mute=1" allowfullscreen></iframe></div>`;
            }
        };

        setMain(media[0]);
        gallery.innerHTML = media.map((m, i) => `
            <div onclick="updateMain(this, '${m.u}', '${m.t}')" class="w-20 h-20 border-4 rounded-2xl overflow-hidden cursor-pointer flex-shrink-0 transition-all ${i===0?'border-primary scale-105':'border-transparent opacity-60 hover:opacity-100'}">
                <img src="${m.t==='i'?m.u:'https://placehold.co/100x100/5D3EBC/FFFFFF?text=VIDEO'}" class="w-full h-full object-cover">
            </div>
        `).join('');

        window.updateMain = (el, u, t) => {
            document.querySelectorAll('#thumbnail-gallery > div').forEach(d => d.className = "w-20 h-20 border-4 border-transparent rounded-2xl overflow-hidden cursor-pointer flex-shrink-0 transition-all opacity-60 hover:opacity-100");
            el.className = "w-20 h-20 border-4 border-primary rounded-2xl overflow-hidden cursor-pointer flex-shrink-0 transition-all scale-105";
            setMain({u, t});
        };
    }

    // --- SEPETE EKLEME MANTIĞI (Admin Panelindeki Beklenen Şema) ---
    window.handleAddToCart = async (event, selectedVariant = null, calculatedPrice = null) => {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return showMsg("Lütfen Google ile giriş yapın!", true);

        const btn = event.currentTarget;
        const productId = btn.dataset.id;
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        btn.disabled = true;
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="ri-loader-4-line animate-spin ri-xl"></i>';

        const price = calculatedPrice || product.price;
        const variantName = selectedVariant?.name || 'Standart';
        const docId = `${productId}_${variantName.replace(/\s/g,'_')}`;

        try {
            await setDoc(doc(db, "users", user.uid, "cart", docId), {
                userId: user.uid,
                productName: product.name,
                productPrice: price,
                variant: variantName,
                baseProductId: productId,
                quantity: 1,
                image: product.image,
                addedAt: new Date()
            }, { merge: true });
            showMsg(`"${product.name}" sepete eklendi! ✨`);
        } catch (e) { showMsg(e.message, true); }
        finally { btn.disabled = false; btn.innerHTML = original; }
    };

    // --- VERİ ÇEKME (Firebase Admin Panel Entegrasyonu) ---
    async function loadProducts() {
        try {
            const [cSnap, pSnap, bSnap] = await Promise.all([
                getDocs(collection(db, "homeCategories")),
                getDocs(collection(db, "homeProducts")),
                getDocs(collection(db, "homeBanners"))
            ]);

            cSnap.forEach(d => {
                const data = d.data();
                allCategories[data.name] = { id: d.id, ...data };
            });

            allProducts = pSnap.docs.map(d => ({ 
                id: d.id, 
                ...d.data(), 
                price: parseFloat(d.data().price) || 0,
                old_price: parseFloat(d.data().old_price) || 0
            })).filter(p => p.active);

            allBanners = bSnap.docs.map(d => d.data());
            
            productsLoaded = true;
            renderPage();
        } catch (e) { showMsg("Sistem yüklenirken hata oluştu.", true); }
    }

    // Kategori Menüsü Oluşturucu
    function renderCategoryMenu() {
        const roots = Object.values(allCategories).filter(c => !c.parent).sort((a,b) => a.name.localeCompare(b.name));
        const menuHtml = `
            <button onclick="handleCategorySelect('all')" class="w-full flex items-center gap-3 p-3 rounded-xl text-sm font-black transition-all ${currentActiveCategory === 'all' ? 'bg-primary text-white' : 'text-gray-600 hover:bg-gray-100'}">
                <i class="ri-grid-fill"></i> Tüm Ürünler
            </button>
            <ul class="mt-2 space-y-1">
                ${roots.map(cat => renderCategoryItem(cat)).join('')}
            </ul>
        `;
        document.getElementById('category-menu-desktop').innerHTML = menuHtml;
        document.getElementById('mobile-category-menu').innerHTML = menuHtml;
    }

    function renderCategoryItem(cat, level = 0) {
        const children = Object.values(allCategories).filter(c => c.parent === cat.name);
        const hasChildren = children.length > 0;
        const isActive = currentActiveCategory === cat.name;

        return `
            <li>
                <button onclick="toggleCategoryAccordion(this, ${!hasChildren}, '${cat.name}')" 
                        class="category-link w-full flex items-center justify-between p-2 rounded-xl text-sm transition-all ${isActive?'active':'text-gray-500 hover:bg-gray-50'}"
                        style="padding-left: ${level * 12 + 8}px">
                    <span class="flex items-center gap-2">
                        ${cat.image ? `<img src="${cat.image}" class="category-thumb">` : ''}
                        ${cat.name}
                    </span>
                    ${hasChildren ? `<i class="ri-arrow-right-s-line toggle-icon ${isActive?'rotated':''}"></i>` : ''}
                </button>
                ${hasChildren ? `<ul class="category-children ${isActive?'':'hidden'} ml-2 border-l-2 border-gray-100 mt-1 mb-2">${children.map(c => renderCategoryItem(c, level + 1)).join('')}</ul>` : ''}
            </li>
        `;
    }

    window.handleCategorySelect = (name) => {
        currentActiveCategory = name;
        navigate(`/category?name=${name}`);
    };

    function renderHeroSection() {
        if (!allBanners.length) return;
        heroSection.innerHTML = `
            <div class="max-w-7xl mx-auto px-4 py-8">
                <div class="carousel-container shadow-2xl shadow-primary/10 border-4 border-white">
                    <div id="carousel-wrapper" class="carousel-wrapper">
                        ${allBanners.map(b => `
                            <div class="carousel-slide">
                                <a href="${b.link || '#'}" class="banner-content relative group">
                                    <img src="${b.url}" class="banner-image-contain">
                                    <div class="absolute inset-0 bg-gradient-to-r from-primary/80 to-transparent flex items-center p-12 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <div class="text-white">
                                            <h2 class="text-4xl font-black mb-2">${b.title || ''}</h2>
                                            <p class="text-lg opacity-90">${b.description || ''}</p>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        totalSlides = allBanners.length;
        carouselWrapper = document.getElementById('carousel-wrapper');
        autoSlideInterval = setInterval(() => {
            currentSlide = (currentSlide + 1) % totalSlides;
            if(carouselWrapper) carouselWrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        }, 5000);
    }

    function renderRelated(curr) {
        const related = allProducts.filter(p => p.category === curr.category && p.id !== curr.id).slice(0, 10);
        const container = document.getElementById('related-products-container');
        if(!related.length) return container.innerHTML = '<p class="text-gray-400 font-bold">Bu kategoride başka ürün bulunamadı.</p>';
        container.innerHTML = `<div class="related-products-scroll">${related.map(p => `
            <a href="#/detail?id=${p.id}" class="product-card bg-white p-4 rounded-[2rem] shadow-lg border border-gray-100 block">
                <div class="h-32 bg-gray-50 rounded-2xl p-4 flex items-center justify-center mb-3"><img src="${p.image}" class="max-h-full object-contain"></div>
                <h4 class="font-bold text-gray-800 truncate">${p.name}</h4>
                <p class="text-primary font-black mt-1">${p.price.toFixed(2)} ₺</p>
            </a>
        `).join('')}</div>`;
    }

    loadProducts();
</script>
</body>
</html>
