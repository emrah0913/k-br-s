<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Getir Home | Getir KÄ±brÄ±s</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow p-4">
Â  <div class="max-w-6xl mx-auto flex items-center justify-between">
Â  Â  <h1 class="text-xl font-bold text-blue-700">Getir Home</h1>
Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  <span id="user-email" class="text-gray-600"></span>
Â  Â  Â  <button id="loginBtn" class="bg-blue-600 text-white px-3 py-1 rounded">GiriÅŸ Yap</button>
Â  Â  Â  <button id="logoutBtn" class="bg-red-600 text-white px-3 py-1 rounded hidden">Ã‡Ä±kÄ±ÅŸ Yap</button>
      <a href="/sepet.html" class="bg-yellow-500 text-white px-3 py-1 rounded font-semibold flex items-center gap-1">
        ðŸ›’ Sepet
      </a>
Â  Â  </div>
Â  </div>
</header>

<main class="max-w-6xl mx-auto p-6">
Â  <h2 class="text-2xl font-semibold mb-4">ÃœrÃ¼nler</h2>
Â  <div id="products" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</main>

<div id="msg" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded hidden"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
// doc ve setDoc, sepete ekleme iÅŸlemini basitleÅŸtirmek iÃ§in eklendi.
import { getFirestore, collection, getDocs, setDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
Â  authDomain: "kibris-6b4f7.firebaseapp.com",
Â  projectId: "kibris-6b4f7",
Â  storageBucket: "kibris-6b4f7.appspot.com",
Â  messagingSenderId: "141262926171",
Â  appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
Â  measurementId: "G-JL9P6BRZTD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userEmailSpan = document.getElementById("user-email");
const productsDiv = document.getElementById("products");
const msgDiv = document.getElementById("msg");

function showMsg(text, isError=false){
Â  msgDiv.textContent=text;
Â  msgDiv.className = `fixed bottom-4 right-4 px-4 py-2 rounded ${isError ? 'bg-red-600' : 'bg-green-600'}`;
Â  msgDiv.classList.remove("hidden");
Â  setTimeout(()=>msgDiv.classList.add("hidden"),3000);
}

// --- AUTH ---
loginBtn.addEventListener("click", async ()=>{Â 
Â  try{ await signInWithPopup(auth,provider); }Â 
Â  catch(e){ showMsg("GiriÅŸ hatasÄ±: "+e.message, true); }Â 
});

logoutBtn.addEventListener("click", async ()=>{Â 
Â  await signOut(auth);Â 
});

onAuthStateChanged(auth, user=>{
Â  if(user){
Â  Â  userEmailSpan.textContent=user.email;
Â  Â  loginBtn.classList.add("hidden");
Â  Â  logoutBtn.classList.remove("hidden");
Â  }else{
Â  Â  userEmailSpan.textContent="";
Â  Â  loginBtn.classList.remove("hidden");
Â  Â  logoutBtn.classList.add("hidden");
Â  }
});

// --- Load products from Firestore ---
async function loadProducts(){
Â  productsDiv.innerHTML="YÃ¼kleniyor...";
  // KRÄ°TÄ°K DÃœZELTME: "products" yerine "homeProducts" kullanÄ±ldÄ±
Â  const snap = await getDocs(collection(db,"homeProducts"));
Â  productsDiv.innerHTML="";

  if (snap.empty) {
    productsDiv.innerHTML = "<p class='text-gray-500'>Listelenecek aktif Ã¼rÃ¼n bulunamadÄ±.</p>";
    return;
  }
  
Â  snap.forEach(docSnap=>{
Â  Â  const d = docSnap.data();
Â  Â  if(!d.active) return; // sadece aktif Ã¼rÃ¼nleri gÃ¶ster
Â  Â  const card = document.createElement("div");
Â  Â  card.className="bg-white p-4 rounded shadow flex flex-col";
Â  Â  card.innerHTML=`
Â  Â  Â  <img src="${d.image}" class="w-full h-48 object-cover mb-2 rounded"/>
Â  Â  Â  <h3 class="font-semibold text-lg">${d.name}</h3>
Â  Â  Â  <p class="text-gray-600 mb-2">${d.description||""}</p>
Â  Â  Â  <div class="font-bold text-blue-700 mb-2">${d.price} â‚º</div>
Â  Â  Â  <button class="bg-green-600 text-white px-3 py-1 rounded">Sepete Ekle</button>
Â  Â  `;
Â  Â  const btn = card.querySelector("button");
Â  Â  // Sepete ekleme iÅŸlevi dÃ¼zeltildi: `carts` koleksiyonu yerine `users/{userId}/cart` alt koleksiyonu kullanÄ±ldÄ±
    // Bu, gÃ¼venlik kurallarÄ±na uyum iÃ§in en iyi yoldur.
Â  Â  btn.addEventListener("click", async ()=>{
Â  Â  Â  const user = auth.currentUser;
Â  Â  Â  if(!user){ showMsg("Sepete eklemek iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z!", true); return;}
Â  Â  Â  
      try{
        // Sepet Ã¶ÄŸesi referansÄ±: users/{userId}/cart/{productId}
        const itemRef = doc(db, "users", user.uid, "cart", docSnap.id);
        
        // Yeni bir Ã¼rÃ¼n ekliyor veya miktarÄ±nÄ± 1 artÄ±rÄ±yoruz (VarsayÄ±m: Her tÄ±klama +1 miktar ekler)
        // SetDoc kullanÄ±larak, Ã¼rÃ¼n ID'si sepet dokÃ¼man ID'si olarak ayarlandÄ±.
Â  Â  Â  Â  await setDoc(itemRef, {
Â  Â  Â  Â  Â  userId:user.uid,
Â  Â  Â  Â  Â  productId:docSnap.id,
Â  Â  Â  Â  Â  name:d.name,
Â  Â  Â  Â  Â  price:d.price,
Â  Â  Â  Â  Â  image:d.image,
Â  Â  Â  Â  Â  quantity: 1, // Basitlik iÃ§in her zaman 1 olarak ekleniyor. Sepet.html'de miktar artÄ±ÅŸÄ± yapÄ±labilir.
Â  Â  Â  Â  Â  addedAt:new Date()
Â  Â  Â  Â  }, { merge: true }); // merge: true ile sadece miktar ve tarih alanlarÄ±nÄ± gÃ¼ncelleyebilirsiniz.
Â  Â  Â  Â  
Â  Â  Â  Â  showMsg("ÃœrÃ¼n sepete eklendi!");
Â  Â  Â  }catch(e){ showMsg("Hata: "+e.message, true);}
Â  Â  });
Â  Â  productsDiv.appendChild(card);
Â  });
}

// BaÅŸlangÄ±Ã§ta Ã¼rÃ¼nleri yÃ¼kle
loadProducts();
</script>
</body>
</html>
