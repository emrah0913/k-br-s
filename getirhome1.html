<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title id="page-title">Getir Home - Anasayfa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D3EBC',
                        secondary: '#FFD300',
                        'getir-yellow': '#FFD300',
                    },
                    fontFamily: { inter: ['Inter', 'sans-serif'] },
                },
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        #products-grid .product-card { transition: all 0.2s; }
        #products-grid .product-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05); }
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; }
        .video-container iframe, .video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        .carousel-container { position: relative; overflow: hidden; height: auto; }
        .carousel-wrapper { display: flex; transition: transform 0.5s ease-in-out; width: 100%; }
        .carousel-slide { flex: 0 0 100%; min-width: 100%; }
        .banner-content { height: auto; min-height: 200px; display: flex; align-items: center; justify-content: center; background-color: #5D3EBC; }
        .banner-image-contain { width: 100%; height: auto; max-height: 480px; object-fit: contain; }
        .variant-button.active { border-color: #5D3EBC; box-shadow: 0 0 0 3px #5D3EBC40; }
        .category-link.active { background-color: #5D3EBC10; color: #5D3EBC; font-weight: 600; }
        .ri-arrow-right-s-line.rotated { transform: rotate(90deg); }
        .toggle-icon { transition: transform 0.2s ease-in-out; }
        .category-thumb { width: 20px; height: 20px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .related-products-scroll { display: flex; overflow-x: scroll; scroll-snap-type: x mandatory; padding-bottom: 10px; }
        .related-products-scroll > a { flex: 0 0 auto; width: 180px; margin-right: 16px; scroll-snap-align: start; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-[90] hidden opacity-0" onclick="toggleMobileMenu()"></div>
<div id="mobile-menu" class="fixed top-0 left-0 w-64 h-full bg-white z-[100] shadow-2xl transform -translate-x-full overflow-y-auto p-4">
    <div class="flex justify-between items-center mb-4 pb-2 border-b">
        <h3 class="text-xl font-bold text-primary">Kategoriler</h3>
        <button onclick="toggleMobileMenu()" class="text-gray-500 hover:text-gray-700"><i class="ri-close-line ri-lg"></i></button>
    </div>
    <div id="mobile-category-menu"></div>
</div>

<header class="sticky top-0 w-full bg-white shadow-md z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <button id="menu-toggle-btn" onclick="toggleMobileMenu()" class="lg:hidden text-primary p-2 mr-2"><i class="ri-menu-line ri-xl"></i></button>

        <div class="flex items-center space-x-3 sm:space-x-8">
            <a href="index.html" class="flex items-center opacity-60 hover:opacity-100 transition-opacity">
                <img src="getirkibris-logo.png" alt="Logo" class="h-10 sm:h-10 w-auto object-contain" onerror="this.src='https://placehold.co/150x40/5D3EBC/FFFFFF?text=getirkıbrıs'">
            </a>
            <div class="h-8 w-px bg-gray-200"></div>
            <a href="#" onclick="navigate('/')" class="flex items-center group">
                <img src="getirhome-logo.png" alt="Logo" class="h-10 sm:h-12 w-auto object-contain transition-transform group-hover:scale-105" onerror="this.src='https://placehold.co/150x40/5D3EBC/FFD300?text=getirhome'">
            </a>
        </div>
        
        <div class="flex items-center gap-2 sm:gap-4">
            <a href="/sepet.html" class="relative bg-primary hover:bg-primary/90 text-white px-3 py-1 sm:px-4 sm:py-2 rounded-lg font-semibold flex items-center gap-1 sm:gap-2 transition-colors text-sm">
                <i class="ri-shopping-cart-2-fill text-base sm:text-lg"></i> 
                <span class="hidden sm:inline">Sepetim</span>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center hidden border-2 border-white font-bold">0</span>
            </a>
            <div class="h-6 sm:h-8 w-px bg-gray-200"></div> 
            <div id="auth-area" class="flex items-center gap-3">
                <div id="user-display" class="flex items-center gap-2">
                    <span id="user-email" class="text-xs sm:text-sm font-medium text-gray-600 truncate max-w-[120px]">Misafir</span>
                </div>
                <button id="loginBtn" class="text-primary hover:text-primary/80 font-semibold text-sm">Giriş</button>
                <button id="logoutBtn" class="text-red-500 hover:text-red-700 font-semibold hidden text-sm">Çıkış</button>
            </div>
        </div>
    </div>
</header>

<section id="hero-section" class="bg-primary/90 text-white"></section>
<main id="app-container"></main>
<div id="msg" class="fixed bottom-4 right-4 z-[100] px-4 py-2 rounded-lg text-white font-medium shadow-xl hidden transition-all duration-300"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, setDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
        authDomain: "kibris-6b4f7.firebaseapp.com",
        projectId: "kibris-6b4f7",
        storageBucket: "kibris-6b4f7.appspot.com",
        messagingSenderId: "141262926171",
        appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
        measurementId: "G-JL9P6BRZTD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Elements & State
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userEmailSpan = document.getElementById("user-email");
    const appContainer = document.getElementById("app-container"); 
    const heroSection = document.getElementById("hero-section");
    const msgDiv = document.getElementById("msg");
    const cartCountBadge = document.getElementById("cart-count");

    let allProducts = [], allCategories = {}, allBanners = [], productsLoaded = false;
    let currentActiveCategory = 'all', currentSearchTerm = '', currentCalculatedPrice = 0, currentSelectedVariant = null;
    let currentSlide = 0, carouselWrapper, totalSlides, autoSlideInterval;

    // --- Mesaj ---
    function showMsg(text, isError=false){
        msgDiv.textContent=text;
        msgDiv.className = `fixed bottom-4 right-4 z-[100] px-4 py-2 rounded-lg text-white font-medium shadow-xl transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        msgDiv.classList.remove("hidden");
        setTimeout(()=>msgDiv.classList.add("hidden"),3000);
    }

    // --- Sepet Takibi ---
    function listenToCart(user) {
        if (!user) return;
        onSnapshot(collection(db, "users", user.uid, "cart"), (snapshot) => {
            let total = 0;
            snapshot.forEach(d => total += (d.data().quantity || 1));
            cartCountBadge.textContent = total;
            total > 0 ? cartCountBadge.classList.remove('hidden') : cartCountBadge.classList.add('hidden');
        });
    }

    // --- Auth & Profil ---
    onAuthStateChanged(auth, (user) => {
        if (user && !user.isAnonymous) {
            const photo = user.photoURL ? `<img src="${user.photoURL}" class="w-6 h-6 rounded-full border border-primary">` : '<i class="ri-user-line"></i>';
            userEmailSpan.innerHTML = `<div class="flex items-center gap-2">${photo} <span>${user.displayName || user.email.split('@')[0]}</span></div>`;
            loginBtn.classList.add("hidden");
            logoutBtn.classList.remove("hidden");
            listenToCart(user);
        } else {
            userEmailSpan.textContent = "Misafir";
            loginBtn.classList.remove("hidden");
            logoutBtn.classList.add("hidden");
            cartCountBadge.classList.add('hidden');
        }
    });

    loginBtn.onclick = () => signInWithPopup(auth, provider).catch(e => showMsg(e.message, true));
    logoutBtn.onclick = () => signOut(auth).then(() => window.location.reload());

    // --- Navigate & Route ---
    window.navigate = (path) => {
        location.hash = path === '/' ? '' : path;
        renderPage();
    };
    window.onhashchange = renderPage;

    function getRouteParams() {
        const hash = window.location.hash.substring(1);
        if (hash.startsWith('/detail')) return { view: 'detail', id: new URLSearchParams(hash.split('?')[1]).get('id') };
        if (hash.startsWith('/category')) {
            currentActiveCategory = new URLSearchParams(hash.split('?')[1]).get('name') || 'all';
            return { view: 'home', id: null };
        }
        return { view: 'home', id: null };
    }

    // --- HomePage Render ---
    function renderHomePage() {
        appContainer.innerHTML = `
            <div class="max-w-7xl mx-auto p-4 flex flex-col lg:flex-row gap-6">
                <aside class="lg:w-64 hidden lg:block">
                    <div class="bg-white p-4 rounded-xl shadow-lg sticky top-24">
                        <h2 class="font-bold text-gray-800 mb-4 border-b pb-2"><i class="ri-list-settings-line"></i> Kategoriler</h2>
                        <div id="category-menu-desktop" class="space-y-1"></div>
                    </div>
                </aside>
                <div class="flex-grow">
                    <div class="relative mb-6">
                        <input type="text" id="product-search-input" placeholder="Ürün ara..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary" oninput="handleSearch(event)">
                        <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div id="products-list-container"></div>
                </div>
            </div>
        `;
        renderCategoryMenu();
        filterAndRenderProducts();
    }

    window.handleSearch = (e) => {
        currentSearchTerm = e.target.value.toLowerCase();
        filterAndRenderProducts();
    };

    function filterAndRenderProducts() {
        const container = document.getElementById('products-list-container');
        let filtered = allProducts;
        if (currentActiveCategory !== 'all') filtered = filtered.filter(p => p.category === currentActiveCategory || (p.hierarchy && p.hierarchy.includes(currentActiveCategory)));
        if (currentSearchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(currentSearchTerm) || (p.description && p.description.toLowerCase().includes(currentSearchTerm)));
        renderProductCards(filtered, container);
    }

    function renderProductCards(products, container) {
        if (!container) return;
        container.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4" id="products-grid">
            ${products.map(p => `
                <div class="product-card bg-white p-3 rounded-xl shadow-lg flex flex-col cursor-pointer" onclick="navigate('/detail?id=${p.id}')">
                    <div class="h-32 flex items-center justify-center bg-gray-50 rounded-lg p-2 mb-2 overflow-hidden">
                        <img src="${p.image}" class="max-h-full transition-transform hover:scale-110" onerror="this.src='https://placehold.co/200'">
                    </div>
                    <h3 class="font-bold text-sm truncate text-gray-800">${p.name}</h3>
                    <div class="mt-auto pt-2 border-t flex justify-between items-center">
                        <span class="text-primary font-extrabold">${p.price.toFixed(2)} ₺</span>
                        <button onclick="event.stopPropagation(); handleAddToCart(event)" data-id="${p.id}" class="bg-getir-yellow text-primary p-2 rounded-lg hover:bg-yellow-400"><i class="ri-add-line"></i></button>
                    </div>
                </div>
            `).join('')}
        </div>`;
    }

    // --- Detay Sayfası & Medya Yönetimi ---
    function renderDetailPage(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return navigate('/');

        const initialPrice = parseFloat(product.price);
        currentCalculatedPrice = initialPrice;
        const baseImages = [product.image, ...(product.extraImages || [])].filter(Boolean);
        const baseVideos = product.video ? [product.video] : [];

        appContainer.innerHTML = `
            <div class="max-w-7xl mx-auto p-4">
                <button onclick="navigate('/')" class="text-primary font-bold mb-4 inline-flex items-center gap-2"><i class="ri-arrow-left-line"></i> Geri Dön</button>
                <div class="bg-white p-6 md:p-10 rounded-2xl shadow-xl flex flex-col lg:flex-row gap-10">
                    <div class="lg:w-1/2">
                        <div id="main-media-display" class="aspect-square rounded-xl overflow-hidden bg-gray-50 border flex items-center justify-center mb-4"></div>
                        <div id="thumbnail-gallery" class="flex gap-2 overflow-x-auto pb-2"></div>
                    </div>
                    <div class="lg:w-1/2">
                        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">${product.name}</h1>
                        <span class="text-xs font-bold text-primary uppercase">${product.category}</span>
                        <p class="text-gray-600 my-6 text-lg">${product.description || ''}</p>
                        <div class="bg-gray-50 p-6 rounded-xl border mb-6">
                            <span id="dynamic-price" class="text-3xl font-black text-primary">${initialPrice.toFixed(2)} ₺</span>
                        </div>
                        <div id="variant-area"></div>
                        <button data-id="${product.id}" onclick="handleAddToCart(event)" class="w-full bg-getir-yellow text-primary py-4 rounded-xl font-black text-xl shadow-lg hover:scale-[1.02] transition-transform">SEPETE EKLE</button>
                    </div>
                </div>
            </div>
        `;
        updateProductMedia(product.name, baseImages, baseVideos);
        if (product.variants && product.variants.length > 0) renderVariants(product);
    }

    function updateProductMedia(name, imgs, vids) {
        const main = document.getElementById('main-media-display');
        const gallery = document.getElementById('thumbnail-gallery');
        const media = [...imgs.map(u => ({u, t:'i'})), ...vids.map(u => ({u, t:'v'}))];
        
        const setMain = (m) => {
            if(m.t === 'i') main.innerHTML = `<img src="${m.u}" class="max-h-full object-contain">`;
            else main.innerHTML = `<div class="video-container"><iframe src="${getEmbedUrl(m.u)}" allowfullscreen></iframe></div>`;
        };

        setMain(media[0]);
        gallery.innerHTML = media.map((m, i) => `
            <div onclick="this.parentElement.dataset.idx=${i}" class="w-20 h-20 border-2 rounded-lg overflow-hidden cursor-pointer flex-shrink-0 ${i===0?'border-primary':''}">
                <img src="${m.t==='i'?m.u:'https://placehold.co/100x100?text=VIDEO'}" class="w-full h-full object-cover">
            </div>
        `).join('');

        gallery.querySelectorAll('div').forEach((div, i) => {
            div.onclick = () => {
                gallery.querySelectorAll('div').forEach(d => d.classList.remove('border-primary'));
                div.classList.add('border-primary');
                setMain(media[i]);
            };
        });
    }

    function getEmbedUrl(url) {
        const id = url.split('v=')[1] || url.split('/').pop();
        return `https://www.youtube.com/embed/${id.split('&')[0]}`;
    }

    // --- Sepete Ekleme İşlemi ---
    window.handleAddToCart = async (event, selectedVariant = null, calculatedPrice = null) => {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return showMsg("Lütfen giriş yapın!", true);

        const btn = event.currentTarget;
        const productId = btn.dataset.id;
        const product = allProducts.find(p => p.id === productId);
        const price = calculatedPrice || product.price;
        const variant = selectedVariant?.name || 'Standart';

        btn.disabled = true;
        try {
            await setDoc(doc(db, "users", user.uid, "cart", productId + '-' + variant.replace(/\s/g,'')), {
                productName: product.name,
                productPrice: price,
                variant: variant,
                quantity: 1,
                image: product.image,
                addedAt: new Date()
            }, { merge: true });
            showMsg("Ürün sepete eklendi!");
        } catch (e) { showMsg(e.message, true); }
        btn.disabled = false;
    };

    // --- Kategori & Banner Yükleme ---
    async function loadProducts() {
        try {
            const [pSnap, cSnap, bSnap] = await Promise.all([
                getDocs(collection(db, "homeProducts")),
                getDocs(collection(db, "homeCategories")),
                getDocs(collection(db, "homeBanners"))
            ]);
            allProducts = pSnap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => p.active);
            cSnap.forEach(d => allCategories[d.data().name] = d.data());
            allBanners = bSnap.docs.map(d => d.data());
            productsLoaded = true;
            renderPage();
        } catch (e) { showMsg("Veri yüklenemedi", true); }
    }

    function renderCategoryMenu() {
        const container = document.getElementById('category-menu-desktop');
        const cats = Object.values(allCategories).filter(c => !c.parent);
        container.innerHTML = `
            <button onclick="currentActiveCategory='all'; navigate('/');" class="w-full text-left p-2 rounded-lg text-sm ${currentActiveCategory==='all'?'bg-primary text-white':'hover:bg-gray-100'}">Tüm Ürünler</button>
            ${cats.map(c => `<button onclick="currentActiveCategory='${c.name}'; navigate('/category?name=${c.name}')" class="w-full text-left p-2 rounded-lg text-sm ${currentActiveCategory===c.name?'active':''} hover:bg-gray-50">${c.name}</button>`).join('')}
        `;
    }

    function renderHeroSection() {
        if (!allBanners.length) return;
        heroSection.innerHTML = `<div class="carousel-container"><div class="carousel-wrapper" id="carousel-wrapper">
            ${allBanners.map(b => `<div class="carousel-slide"><img src="${b.url}" class="banner-image-contain"></div>`).join('')}
        </div></div>`;
        totalSlides = allBanners.length;
        carouselWrapper = document.getElementById('carousel-wrapper');
        autoSlideInterval = setInterval(() => {
            currentSlide = (currentSlide + 1) % totalSlides;
            if(carouselWrapper) carouselWrapper.style.transform = `translateX(-${currentSlide*100}%)`;
        }, 5000);
    }

    function renderPage() {
        if(autoSlideInterval) clearInterval(autoSlideInterval);
        const { view, id } = getRouteParams();
        heroSection.style.display = view === 'home' ? 'block' : 'none';
        appContainer.innerHTML = '';
        if (!productsLoaded) return appContainer.innerHTML = '<div class="py-20 text-center">Yükleniyor...</div>';
        view === 'detail' ? renderDetailPage(id) : renderHomePage();
        if (view === 'home') renderHeroSection();
    }

    window.toggleMobileMenu = () => {
        document.getElementById('mobile-menu').classList.toggle('-translate-x-full');
        document.getElementById('mobile-menu-overlay').classList.toggle('hidden');
    };

    loadProducts();
</script>
</body>
</html>
