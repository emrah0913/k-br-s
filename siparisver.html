<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sipariş Ver - Getir Kıbrıs</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --primary: #0094da;
      --accent: #ffcb05;
      --dark: #232323;
      --light-bg: #f7fafc;
      --white: #fff;
      --gray: #ececec;
      --radius: 16px;
      --shadow: 0 4px 24px rgba(0,0,0,0.07);
    }
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      background: var(--light-bg);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      width: 100%;
      max-width: 1080px;
      margin: 0 auto;
      padding: 24px 16px 0 16px;
      box-sizing: border-box;
      flex: 1;
    }
    .header-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 12px 16px 0 16px;
      gap: 16px;
    }
    .profile-img {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
      background: var(--gray);
    }
    .btn {
      padding: 8px 18px;
      border-radius: var(--radius);
      border: none;
      font-weight: 600;
      background: var(--primary);
      color: var(--white);
      font-size: 1rem;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: background .15s;
    }
    .btn:hover { background: #007dc1; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .logo-wrap {
      display: flex;
      justify-content: center;
      margin-top: 0;
      margin-bottom: 12px;
    }
    .logo {
      max-width: 90px;
      width: 18vw;
      min-width: 56px;
      height: auto;
      display: block;
    }
    .nav-btn-row {
      display: flex;
      justify-content: center;
      gap: 14px;
      margin: 24px 0 12px 0;
      flex-wrap: wrap;
    }
    .nav-btn {
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      background: var(--accent);
      color: var(--dark);
      padding: 13px 28px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: background .17s;
      min-width: 128px;
    }
    .nav-btn:hover { background: #ffe780; }
    .nav-btn:disabled { opacity: .5; cursor: not-allowed; }
    .calc-module {
      margin: 0 auto 24px auto;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 480px;
      padding: 28px 24px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .calc-title {
      font-size: 1.3rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 12px;
      color: var(--primary);
    }
    .form-row {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .form-row label {
      font-size: .95rem;
      font-weight: 500;
      margin-bottom: 1px;
    }
    .form-row input, .form-row select, .form-row textarea {
      padding: 8px;
      border-radius: 8px;
      border: 1.2px solid var(--gray);
      font-size: 1rem;
      background: var(--light-bg);
    }
    .form-row textarea {
      min-height: 40px;
      resize: vertical;
    }
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      align-items: center;
      justify-content: flex-end;
    }
    .result-info {
      background: #eafdff;
      border-radius: 7px;
      margin-top: 10px;
      padding: 12px;
      color: #1880a7;
      font-weight: 600;
      text-align: center;
      font-size: 1.1rem;
    }
    .success-info {
      background: #e1f8e7;
      border-radius: 7px;
      margin-top: 10px;
      padding: 12px;
      color: #24a85c;
      font-weight: 600;
      text-align: center;
      font-size: 1.07rem;
    }
    .error-info {
      background: #ffeaea;
      color: #d32f2f;
      font-weight: 600;
      border-radius: 7px;
      margin-top: 10px;
      padding: 10px;
      text-align: center;
      font-size: 1.07rem;
    }
    @media (max-width: 700px) {
      .nav-btn-row { gap: 7px; }
      .calc-module { padding: 22px 6vw 12px 6vw; }
      .container { max-width: 99vw; }
      .logo { max-width: 60px; }
    }
    @media (max-width: 470px) {
      .header-bar { padding: 10px 4px 0 4px; }
      .logo-wrap { margin-bottom: 5px; }
      .nav-btn { font-size: .94rem; min-width: 0; padding: 9px 8px; }
      .calc-module { padding: 12px 2vw 8px 2vw; }
      .calc-title { font-size: 1.07rem; }
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <button id="loginBtn" class="btn" style="display:none;">Google ile Giriş Yap</button>
    <img id="profileImg" class="profile-img" alt="Profil" style="display:none;">
    <button id="logoutBtn" class="btn" style="display:none;background:#e74c3c;">Çıkış Yap</button>
  </div>
  <div class="logo-wrap">
    <img src="https://getirkibris.com/logo.png" alt="Getir Kıbrıs Logo" class="logo">
  </div>
  <div class="container">
    <div class="nav-btn-row">
      <button class="nav-btn" onclick="goPageOrWarn('index.html')">Ana Sayfa</button>
      <button class="nav-btn" onclick="scrollToCalc()">Hesapla</button>
      <button class="nav-btn" onclick="goPageOrWarn('siparislerim.html')">Siparişlerim</button>
      <button class="nav-btn" onclick="goPageOrWarn('kargotakip.html')">Kargo Takip</button>
    </div>
    <form class="calc-module" id="calcForm" autocomplete="off">
      <div class="calc-title">Sipariş ve Hesaplama Modülü</div>
      <!-- EKLENEN ALANLAR: Ad Soyad ve Telefon -->
      <div class="form-row">
        <label for="adSoyad">Ad Soyad</label>
        <input type="text" id="adSoyad" placeholder="Ad Soyad" required>
      </div>
      <div class="form-row">
        <label for="telefon">Telefon</label>
        <input type="tel" id="telefon" placeholder="Telefon" required>
      </div>
      <!-- /EKLENEN ALANLAR -->
      <div class="form-row">
        <label for="urunLinki">Ürün Linki</label>
        <input type="url" id="urunLinki" placeholder="https://www.trendyol.com/..." required>
      </div>
      <div class="form-row">
        <label for="siparisKodu">Sipariş Kodu</label>
        <input type="text" id="siparisKodu" placeholder="Sipariş verdiğiniz ürünün sipariş kodunu yazınız" required>
      </div>
      <div class="form-row">
        <label for="urunFiyati">Ürün Fiyatı (TL)</label>
        <input type="number" id="urunFiyati" min="1" placeholder="örn: 1000" required>
      </div>
      <div class="form-row">
        <label for="kategori">Kategori</label>
        <select id="kategori" required>
          <option value="">Seçiniz</option>
          <option value="Mobilya">Mobilya</option>
          <option value="Giyim">Giyim</option>
          <option value="Elektronik">Elektronik</option>
          <option value="Kırtasiye">Kırtasiye</option>
          <option value="Kozmetik">Kozmetik</option>
        </select>
      </div>
      <div class="form-row">
        <label for="teslimatTipi">Teslimat Tipi</label>
        <select id="teslimatTipi" required>
          <option value="">Seçiniz</option>
          <option value="Depodan Teslim">Depodan Teslim</option>
          <option value="Eve Teslim">Eve Teslim</option>
        </select>
      </div>
      <div class="form-row" id="adresRow" style="display:none;">
        <label for="adresSecimi">Teslimat Adresi (Şehir)</label>
        <select id="adresSecimi">
          <option value="">Şehir Seçiniz</option>
          <option value="Mağusa">Mağusa</option>
          <option value="Lefkoşa">Lefkoşa</option>
          <option value="Girne">Girne</option>
          <option value="İskele">İskele</option>
          <option value="Güzelyurt">Güzelyurt</option>
          <option value="Lefke">Lefke</option>
          <option value="Karpaz">Karpaz</option>
        </select>
      </div>
      <div class="form-row" id="acikAdresRow" style="display:none;">
        <label for="acikAdres">Açık Teslimat Adresi</label>
        <textarea id="acikAdres" placeholder="Açık adresinizi giriniz"></textarea>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" id="hesaplaBtn">Hesapla</button>
        <button type="button" class="btn" id="onaylaBtn" style="background:#24a85c;display:none;">Onayla</button>
      </div>
      <div id="resultInfo" class="result-info" style="display:none;"></div>
      <div id="successInfo" class="success-info" style="display:none;"></div>
      <div id="errorInfo" class="error-info" style="display:none;"></div>
    </form>
  </div>
  <script>
    // FIREBASE CONFIG (Senin config'in)
    const firebaseConfig = {
      apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
      authDomain: "kibris-6b4f7.firebaseapp.com",
      projectId: "kibris-6b4f7",
      storageBucket: "kibris-6b4f7.firebasestorage.app",
      messagingSenderId: "141262926171",
      appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
      measurementId: "G-JL9P6BRZTD"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI Elements
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileImg = document.getElementById('profileImg');
    const hesaplaBtn = document.getElementById('hesaplaBtn');
    const onaylaBtn = document.getElementById('onaylaBtn');
    const calcForm = document.getElementById('calcForm');
    const resultInfo = document.getElementById('resultInfo');
    const successInfo = document.getElementById('successInfo');
    const errorInfo = document.getElementById('errorInfo');
    let user = null, toplamTutar = null;

    // Giriş kontrolü: Sayfa sadece giriş yapanlara açık
    auth.onAuthStateChanged(function(currentUser) {
      user = currentUser;
      updateAuthUI(currentUser);
      if (!user) {
        window.location.href = "index.html";
      }
    });

    function updateAuthUI(currentUser) {
      user = currentUser;
      if (user) {
        loginBtn.style.display = 'none';
        profileImg.src = user.photoURL || '';
        profileImg.style.display = '';
        logoutBtn.style.display = '';
      } else {
        loginBtn.style.display = '';
        profileImg.style.display = 'none';
        logoutBtn.style.display = 'none';
      }
    }

    loginBtn.onclick = function() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e=>alert('Giriş başarısız! '+e.message));
    };
    logoutBtn.onclick = function() {
      auth.signOut().then(()=>location.reload());
    };

    // Navigasyon ve erişim
    function goPageOrWarn(page) {
      if (user) {
        window.location.href = page;
      } else {
        alert("Lütfen giriş yapınız.");
      }
    }
    function scrollToCalc() {
      document.getElementById('calcForm').scrollIntoView({behavior: 'smooth'});
    }

    // Form alanları
    document.getElementById('teslimatTipi').addEventListener('change', function() {
      const show = this.value === 'Eve Teslim';
      document.getElementById('adresRow').style.display = show ? '' : 'none';
      if (!show) {
        document.getElementById('adresSecimi').value = '';
        document.getElementById('acikAdresRow').style.display = 'none';
        document.getElementById('acikAdres').value = '';
      }
    });
    document.getElementById('adresSecimi').addEventListener('change', function() {
      const show = this.value ? true : false;
      document.getElementById('acikAdresRow').style.display = show ? '' : 'none';
      if (!show) document.getElementById('acikAdres').value = '';
    });

    // Hesaplama kuralları
    const kategoriYuzdeleri = {
      'Mobilya': 0.7,
      'Giyim': 0.45,
      'Elektronik': 0.7,
      'Kırtasiye': 0.4,
      'Kozmetik': 0.7
    };
    const kargoUcretleri = {
      'Mağusa': 500,
      'Lefkoşa': 200,
      'Girne': 350,
      'İskele': 550,
      'Güzelyurt': 350,
      'Lefke': 450,
      'Karpaz': 750
    };

    hesaplaBtn.onclick = function() {
      const link = document.getElementById('urunLinki').value.trim();
      const siparisKodu = document.getElementById('siparisKodu').value.trim();
      const fiyat = parseFloat(document.getElementById('urunFiyati').value.trim());
      const kategori = document.getElementById('kategori').value;
      const teslimat = document.getElementById('teslimatTipi').value;
      const sehir = document.getElementById('adresSecimi').value;
      const acikAdres = document.getElementById('acikAdres').value.trim();
      const adSoyad = document.getElementById('adSoyad').value.trim();
      const telefon = document.getElementById('telefon').value.trim();

      errorInfo.style.display = 'none';
      successInfo.style.display = 'none';

      if (!adSoyad || !telefon) {
        errorInfo.innerText = "Lütfen ad soyad ve telefon bilgilerinizi giriniz.";
        errorInfo.style.display = '';
        return;
      }
      if (!link || !fiyat || !kategori || !teslimat || !siparisKodu) {
        errorInfo.innerText = "Lütfen tüm alanları doldurunuz.";
        errorInfo.style.display = '';
        return;
      }
      if (teslimat === 'Eve Teslim' && !sehir) {
        errorInfo.innerText = "Teslimat şehrini seçiniz.";
        errorInfo.style.display = '';
        return;
      }
      if (teslimat === 'Eve Teslim' && sehir && !acikAdres) {
        errorInfo.innerText = "Teslimat adresinizi giriniz.";
        errorInfo.style.display = '';
        return;
      }
      let ekYuzde = kategoriYuzdeleri[kategori] || 0;
      let araFiyat = fiyat + (fiyat * ekYuzde);
      let kargo = 0;
      if (teslimat === 'Eve Teslim') {
        kargo = kargoUcretleri[sehir] || 0;
      }
      toplamTutar = Math.round(araFiyat + kargo);
      resultInfo.innerHTML = `Toplam Tutar: <b>${toplamTutar} TL</b> <br> (${kategori} için +%${(ekYuzde*100).toFixed(0)}, ${teslimat === 'Eve Teslim' ? sehir+' '+kargo+' TL kargo dahil' : 'kargo ücreti yok'})`;
      resultInfo.style.display = '';
      onaylaBtn.style.display = 'block';
    };

    // onaylaBtn (yeni hali - siparislerim.html'e yönlendirir)
    onaylaBtn.onclick = async function() {
      const link = document.getElementById('urunLinki').value.trim();
      const siparisKodu = document.getElementById('siparisKodu').value.trim();
      const fiyat = parseFloat(document.getElementById('urunFiyati').value.trim());
      const kategori = document.getElementById('kategori').value;
      const teslimat = document.getElementById('teslimatTipi').value;
      const sehir = document.getElementById('adresSecimi').value;
      const acikAdres = document.getElementById('acikAdres').value.trim();
      const adSoyad = document.getElementById('adSoyad').value.trim();
      const telefon = document.getElementById('telefon').value.trim();

      errorInfo.style.display = 'none';
      successInfo.style.display = 'none';

      if (!adSoyad || !telefon) {
        errorInfo.innerText = "Lütfen ad soyad ve telefon bilgilerinizi giriniz.";
        errorInfo.style.display = '';
        return;
      }
      if (!user) {
        errorInfo.innerText = "Lütfen giriş yapınız.";
        errorInfo.style.display = '';
        return;
      }
      if (!link || !fiyat || !kategori || !teslimat || !siparisKodu) {
        errorInfo.innerText = "Lütfen tüm alanları doldurunuz.";
        errorInfo.style.display = '';
        return;
      }
      if (teslimat === 'Eve Teslim' && (!sehir || !acikAdres)) {
        errorInfo.innerText = "Teslimat şehri ve açık adres gerekli.";
        errorInfo.style.display = '';
        return;
      }
      if (toplamTutar === null) {
        errorInfo.innerText = "Lütfen önce Hesapla butonuna basınız.";
        errorInfo.style.display = '';
        return;
      }

      onaylaBtn.disabled = true;
      try {
        await db.collection("siparisler").add({
          uid: user.uid,
          email: user.email,
          adSoyad: adSoyad,
          telefon: telefon,
          urunLinki: link,
          siparisKodu: siparisKodu,
          urunFiyati: fiyat,
          kategori,
          teslimatTipi: teslimat,
          sehir: teslimat === 'Eve Teslim' ? sehir : "",
          acikAdres: teslimat === 'Eve Teslim' ? acikAdres : "",
          toplamTutar,
          createdAt: new Date()
        });

        successInfo.innerText = "Siparişiniz başarıyla kaydedildi!";
        successInfo.style.display = '';
        errorInfo.style.display = 'none';
        resultInfo.style.display = 'none';

        // ☑️ 1.5 saniye sonra siparislerim.html'e yönlendir
        setTimeout(() => {
          window.location.href = "siparislerim.html";
        }, 1500);

        // Formu sıfırla
        calcForm.reset();
        document.getElementById('adresRow').style.display = 'none';
        document.getElementById('acikAdresRow').style.display = 'none';
        toplamTutar = null;
        onaylaBtn.style.display = 'none';

      } catch (e) {
        errorInfo.innerText = "Bir hata oluştu, lütfen tekrar deneyin.";
        errorInfo.style.display = '';
      }
      onaylaBtn.disabled = false;
    };

    // Form sıfırlama
    Array.from(calcForm.elements).forEach(el=>{
      el.addEventListener('input', function() {
        errorInfo.style.display = 'none';
        successInfo.style.display = 'none';
        onaylaBtn.style.display = 'none';
        resultInfo.style.display = 'none';
        toplamTutar = null;
      });
    });
  </script>
</body>
</html>
