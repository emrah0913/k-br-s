<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Getir Home Admin | Getir KÄ±brÄ±s</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* kÃ¼Ã§Ã¼k gÃ¶rsel dÃ¼zen */
    .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- BaÅŸlÄ±k / Ãœst bar -->
  <header class="bg-white shadow p-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-xl font-bold text-blue-700">Getir Home â€” YÃ¶netim</h1>
      <div class="flex items-center gap-3">
        <span id="admin-email" class="text-gray-600"></span>
        <button id="logoutBtn" class="text-sm text-red-600 hidden">Ã‡Ä±kÄ±ÅŸ Yap</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6">
    <!-- GiriÅŸ ekranÄ± (admin deÄŸilse gÃ¶sterilecek) -->
    <section id="login-screen" class="text-center py-12 hidden">
      <h2 class="text-2xl mb-4">Admin GiriÅŸi</h2>
      <button id="googleSignIn" class="bg-blue-600 text-white px-5 py-2 rounded">Google ile GiriÅŸ Yap</button>
    </section>

    <!-- Admin panel (giriÅŸli admin iÃ§in) -->
    <section id="admin-panel" class="hidden card bg-white p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-semibold">YÃ¶netim Paneli</h2>
          <p class="text-sm text-gray-500">Banner, Kategori ve ÃœrÃ¼n yÃ¶netimi</p>
        </div>
        <div class="flex gap-2">
          <button id="tabBanner" class="px-4 py-2 bg-blue-600 text-white rounded">Banner</button>
          <button id="tabCategory" class="px-4 py-2 bg-gray-100 rounded">Kategori</button>
          <button id="tabProduct" class="px-4 py-2 bg-gray-100 rounded">ÃœrÃ¼n</button>
        </div>
      </div>

      <!-- Banner BÃ¶lÃ¼mÃ¼ -->
      <div id="sectionBanner" class="">
        <h3 class="font-semibold mb-3">ðŸ–¼ Banner YÃ¶netimi</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
          <input id="bannerUrl" placeholder="Banner gÃ¶rsel URL" class="border p-2 rounded col-span-2" />
          <div class="flex gap-2">
            <button id="addBannerBtn" class="bg-green-600 text-white px-4 py-2 rounded">Ekle</button>
            <button id="refreshBannerBtn" class="bg-gray-200 px-4 py-2 rounded">Yenile</button>
          </div>
        </div>
        <div id="bannerList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
      </div>

      <!-- Kategori BÃ¶lÃ¼mÃ¼ -->
      <div id="sectionCategory" class="hidden">
        <h3 class="font-semibold mb-3">ðŸ—‚ Kategori YÃ¶netimi</h3>
        <div class="flex gap-3 mb-4">
          <input id="categoryName" placeholder="Kategori adÄ±" class="border p-2 rounded w-full" />
          <button id="addCategoryBtn" class="bg-green-600 text-white px-4 py-2 rounded">Ekle</button>
        </div>
        <div id="categoryList" class="space-y-2"></div>
      </div>

      <!-- ÃœrÃ¼n BÃ¶lÃ¼mÃ¼ -->
      <div id="sectionProduct" class="hidden">
        <h3 class="font-semibold mb-3">ðŸ›’ ÃœrÃ¼n YÃ¶netimi</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
          <input id="productName" placeholder="ÃœrÃ¼n adÄ±" class="border p-2 rounded" />
          <input id="productPrice" placeholder="Fiyat (â‚º)" class="border p-2 rounded" />
          <select id="productCategorySelect" class="border p-2 rounded">
            <option value="">Kategori seÃ§</option>
          </select>
          <input id="productImage" placeholder="Resim URL" class="border p-2 rounded md:col-span-2" />
          <input id="productActive" type="checkbox" class="mt-2" /> <label class="text-sm">Aktif</label>
        </div>

        <div class="flex gap-2 mb-6">
          <button id="addProductBtn" class="bg-blue-600 text-white px-4 py-2 rounded">ÃœrÃ¼n Ekle</button>
          <button id="refreshProductsBtn" class="bg-gray-200 px-4 py-2 rounded">Yenile</button>
        </div>

        <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
      </div>
    </section>

    <!-- Hata / Bilgi alanÄ± -->
    <div id="msg" class="mt-4 text-sm text-red-600"></div>
  </main>

  <footer class="text-center text-gray-400 py-8">
    Â© 2025 Getir KÄ±brÄ±s
  </footer>

  <!-- Firebase & Admin logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // --- KONFÄ°GÃœRASYON (senin bilgilerinle aynÄ±) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
      authDomain: "kibris-6b4f7.firebaseapp.com",
      projectId: "kibris-6b4f7",
      storageBucket: "kibris-6b4f7.firebasestorage.app",
      messagingSenderId: "141262926171",
      appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
      measurementId: "G-JL9P6BRZTD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // --- ADMIN SABÄ°TÄ° ---
    const ADMIN_EMAIL = "emirmob09@gmail.com";

    // --- ELEMENTLER ---
    const loginScreen = document.getElementById("login-screen");
    const googleSignIn = document.getElementById("googleSignIn");
    const adminPanel = document.getElementById("admin-panel");
    const adminEmailSpan = document.getElementById("admin-email");
    const logoutBtn = document.getElementById("logoutBtn");
    const msg = document.getElementById("msg");

    // sekmeler
    const tabBanner = document.getElementById("tabBanner");
    const tabCategory = document.getElementById("tabCategory");
    const tabProduct = document.getElementById("tabProduct");
    const sectionBanner = document.getElementById("sectionBanner");
    const sectionCategory = document.getElementById("sectionCategory");
    const sectionProduct = document.getElementById("sectionProduct");

    // banner elemanlarÄ±
    const bannerUrl = document.getElementById("bannerUrl");
    const addBannerBtn = document.getElementById("addBannerBtn");
    const bannerList = document.getElementById("bannerList");
    const refreshBannerBtn = document.getElementById("refreshBannerBtn");

    // kategori elemanlarÄ±
    const categoryName = document.getElementById("categoryName");
    const addCategoryBtn = document.getElementById("addCategoryBtn");
    const categoryList = document.getElementById("categoryList");

    // Ã¼rÃ¼n elemanlarÄ±
    const productName = document.getElementById("productName");
    const productPrice = document.getElementById("productPrice");
    const productCategorySelect = document.getElementById("productCategorySelect");
    const productImage = document.getElementById("productImage");
    const addProductBtn = document.getElementById("addProductBtn");
    const productList = document.getElementById("productList");
    const refreshProductsBtn = document.getElementById("refreshProductsBtn");
    const productActive = document.getElementById("productActive");

    // --- YARDIMCI FONKSÄ°YONLAR ---
    function showMsg(text, isError = true) {
      msg.textContent = text || "";
      msg.style.color = isError ? "#b91c1c" : "#065f46";
      if (text) setTimeout(() => { msg.textContent = ""; }, 5000);
    }

    // sekme mantÄ±ÄŸÄ±
    function activateTab(target) {
      [sectionBanner, sectionCategory, sectionProduct].forEach(s => s.classList.add("hidden"));
      [tabBanner, tabCategory, tabProduct].forEach(t => t.classList.remove("bg-blue-600","text-white"));
      if (target === "banner") { sectionBanner.classList.remove("hidden"); tabBanner.classList.add("bg-blue-600","text-white"); }
      if (target === "category") { sectionCategory.classList.remove("hidden"); tabCategory.classList.add("bg-blue-600","text-white"); }
      if (target === "product") { sectionProduct.classList.remove("hidden"); tabProduct.classList.add("bg-blue-600","text-white"); }
    }

    tabBanner.addEventListener("click", () => activateTab("banner"));
    tabCategory.addEventListener("click", () => activateTab("category"));
    tabProduct.addEventListener("click", () => activateTab("product"));

    // --- AUTH / ADMIN KONTROL ---
    onAuthStateChanged(auth, async (user) => {
      try {
        if (!user) {
          // oturum yok
          loginScreen.classList.remove("hidden");
          adminPanel.classList.add("hidden");
          logoutBtn.classList.add("hidden");
          adminEmailSpan.textContent = "";
          return;
        }

        // EÄŸer giriÅŸ yapan e-posta admin deÄŸilse: Ã§Ä±kÄ±ÅŸ ve yÃ¶nlendir
        if (user.email !== ADMIN_EMAIL) {
          showMsg("Bu panel sadece yÃ¶neticilere aÃ§Ä±ktÄ±r. YÃ¶nlendiriliyorsunuz...");
          await signOut(auth);
          window.location.href = "/getirhome.html";
          return;
        }

        // adminse paneli gÃ¶ster
        loginScreen.classList.add("hidden");
        adminPanel.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        adminEmailSpan.textContent = user.email;
        activateTab("banner");

        // yÃ¼klemeler
        await loadBanners();
        await loadCategories();
        await loadProducts();
      } catch (e) {
        console.error(e);
        showMsg("Yetki kontrolÃ¼nde hata: " + (e.message || e));
      }
    });

    // Google giriÅŸ
    googleSignIn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        showMsg("GiriÅŸ hatasÄ±: " + e.message);
      }
    });

    // Ã§Ä±kÄ±ÅŸ
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "/getirhome.html";
    });

    // --- BANNER CRUD ---
    async function loadBanners() {
      bannerList.innerHTML = "<p class='text-gray-500'>YÃ¼kleniyor...</p>";
      try {
        const snap = await getDocs(collection(db, "homeBanners"));
        bannerList.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const el = document.createElement("div");
          el.className = "p-3 bg-white rounded flex items-center gap-3";
          el.innerHTML = `
            <img src="${d.resimURL || '#'}" onerror="this.style.opacity=.4" class="w-24 h-14 object-cover rounded" />
            <div class="flex-1">
              <div class="font-medium">${d.resimURL || '(URL yok)'}</div>
              <div class="text-sm text-gray-500">Aktif: ${d.aktif ? "Evet" : "HayÄ±r"}</div>
            </div>
            <div class="flex gap-2">
              <button data-id="${id}" class="del-banner text-red-600 px-3 py-1 rounded">Sil</button>
            </div>
          `;
          bannerList.appendChild(el);
        });

        // sil butonlarÄ±
        document.querySelectorAll(".del-banner").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            if (!confirm("Banner silinsin mi?")) return;
            try {
              await deleteDoc(doc(db, "homeBanners", id));
              showMsg("Banner silindi.", false);
              await loadBanners();
            } catch (err) {
              console.error(err);
              showMsg("Banner silinemedi.");
            }
          });
        });
      } catch (err) {
        console.error(err);
        bannerList.innerHTML = "<div class='text-red-600'>Banner yÃ¼klenemedi.</div>";
      }
    }

    addBannerBtn.addEventListener("click", async () => {
      const url = bannerUrl.value.trim();
      if (!url) return showMsg("Banner URL girin.");
      try {
        await addDoc(collection(db, "homeBanners"), { resimURL: url, aktif: true });
        bannerUrl.value = "";
        await loadBanners();
        showMsg("Banner eklendi.", false);
      } catch (err) {
        console.error(err);
        showMsg("Banner eklenemedi.");
      }
    });

    refreshBannerBtn.addEventListener("click", () => loadBanners());

    // --- KATEGORÄ° CRUD ---
    async function loadCategories() {
      categoryList.innerHTML = "<p class='text-gray-500'>YÃ¼kleniyor...</p>";
      productCategorySelect.innerHTML = `<option value="">Kategori seÃ§</option>`;
      try {
        const snap = await getDocs(collection(db, "homeCategories"));
        categoryList.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const el = document.createElement("div");
          el.className = "flex items-center justify-between p-2 bg-white rounded";
          el.innerHTML = `
            <div>
              <div class="font-medium">${d.kategoriAdi || '(isim yok)'}</div>
              <div class="text-sm text-gray-500">Ãœst: ${d.ustKategori || '-'}</div>
            </div>
            <div class="flex gap-2">
              <button data-id="${id}" class="del-cat text-red-600 px-3 py-1 rounded">Sil</button>
            </div>
          `;
          categoryList.appendChild(el);

          // select'e ekle
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = d.kategoriAdi || '(isim yok)';
          productCategorySelect.appendChild(opt);
        });

        // sil butonlarÄ±
        document.querySelectorAll(".del-cat").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            if (!confirm("Kategori silinsin mi?")) return;
            try {
              await deleteDoc(doc(db, "homeCategories", id));
              showMsg("Kategori silindi.", false);
              await loadCategories();
              await loadProducts();
            } catch (err) {
              console.error(err);
              showMsg("Kategori silinemedi.");
            }
          });
        });
      } catch (err) {
        console.error(err);
        categoryList.innerHTML = "<div class='text-red-600'>Kategoriler yÃ¼klenemedi.</div>";
      }
    }

    addCategoryBtn.addEventListener("click", async () => {
      const name = categoryName.value.trim();
      if (!name) return showMsg("Kategori adÄ± girin.");
      try {
        await addDoc(collection(db, "homeCategories"), { kategoriAdi: name, ustKategori: "", aktif: true });
        categoryName.value = "";
        await loadCategories();
        showMsg("Kategori eklendi.", false);
      } catch (err) {
        console.error(err);
        showMsg("Kategori eklenemedi.");
      }
    });

    // --- ÃœRÃœN CRUD ---
    async function loadProducts() {
      productList.innerHTML = "<p class='text-gray-500'>YÃ¼kleniyor...</p>";
      try {
        const snap = await getDocs(collection(db, "homeProducts"));
        productList.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const el = document.createElement("div");
          el.className = "p-3 bg-white rounded flex gap-3";
          el.innerHTML = `
            <img src="${d.resimURL || '#'}" class="w-28 h-20 object-cover rounded" onerror="this.style.opacity=.4" />
            <div class="flex-1">
              <div class="font-semibold">${d.urunAdi || '(isim yok)'}</div>
              <div class="text-sm text-gray-600">${d.aciklama || ''}</div>
              <div class="text-sm text-blue-600 font-bold">${d.fiyat || '0'} â‚º</div>
              <div class="text-xs text-gray-500">Kategori: ${d.kategoriId || '-'}</div>
            </div>
            <div class="flex flex-col gap-2">
              <button data-id="${id}" class="del-prod text-red-600 px-3 py-1 rounded">Sil</button>
              <button data-id="${id}" class="edit-prod text-gray-700 px-3 py-1 rounded">DÃ¼zenle</button>
            </div>
          `;
          productList.appendChild(el);
        });

        // sil butonlarÄ±
        document.querySelectorAll(".del-prod").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            if (!confirm("ÃœrÃ¼n silinsin mi?")) return;
            try {
              await deleteDoc(doc(db, "homeProducts", id));
              showMsg("ÃœrÃ¼n silindi.", false);
              await loadProducts();
            } catch (err) {
              console.error(err);
              showMsg("ÃœrÃ¼n silinemedi.");
            }
          });
        });

        // dÃ¼zenle butonlarÄ± (basit: formu doldurup ekleyip ardÄ±ndan eskiyi sil)
        document.querySelectorAll(".edit-prod").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            // doc verisini al
            try {
              const snap = await getDocs(collection(db, "homeProducts"));
              let target = null;
              snap.forEach(s => { if (s.id === id) target = { id: s.id, data: s.data() }; });
              if (!target) return showMsg("ÃœrÃ¼n bulunamadÄ±.");
              // formu doldur
              productName.value = target.data.urunAdi || "";
              productPrice.value = target.data.fiyat || "";
              productImage.value = target.data.resimURL || "";
              productCategorySelect.value = target.data.kategoriId || "";
              productActive.checked = !!target.data.aktif;
              // sil old doc
              if (confirm("ÃœrÃ¼nÃ¼ dÃ¼zenlemek Ã¼zere formu doldurdum. DÃ¼zenleme tamamlandÄ±ÄŸÄ±nda 'ÃœrÃ¼n Ekle'ye basÄ±n; eski kayÄ±t silinecek. Silinsin mi ÅŸimdi?")) {
                await deleteDoc(doc(db, "homeProducts", id));
                showMsg("Eski kayÄ±t silindi. Yeni bilgileri dÃ¼zenleyip ÃœrÃ¼n Ekle'ye basÄ±n.", false);
                await loadProducts();
              }
            } catch (err) {
              console.error(err);
              showMsg("DÃ¼zenleme hatasÄ±.");
            }
          });
        });

      } catch (err) {
        console.error(err);
        productList.innerHTML = "<div class='text-red-600'>ÃœrÃ¼nler yÃ¼klenemedi.</div>";
      }
    }

    addProductBtn.addEventListener("click", async () => {
      const name = productName.value.trim();
      const price = productPrice.value.trim();
      const cat = productCategorySelect.value;
      const img = productImage.value.trim();
      const aktif = !!productActive.checked;

      if (!name || !price || !cat) return showMsg("LÃ¼tfen Ã¼rÃ¼n adÄ±, fiyat ve kategori girin.");
      try {
        await addDoc(collection(db, "homeProducts"), {
          urunAdi: name,
          fiyat: price,
          aciklama: "",
          kategoriId: cat,
          resimURL: img,
          aktif
        });
        productName.value = ""; productPrice.value = ""; productImage.value = ""; productCategorySelect.value = "";
        productActive.checked = false;
        await loadProducts();
        showMsg("ÃœrÃ¼n eklendi.", false);
      } catch (err) {
        console.error(err);
        showMsg("ÃœrÃ¼n eklenemedi.");
      }
    });

    refreshProductsBtn.addEventListener("click", () => loadProducts());

    // sayfa ilk aÃ§Ä±lÄ±ÅŸta default tab
    activateTab("banner");
  </script>
</body>
</html>
