<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Getir Home Admin | Getir KÄ±brÄ±s</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">
<script>
    // Tailwind KonfigÃ¼rasyonu: Getir'in ana rengini (primary) tanÄ±mla
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#5D3EBC', // Getir Moru
                    secondary: '#FFD300', // Getir SarÄ±sÄ±
                    'getir-yellow': '#FFD300',
                },
                fontFamily: {
                    inter: ['Inter', 'sans-serif'],
                },
            },
        }
    }
</script>
<style>
    .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
    .product-image-preview { transition: transform 0.2s; cursor: zoom-in; }
    .product-image-preview:hover { transform: scale(3.5); z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    /* Admin rengini CSS deÄŸiÅŸkeni olarak tanÄ±mla */
    :root {
        --color-primary: #5D3EBC;
    }
    .bg-primary { background-color: var(--color-primary); }
    .text-primary { color: var(--color-primary); }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow p-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
        <h1 class="text-xl font-bold text-primary">Getir Home â€” YÃ¶netim</h1>
        <div class="flex items-center gap-3">
            <span id="admin-email" class="text-gray-600"></span>
            <button id="logoutBtn" class="text-sm text-red-600 hidden">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>
        <a href="#" onclick="showMsg('Bu link mÃ¼ÅŸteriye aÃ§Ä±k Getir Home sayfasÄ±na yÃ¶nlendirecektir. HenÃ¼z bu link belirlenmedi.', false)" class="text-sm text-primary hover:text-primary/80 font-medium">Siteyi GÃ¶r</a>
    </div>
</header>

<main class="max-w-6xl mx-auto p-6">

<section id="login-screen" class="text-center py-12 hidden">
    <h2 class="text-2xl mb-4">Admin GiriÅŸi</h2>
    <button id="googleSignIn" class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded flex items-center mx-auto gap-2 transition-colors"><i class="ri-google-fill"></i> Google ile GiriÅŸ Yap</button>
    <p class="mt-4 text-sm text-gray-500">LÃ¼tfen tanÄ±mlÄ± yÃ¶netici e-posta adresi ile giriÅŸ yapÄ±n.</p>
</section>

<section id="admin-panel" class="hidden card bg-white p-6">

    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-semibold">YÃ¶netim Paneli</h2>
            <p class="text-sm text-gray-500">Banner, Kategori ve ÃœrÃ¼n yÃ¶netimi</p>
        </div>
        <div class="flex gap-2">
            <button id="tabBanner" class="px-4 py-2 rounded">Banner</button>
            <button id="tabCategory" class="px-4 py-2 bg-gray-100 rounded">Kategori</button>
            <button id="tabProduct" class="px-4 py-2 bg-gray-100 rounded">ÃœrÃ¼n</button>
        </div>
    </div>

    <div id="sectionBanner">
        <h3 class="font-semibold mb-3 border-b pb-2 text-gray-700">ðŸ–¼ Banner YÃ¶netimi</h3>
        <div id="banner-form-area" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 p-4 border rounded-lg bg-gray-50">
            <input id="bannerUrl" placeholder="GÃ¶rsel/Video URL (Zorunlu) - YouTube veya MP4/WebM Linki" class="border p-2 rounded col-span-3 focus:ring-primary focus:border-primary" />
            <input id="bannerTitle" placeholder="BaÅŸlÄ±k (Zorunlu)" class="border p-2 rounded col-span-1 focus:ring-primary focus:border-primary" />
            <input id="bannerDescription" placeholder="AÃ§Ä±klama" class="border p-2 rounded col-span-2 focus:ring-primary focus:border-primary" />
            <input id="bannerLink" placeholder="Link (Ã–rn: #/detail?id=...) (Opsiyonel)" class="border p-2 rounded col-span-2 focus:ring-primary focus:border-primary" />
            <div class="flex gap-2 col-span-1">
                <button id="addBannerBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full transition-colors">Ekle</button>
            </div>
        </div>
        <button id="refreshBannerBtn" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition-colors mb-4"><i class="ri-refresh-line"></i> Yenile</button>
        <div id="bannerList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
    </div>

    <div id="sectionCategory" class="hidden">
        <h3 class="font-semibold mb-3 border-b pb-2 text-gray-700">ðŸ—‚ Kategori YÃ¶netimi</h3>
        
        <div id="categoryEditingStatus" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-4 hidden" role="alert">
            <p class="font-bold">DÃ¼zenleme Modu:</p>
            <p id="editingCategoryNameDisplay"></p>
            <input type="hidden" id="editingCategoryId" />
        </div>

        <div id="category-form-area" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 p-4 border rounded-lg bg-gray-50">
            <input id="categoryName" placeholder="Kategori adÄ± (Zorunlu)" class="border p-2 rounded col-span-2 focus:ring-primary focus:border-primary" />
            <select id="parentCategory" class="border p-2 rounded col-span-2 focus:ring-primary focus:border-primary">
                <option value="">Ãœst Kategori Yok</option>
            </select>
            <input id="categoryImage" placeholder="Kategori GÃ¶rsel URL (Opsiyonel)" class="border p-2 rounded col-span-3 focus:ring-primary focus:border-primary" />
            
            <div class="flex gap-2 col-span-1">
                <button id="addCategoryBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors w-full"><i class="ri-add-line"></i> Ekle</button>
                <button id="updateCategoryBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded transition-colors hidden w-full"><i class="ri-save-line"></i> GÃ¼ncelle</button>
                <button id="cancelCategoryEditBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded hidden transition-colors w-full"><i class="ri-close-line"></i> Ä°ptal</button>
            </div>
        </div>
        
        <button onclick="loadCategories()" class="mt-4 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition-colors mb-4"><i class="ri-refresh-line"></i> Yenile</button>
        <div id="categoryList" class="space-y-2"></div>
        
    </div>

    <div id="sectionProduct" class="hidden">
        <h3 class="font-semibold mb-3 border-b pb-2 text-gray-700">ðŸ›’ ÃœrÃ¼n YÃ¶netimi</h3>

        <div id="editingStatus" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-4 hidden" role="alert">
            <p class="font-bold">DÃ¼zenleme Modu:</p>
            <p id="editingProductName"></p>
            <input type="hidden" id="editingProductId" />
        </div>

        <div id="product-form-area" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 p-4 border rounded-lg bg-gray-50">
            <input id="productName" placeholder="ÃœrÃ¼n adÄ± (Zorunlu)" class="border p-2 rounded col-span-2 focus:ring-primary focus:border-primary" />
            <select id="productCategorySelect" class="border p-2 rounded col-span-2 focus:ring-primary focus:border-primary">
                <option value="">Kategori seÃ§ (Zorunlu)</option>
            </select>
            <input id="productDescription" placeholder="ÃœrÃ¼n aÃ§Ä±klamasÄ±" class="border p-2 rounded md:col-span-4 focus:ring-primary focus:border-primary" />
            
            <input id="productPrice" placeholder="Ana Fiyat (â‚º) (Zorunlu)" class="border p-2 rounded focus:ring-primary focus:border-primary col-span-2" type="number" step="0.01"/>
            <input id="productOldPrice" placeholder="Eski/Liste FiyatÄ± (â‚º) (Opsiyonel)" class="border p-2 rounded focus:ring-primary focus:border-primary col-span-2" type="number" step="0.01"/>
            
            <div class="col-span-2 flex flex-col gap-1">
                <input id="productImage" placeholder="Ana gÃ¶rsel URL (Zorunlu) (PNG/WEBP Ã–nerilir)" class="border p-2 rounded focus:ring-primary focus:border-primary" />
                <img id="productImagePreview" class="w-full h-24 object-contain rounded border bg-white" src="https://placehold.co/300x96/f0f0f0/666?text=Ana+Gorsel+Onizlemesi" onerror="this.src='https://placehold.co/300x96/f0f0f0/666?text=Ana+Gorsel+Onizlemesi'"/>
            </div>
            <div class="col-span-2 flex flex-col gap-1">
                <input id="productVideo" placeholder="Video URL (YouTube/MP4 - Opsiyonel)" class="border p-2 rounded focus:ring-primary focus:border-primary" /> 
                <span class="text-xs text-gray-500 mt-1"><i class="ri-video-line"></i> Video ekliyorsanÄ±z Ã¶nizleme listede gÃ¶rÃ¼nÃ¼r.</span>
            </div>

            <div class="md:col-span-4 p-3 mt-4 border rounded-lg bg-white">
                <h4 class="font-semibold mb-3 text-gray-700">Ek GÃ¶rsel URL'leri (ÃœrÃ¼n Seviyesinde)</h4>
                <div id="extraImagesContainer" class="space-y-2">
                    </div>
                <button id="addExtraImageBtn" type="button" class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm transition-colors flex items-center gap-1">
                    <i class="ri-image-add-line"></i> Yeni GÃ¶rsel AlanÄ± Ekle
                </button>
            </div>

            <div class="md:col-span-4 p-3 mt-4 border rounded-lg bg-white">
                <h4 class="font-semibold mb-3 text-gray-700">Varyant YÃ¶netimi (GeliÅŸmiÅŸ Medya DesteÄŸi)</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-3 items-end border-b pb-3">
                    <input id="variantName" placeholder="Varyant AdÄ± (Zorunlu)" class="border p-2 rounded col-span-3 focus:ring-getir-yellow focus:border-getir-yellow" />
                    <input id="variantPriceOffset" placeholder="Fiyat FarkÄ± (â‚º)" class="border p-2 rounded col-span-3 focus:ring-getir-yellow focus:border-getir-yellow" type="number" step="0.01" value="0"/>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-6 gap-2 mt-4">
                    <div class="col-span-3 p-2 border rounded bg-gray-50">
                        <h5 class="text-sm font-semibold mb-2 flex items-center gap-1"><i class="ri-image-line"></i> Varyant Ek GÃ¶rselleri</h5>
                        <div id="variantImagesContainer" class="space-y-1">
                            </div>
                        <button id="addVariantImageBtn" type="button" class="mt-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded flex items-center gap-1 w-full justify-center">
                            <i class="ri-image-add-line"></i> GÃ¶rsel URL Ekle
                        </button>
                    </div>

                    <div class="col-span-3 p-2 border rounded bg-gray-50">
                        <h5 class="text-sm font-semibold mb-2 flex items-center gap-1"><i class="ri-video-line"></i> Varyant Ek VideolarÄ±</h5>
                        <div id="variantVideosContainer" class="space-y-1">
                            </div>
                        <button id="addVariantVideoBtn" type="button" class="mt-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded flex items-center gap-1 w-full justify-center">
                            <i class="ri-video-add-line"></i> Video URL Ekle
                        </button>
                    </div>
                </div>
                
                <div class="col-span-6 flex justify-end mt-4 border-t pt-3">
                    <button id="addVariantBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded flex items-center gap-1 transition-colors w-full md:w-auto"><i class="ri-add-line"></i> VaryantÄ± Listeye Ekle</button>
                </div>

                <div id="variantList" class="space-y-2 mt-4">
                    <p class="text-sm text-gray-500" id="no-variants-msg">HenÃ¼z varyant eklenmedi.</p>
                </div>
            </div>
            <div class="flex items-center gap-2 mt-4 md:col-span-4">
                <input id="productActive" type="checkbox" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" /> 
                <label for="productActive" class="text-sm font-medium text-gray-700">ÃœrÃ¼nÃ¼ aktif olarak gÃ¶ster</label>
            </div>
        </div>

        <div class="flex gap-2 mb-6">
            <button id="addProductBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors"><i class="ri-add-line"></i> ÃœrÃ¼n Ekle</button>
            <button id="updateProductBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded hidden transition-colors"><i class="ri-save-line"></i> Kaydet ve GÃ¼ncelle</button>
            <button id="cancelEditBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded hidden transition-colors"><i class="ri-close-line"></i> Ä°ptal</button>
            <button id="refreshProductsBtn" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition-colors"><i class="ri-refresh-line"></i> Yenile</button>
        </div>

        <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
    </div>

</section>

<div id="msg" class="mt-4 text-sm text-red-600"></div>
</main>

<footer class="text-center text-gray-400 py-8">
Â© 2025 Getir KÄ±brÄ±s
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

// Firestore iÃ§in DEBUG seviyesini aÃ§ (Ä°steÄŸe baÄŸlÄ±)
// setLogLevel('debug');

const firebaseConfig = {
    apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
    authDomain: "kibris-6b4f7.firebaseapp.com",
    projectId: "kibris-6b4f7",
    storageBucket: "kibris-6b4f7.appspot.com",
    messagingSenderId: "141262926171",
    appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
    measurementId: "G-JL9P6BRZTD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// !!! KRÄ°TÄ°K: BURAYI KENDÄ° ADMÄ°N EMAIL'Ä°NÄ°ZLE DEÄžÄ°ÅžTÄ°RMEYÄ°N!
const ADMIN_EMAIL = "emirmob09@gmail.com"; 

let allAdminCategories = {}; 

// --- DOM Elementleri ---
const loginScreen = document.getElementById("login-screen");
const googleSignIn = document.getElementById("googleSignIn");
const adminPanel = document.getElementById("admin-panel");
const adminEmailSpan = document.getElementById("admin-email");
const logoutBtn = document.getElementById("logoutBtn");
const msg = document.getElementById("msg");

// Panel TablarÄ± ve BÃ¶lÃ¼mleri
const tabBanner = document.getElementById("tabBanner");
const tabCategory = document.getElementById("tabCategory");
const tabProduct = document.getElementById("tabProduct");
const sectionBanner = document.getElementById("sectionBanner");
const sectionCategory = document.getElementById("sectionCategory");
const sectionProduct = document.getElementById("sectionProduct");

// Banner
const bannerUrl = document.getElementById("bannerUrl");
const bannerTitle = document.getElementById("bannerTitle");
const bannerDescription = document.getElementById("bannerDescription");
const bannerLink = document.getElementById("bannerLink");

const addBannerBtn = document.getElementById("addBannerBtn");
const bannerList = document.getElementById("bannerList");
const refreshBannerBtn = document.getElementById("refreshBannerBtn");

// Kategori
const categoryName = document.getElementById("categoryName");
const parentCategory = document.getElementById("parentCategory");
const categoryImage = document.getElementById("categoryImage"); 
const addCategoryBtn = document.getElementById("addCategoryBtn");
const updateCategoryBtn = document.getElementById("updateCategoryBtn"); // YENÄ°
const cancelCategoryEditBtn = document.getElementById("cancelCategoryEditBtn"); // YENÄ°
const categoryList = document.getElementById("categoryList");
const categoryEditingStatus = document.getElementById("categoryEditingStatus"); // YENÄ°
const editingCategoryNameDisplay = document.getElementById("editingCategoryNameDisplay"); // YENÄ°
const editingCategoryId = document.getElementById("editingCategoryId"); // YENÄ°

// ÃœrÃ¼n
const productName = document.getElementById("productName");
const productPrice = document.getElementById("productPrice");
const productOldPrice = document.getElementById("productOldPrice");

const productCategorySelect = document.getElementById("productCategorySelect");
const productImage = document.getElementById("productImage");
const productVideo = document.getElementById("productVideo");
const productImagePreview = document.getElementById("productImagePreview"); 
const extraImagesContainer = document.getElementById("extraImagesContainer");
const addExtraImageBtn = document.getElementById("addExtraImageBtn");

const productDescription = document.getElementById("productDescription");
const productActive = document.getElementById("productActive");

// Varyant
const variantName = document.getElementById("variantName");
const variantPriceOffset = document.getElementById("variantPriceOffset");
const variantImagesContainer = document.getElementById("variantImagesContainer");
const variantVideosContainer = document.getElementById("variantVideosContainer");
const addVariantImageBtn = document.getElementById("addVariantImageBtn");
const addVariantVideoBtn = document.getElementById("addVariantVideoBtn");
const addVariantBtn = document.getElementById("addVariantBtn");
const variantList = document.getElementById("variantList");
const noVariantsMsg = document.getElementById("no-variants-msg");

const addProductBtn = document.getElementById("addProductBtn");
const updateProductBtn = document.getElementById("updateProductBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const productList = document.getElementById("productList");
const refreshProductsBtn = document.getElementById("refreshProductsBtn");
const editingStatus = document.getElementById("editingStatus");
const editingProductName = document.getElementById("editingProductName");
const editingProductId = document.getElementById("editingProductId");

let currentProducts = [];
let productVariants = []; 

tabBanner.classList.add("bg-[--color-primary]", "text-white"); 

// --- YARDIMCI VE UI MANTIÄžI ---
function showMsg(text, isError=true){ 
    msg.textContent=text; 
    msg.style.color=isError?"#b91c1c":"#065f46"; 
    if(text) setTimeout(()=>{msg.textContent="";},5000);
}

// ... DiÄŸer yardÄ±mcÄ± fonksiyonlar (updateImagePreview, addExtraImageInput, collectExtraImages, VARYANT MANTIÄžI) aynÄ± kalÄ±r ...

// --- YARDIMCI VE UI MANTIÄžI ---

// --- MEDYA Ã–NÄ°ZLEME GÃœNCELLEME Ä°ÅžLEYÄ°CÄ°SÄ° ---
function updateImagePreview(inputElement, previewElement) {
    const url = inputElement.value.trim();
    if (url) {
        previewElement.src = url;
    } else {
        previewElement.src = 'https://placehold.co/300x96/f0f0f0/666?text=Ana+Gorsel+Onizlemesi';
    }
}

productImage.addEventListener('input', () => {
    updateImagePreview(productImage, productImagePreview);
});

// --- ANA ÃœRÃœN EK GÃ–RSEL YÃ–NETÄ°MÄ° ---

function updateExtraImageIndices() {
    const wrappers = extraImagesContainer.querySelectorAll('.dynamic-image-wrapper');
    wrappers.forEach((wrapper, index) => {
        const indexDisplay = index + 1;
        wrapper.querySelector('span').textContent = `${indexDisplay}. Resim:`;
        wrapper.querySelector('input').placeholder = `Ek GÃ¶rsel URL ${indexDisplay}`;
    });
}

function addExtraImageInput(initialValue = '') {
    const currentCount = extraImagesContainer.children.length;

    const index = currentCount + 1;
    const inputWrapper = document.createElement('div');
    inputWrapper.className = 'flex gap-2 items-center dynamic-image-wrapper';
    
    const defaultPreviewUrl = 'https://placehold.co/40x40/f0f0f0/666?text=?';
    const initialPreviewUrl = initialValue || defaultPreviewUrl;


    inputWrapper.innerHTML = `
        <div class="flex-shrink-0">
            <img class="image-preview-thumb w-10 h-10 object-cover rounded border" 
                src="${initialPreviewUrl}" 
                onerror="this.src='${defaultPreviewUrl}'" alt="Preview"/>
        </div>
        <span class="text-sm font-medium text-gray-600 w-16 flex-shrink-0">${index}. Resim:</span>
        <input type="url" 
                class="extra-image-url border p-2 rounded w-full focus:ring-primary focus:border-primary text-sm" 
                placeholder="Ek GÃ¶rsel URL ${index}" 
                value="${initialValue}" />
        <button type="button" class="remove-extra-image-btn text-red-600 hover:text-red-700 p-1 rounded transition-colors flex-shrink-0" title="Sil">
            <i class="ri-delete-bin-line"></i>
        </button>
    `;

    extraImagesContainer.appendChild(inputWrapper);

    const urlInput = inputWrapper.querySelector('.extra-image-url');
    const previewThumb = inputWrapper.querySelector('.image-preview-thumb');
    
    urlInput.addEventListener('input', (e) => {
        const url = e.target.value.trim();
        if (url) {
            previewThumb.src = url;
        } else {
            previewThumb.src = defaultPreviewUrl;
        }
    });

    inputWrapper.querySelector('.remove-extra-image-btn').addEventListener('click', () => {
        inputWrapper.remove();
        updateExtraImageIndices();
    });
    
    updateExtraImageIndices();
}

function collectExtraImages() {
    const inputs = extraImagesContainer.querySelectorAll('.extra-image-url');
    const urls = [];
    inputs.forEach(input => {
        const url = input.value.trim();
        if (url) {
            urls.push(url);
        }
    });
    return urls;
}

addExtraImageBtn.addEventListener('click', () => addExtraImageInput());

// --- VARYANT MEDYA YÃ–NETÄ°MÄ° BAÅžLANGIÃ‡ ---

function addVariantMediaInput(container, type, initialValue = '') {
    const inputWrapper = document.createElement('div');
    inputWrapper.className = 'flex gap-2 items-center';
    
    const placeholderText = type === 'image' ? 'GÃ¶rsel URL (PNG/WEBP)' : 'Video URL (YouTube/MP4)';
    const iconClass = type === 'image' ? 'ri-image-line' : 'ri-video-line';
    const defaultPreviewUrl = 'https://placehold.co/40x40/f0f0f0/666?text=?';
    const initialPreviewUrl = initialValue || defaultPreviewUrl;


    const previewHtml = type === 'image' ? 
        `<img class="variant-image-preview-thumb w-8 h-8 object-cover rounded border flex-shrink-0" 
             src="${initialPreviewUrl}" 
             onerror="this.src='${defaultPreviewUrl}'" alt="Preview"/>` :
        `<i class="${iconClass} text-gray-500 text-lg flex-shrink-0 w-8 h-8 flex items-center justify-center"></i>`; 

    inputWrapper.innerHTML = `
        ${previewHtml}
        <input type="url" 
                class="variant-media-url border p-1 rounded w-full focus:ring-getir-yellow focus:border-getir-yellow text-xs" 
                placeholder="${placeholderText}" 
                data-type="${type}"
                value="${initialValue}" />
        <button type="button" class="remove-variant-media-btn text-red-600 hover:text-red-700 p-1 rounded transition-colors flex-shrink-0" title="Sil">
            <i class="ri-delete-bin-line text-sm"></i>
        </button>
    `;

    container.appendChild(inputWrapper);

    if (type === 'image') {
        const urlInput = inputWrapper.querySelector('.variant-media-url');
        const previewThumb = inputWrapper.querySelector('.variant-image-preview-thumb');
        
        urlInput.addEventListener('input', (e) => {
            const url = e.target.value.trim();
            if (url) {
                previewThumb.src = url;
            } else {
                previewThumb.src = defaultPreviewUrl;
            }
        });
    }


    inputWrapper.querySelector('.remove-variant-media-btn').addEventListener('click', () => {
        inputWrapper.remove();
    });
}

function collectVariantMedia(container) {
    const inputs = container.querySelectorAll('.variant-media-url');
    const urls = [];
    inputs.forEach(input => {
        const url = input.value.trim();
        if (url) {
            urls.push(url);
        }
    });
    return urls;
}

addVariantImageBtn.addEventListener('click', () => addVariantMediaInput(variantImagesContainer, 'image'));
addVariantVideoBtn.addEventListener('click', () => addVariantMediaInput(variantVideosContainer, 'video'));

// Yeni varyant listesini temizler ve render eder
function renderVariants() {
    variantList.innerHTML = '';
    if (productVariants.length === 0) {
        noVariantsMsg.classList.remove('hidden');
        variantList.appendChild(noVariantsMsg);
        return;
    }
    noVariantsMsg.classList.add('hidden');

    productVariants.forEach((variant, index) => {
        const el = document.createElement('div');
        el.className = 'flex justify-between items-center p-2 rounded bg-gray-100 text-sm';
        const priceText = variant.price_offset > 0 
            ? `(Fark: +${variant.price_offset.toFixed(2)} â‚º)` 
            : variant.price_offset < 0 
            ? `(Fark: ${variant.price_offset.toFixed(2)} â‚º)`
            : '(Fark: 0 â‚º)';
        
        const imageCount = Array.isArray(variant.extraImages) ? variant.extraImages.length : 0;
        const videoCount = Array.isArray(variant.extraVideos) ? variant.extraVideos.length : 0;

        const mediaIcons = `
            ${imageCount > 0 ? `<i class="ri-image-line text-green-500 ml-2" title="${imageCount} GÃ¶rsel Eklendi">(${imageCount})</i>` : ''}
            ${videoCount > 0 ? `<i class="ri-video-line text-blue-500 ml-1" title="${videoCount} Video Eklendi">(${videoCount})</i>` : ''}
        `;

        el.innerHTML = `
            <span>${variant.name} <span class="text-gray-500">${priceText}</span> ${mediaIcons}</span>
            <button data-index="${index}" class="remove-variant-btn text-red-600 hover:text-red-700 transition-colors"><i class="ri-delete-bin-line"></i> Sil</button>
        `;
        variantList.appendChild(el);
    });

    document.querySelectorAll('.remove-variant-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const indexToRemove = parseInt(e.currentTarget.dataset.index);
            productVariants.splice(indexToRemove, 1);
            renderVariants();
        });
    });
}

addVariantBtn.addEventListener('click', () => {
    const name = variantName.value.trim();
    const priceOffset = parseFloat(variantPriceOffset.value);
    
    const extraImages = collectVariantMedia(variantImagesContainer);
    const extraVideos = collectVariantMedia(variantVideosContainer);

    if (!name) {
        showMsg("Varyant adÄ± boÅŸ olamaz.", true);
        return;
    }
    if (isNaN(priceOffset)) {
        showMsg("Fiyat farkÄ± geÃ§erli bir sayÄ± olmalÄ±dÄ±r.", true);
        return;
    }

    productVariants.push({ name, price_offset: priceOffset, extraImages, extraVideos });

    variantName.value = '';
    variantPriceOffset.value = '0';
    variantImagesContainer.innerHTML = ''; 
    variantVideosContainer.innerHTML = ''; 
    renderVariants();
});

// --- KATEGORÄ° FORMUNU SIFIRLA VE DÃœZENLEME MODUNU AYARLA (YENÄ°) ---

function resetCategoryForm(isEditing = false) {
    categoryName.value = "";
    parentCategory.value = "";
    categoryImage.value = "";
    editingCategoryId.value = "";
    editingCategoryNameDisplay.textContent = "";

    if (isEditing) {
        addCategoryBtn.classList.add("hidden");
        updateCategoryBtn.classList.remove("hidden");
        cancelCategoryEditBtn.classList.remove("hidden");
        categoryEditingStatus.classList.remove("hidden");
    } else {
        addCategoryBtn.classList.remove("hidden");
        updateCategoryBtn.classList.add("hidden");
        cancelCategoryEditBtn.classList.add("hidden");
        categoryEditingStatus.classList.add("hidden");
    }
}
cancelCategoryEditBtn.addEventListener("click", () => resetCategoryForm(false));

// --- GENEL FORM RESET (ÃœRÃœN) ---
function resetProductForm(isEditing = false) {
    productName.value = "";
    productPrice.value = "";
    productOldPrice.value = ""; 
    productCategorySelect.value = "";
    productImage.value = "";
    productImagePreview.src = 'https://placehold.co/300x96/f0f0f0/666?text=Ana+Gorsel+Onizlemesi'; 
    productVideo.value = "";
    productDescription.value = "";
    productActive.checked = false;
    editingProductId.value = "";
    editingProductName.textContent = "";
    
    extraImagesContainer.innerHTML = '';

    variantName.value = '';
    variantPriceOffset.value = '0';
    variantImagesContainer.innerHTML = ''; 
    variantVideosContainer.innerHTML = ''; 


    productVariants = []; 
    renderVariants(); 

    if (isEditing) {
        addProductBtn.classList.add("hidden");
        updateProductBtn.classList.remove("hidden");
        cancelEditBtn.classList.remove("hidden");
        editingStatus.classList.remove("hidden");
    } else {
        addProductBtn.classList.remove("hidden");
        updateProductBtn.classList.add("hidden");
        cancelEditBtn.classList.add("hidden");
        editingStatus.classList.add("hidden");
    }
}

function activateTab(target){
    [sectionBanner,sectionCategory,sectionProduct].forEach(s=>s.classList.add("hidden"));
    [tabBanner,tabCategory,tabProduct].forEach(t=>{
        t.classList.remove("bg-[--color-primary]","text-white");
        t.classList.add("bg-gray-100");
    });
    if(target==="banner"){
        sectionBanner.classList.remove("hidden"); 
        tabBanner.classList.add("bg-[--color-primary]","text-white");
        tabBanner.classList.remove("bg-gray-100");
        loadBanners();
    }
    if(target==="category"){
        sectionCategory.classList.remove("hidden"); 
        tabCategory.classList.add("bg-[--color-primary]","text-white");
        tabCategory.classList.remove("bg-gray-100");
        resetCategoryForm(false); // Kategori formunu sÄ±fÄ±rla
        loadCategories();
    }
    if(target==="product"){
        sectionProduct.classList.remove("hidden"); 
        tabProduct.classList.add("bg-[--color-primary]","text-white");
        tabProduct.classList.remove("bg-gray-100");
        resetProductForm(false);
        loadCategories(); 
        loadProducts();
    }
}

tabBanner.addEventListener("click",()=>activateTab("banner"));
tabCategory.addEventListener("click",()=>activateTab("category"));
tabProduct.addEventListener("click",()=>activateTab("product"));
cancelEditBtn.addEventListener("click",()=>resetProductForm(false));

// --- AUTH (AynÄ± KaldÄ±) ---
onAuthStateChanged(auth, async (user)=>{
    try{
        if(!user){ 
            loginScreen.classList.remove("hidden"); 
            adminPanel.classList.add("hidden"); 
            logoutBtn.classList.add("hidden"); 
            adminEmailSpan.textContent=""; 
            return; 
        }
        if(user.email!==ADMIN_EMAIL){ 
            showMsg("Bu panel sadece admin iÃ§in yetkilidir.", true); 
            await signOut(auth); 
            return; 
        }
        loginScreen.classList.add("hidden"); 
        adminPanel.classList.remove("hidden"); 
        logoutBtn.classList.remove("hidden"); 
        adminEmailSpan.textContent=user.email;

        activateTab("banner"); 
    }catch(e){ 
        console.error(e); 
        showMsg("Yetki hatasÄ±: "+e.message, true);
    }
});

googleSignIn.addEventListener("click",async()=>{ 
    try{ 
        await signInWithPopup(auth,provider);
    }catch(e){
        showMsg("GiriÅŸ hatasÄ±: "+e.message, true);
    } 
});
logoutBtn.addEventListener("click",async()=>{ 
    await signOut(auth); 
    loginScreen.classList.remove("hidden"); 
    adminPanel.classList.add("hidden"); 
    logoutBtn.classList.add("hidden"); 
});

// --- BANNER CRUD (AynÄ± KaldÄ±) ---
addBannerBtn.addEventListener("click", async ()=>{
    const url=bannerUrl.value.trim();
    const title = bannerTitle.value.trim();
    const description = bannerDescription.value.trim();
    const link = bannerLink.value.trim();

    if(!url || !url.startsWith('http')){ showMsg("GeÃ§erli bir gÃ¶rsel/video URL'si girin", true); return;}
    if(!title){ showMsg("BaÅŸlÄ±k alanÄ± boÅŸ olamaz.", true); return;}

    try{ 
        await addDoc(collection(db,"homeBanners"),{
            url,
            title,
            description,
            link: link || null, 
            createdAt:new Date()
        }); 
        bannerUrl.value=""; 
        bannerTitle.value="";
        bannerDescription.value="";
        bannerLink.value="";
        await loadBanners(); 
        showMsg("Banner baÅŸarÄ±yla eklendi!", false);
    }catch(e){ 
        showMsg("Ekleme hatasÄ±: " + e.message, true);
    }
});
refreshBannerBtn.addEventListener("click",loadBanners);

async function loadBanners(){
    if (!auth.currentUser || auth.currentUser.email !== ADMIN_EMAIL) return;

    bannerList.innerHTML="<i class='ri-loader-4-line animate-spin'></i> Bannerlar yÃ¼kleniyor...";
    try {
        const snap=await getDocs(collection(db,"homeBanners"));
        bannerList.innerHTML="";
        if(snap.empty){ bannerList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek banner bulunamadÄ±.</p>"; return; }
        snap.forEach(docSnap=>{
            const d=docSnap.data();
            const el=document.createElement("div");
            el.className="flex flex-col justify-between bg-gray-100 p-3 rounded shadow-sm";
            
            const linkDisplay = d.link ? `<a href="${d.link}" target="_blank" class="text-xs text-blue-500 hover:text-blue-700 truncate">${d.link.substring(0, 40)}...</a>` : '<span class="text-xs text-gray-400">Link Yok</span>';

            el.innerHTML=`
              <div class="flex items-start gap-3">
                <img src="${d.url}" class="w-16 h-16 object-cover rounded product-image-preview flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/64x64/ccc/fff?text=?'"/>
                <div class="flex-grow min-w-0">
                    <div class="font-semibold text-gray-800">${d.title || 'BaÅŸlÄ±k Yok'}</div>
                    <div class="text-sm text-gray-600 truncate">${d.description || 'AÃ§Ä±klama Yok'}</div>
                    <div class="mt-1">${linkDisplay}</div>
                </div>
              </div>
              <button data-id="${docSnap.id}" class="delete-banner-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors mt-3 self-end w-full sm:w-auto"><i class="ri-delete-bin-line"></i> Sil</button>
            `;
            el.querySelector(".delete-banner-btn").addEventListener("click",async(e)=>{ 
                const id = e.target.dataset.id;
                await deleteDoc(doc(db,"homeBanners",id)); 
                await loadBanners(); 
                showMsg("Banner silindi!", false); 
            });
            bannerList.appendChild(el);
        });
    } catch (e) {
        showMsg("Banner yÃ¼kleme hatasÄ±: " + e.message, true);
    }
}

// --- CATEGORY CRUD (Ekleme, GÃ¼ncelleme, DÃ¼zenleme, Silme) ---

// Kategori Ekleme
addCategoryBtn.addEventListener("click", async ()=>{
    const name=categoryName.value.trim(); 
    const parent = parentCategory.value || null;
    const imageUrl = categoryImage.value.trim() || null; 

    if(!name){showMsg("Kategori adÄ± boÅŸ olamaz", true); return;}
    try{
        await addDoc(collection(db,"homeCategories"),{
            name,
            parent, 
            image: imageUrl, 
            createdAt:new Date()
        });
        resetCategoryForm(false);
        await loadCategories(); 
        showMsg("Kategori baÅŸarÄ±yla eklendi", false);
    }catch(e){
        showMsg("Ekleme hatasÄ±: " + e.message, true);
    }
});

// Kategori GÃ¼ncelleme
updateCategoryBtn.addEventListener("click", async () => {
    const categoryId = editingCategoryId.value;
    const name = categoryName.value.trim();
    const parent = parentCategory.value || null;
    const imageUrl = categoryImage.value.trim() || null;

    if (!categoryId) return;
    if (!name) { showMsg("Kategori adÄ± boÅŸ olamaz", true); return; }

    try {
        const categoryRef = doc(db, "homeCategories", categoryId);
        await updateDoc(categoryRef, {
            name,
            parent,
            image: imageUrl,
            updatedAt: new Date()
        });
        resetCategoryForm(false);
        await loadCategories();
        showMsg("Kategori baÅŸarÄ±yla gÃ¼ncellendi", false);
    } catch (e) {
        showMsg("GÃ¼ncelleme hatasÄ±: " + e.message, true);
    }
});

// Kategori DÃ¼zenleme Moduna GeÃ§iÅŸ
function editCategory(categoryId) {
    const category = Object.values(allAdminCategories).find(c => c.id === categoryId);

    if (category) {
        resetCategoryForm(true); // DÃ¼zenleme moduna geÃ§

        categoryName.value = category.name;
        parentCategory.value = category.parent || "";
        categoryImage.value = category.image || "";
        
        editingCategoryId.value = categoryId;
        editingCategoryNameDisplay.textContent = category.name;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        showMsg("DÃ¼zenlenecek kategori bulunamadÄ±.", true);
    }
}


// YARDIMCI FONKSÄ°YON: Tam hiyerarÅŸi yolunu hesaplar 
function getCategoryHierarchyPath(categoryName) {
    if (!categoryName) return [];
    
    const path = [];
    let currentCategoryName = categoryName;

    while (currentCategoryName && allAdminCategories[currentCategoryName]) {
        path.unshift(currentCategoryName); 
        currentCategoryName = allAdminCategories[currentCategoryName].parent; 
    }
    
    return path;
}


async function loadCategories(){
    if (!auth.currentUser || auth.currentUser.email !== ADMIN_EMAIL) return;

    categoryList.innerHTML="<i class='ri-loader-4-line animate-spin'></i> Kategoriler yÃ¼kleniyor...";
    parentCategory.innerHTML='<option value="">Ãœst Kategori Yok</option>';
    productCategorySelect.innerHTML='<option value="">Kategori seÃ§ (Zorunlu)</option>';
    
    const tempCategoryMap = {};

    try {
        const snap=await getDocs(collection(db,"homeCategories")); 
        categoryList.innerHTML=""; 
        if(snap.empty){ categoryList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek kategori bulunamadÄ±.</p>"; return; }
        
        snap.forEach(docSnap => {
            const d = docSnap.data();
            const catId = docSnap.id;
            
            // TÃ¼m kategori verilerini haritaya kaydet (image dahil)
            tempCategoryMap[d.name] = { id: catId, name: d.name, parent: d.parent || null, image: d.image || null };
            
            // UI listesini oluÅŸtur (GÃ¶rsel ve Parent bilgisiyle)
            const el=document.createElement("div");
            el.className="flex justify-between items-center bg-gray-100 p-2 rounded";
            
            el.innerHTML=`
                <div class="flex items-center gap-3 flex-grow min-w-0">
                    <img src="${d.image || 'https://placehold.co/32x32/5D3EBC/FFFFFF?text=?'}" class="w-8 h-8 object-cover rounded flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/32x32/5D3EBC/FFFFFF?text=?'" />
                    <span class="truncate">${d.parent?d.parent+" > ":""}${d.name}</span> 
                </div>
                <div class="flex gap-2">
                    <button data-id="${catId}" class="edit-category-btn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-sm transition-colors flex items-center gap-1"><i class="ri-edit-line"></i> DÃ¼zenle</button>
                    <button data-id="${catId}" class="delete-category-btn bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm transition-colors flex items-center gap-1"><i class="ri-delete-bin-line"></i> Sil</button>
                </div>
            `;
            
            // Silme Ä°ÅŸlemi
            el.querySelector(".delete-category-btn").addEventListener("click",async(e)=>{ 
                const id = e.target.dataset.id;
                await deleteDoc(doc(db,"homeCategories",id)); 
                await loadCategories(); 
                showMsg("Kategori silindi", false); 
            });
            
            // DÃ¼zenleme Ä°ÅŸlemi
            el.querySelector(".edit-category-btn").addEventListener("click",(e)=>{
                editCategory(e.currentTarget.dataset.id);
            });

            categoryList.appendChild(el);
        });

        allAdminCategories = tempCategoryMap;

        // Select alanlarÄ±nÄ± doldur
        Object.values(allAdminCategories).forEach(cat => {
            const path = getCategoryHierarchyPath(cat.name).join(' > ');
            parentCategory.innerHTML += `<option value="${cat.name}">${path}</option>`;
            productCategorySelect.innerHTML += `<option value="${cat.name}">${path}</option>`;
        });


    } catch (e) {
        showMsg("Kategori yÃ¼kleme hatasÄ±: " + e.message, true);
    }
}

// --- PRODUCT DÃœZENLEME MANTIÄžI (AynÄ± KaldÄ±) ---
function editProduct(productId) {
    const product = currentProducts.find(p => p.id === productId);

    if (product) {
        
        resetProductForm(true); 

        productVariants = Array.isArray(product.variants) ? product.variants.map(v => ({ ...v })) : []; 
        renderVariants();
        
        productName.value = product.name || '';
        productPrice.value = product.price || '';
        productOldPrice.value = product.old_price || ''; 
        productCategorySelect.value = product.category || '';
        productImage.value = product.image || '';
        productImagePreview.src = product.image || 'https://placehold.co/300x96/f0f0f0/666?text=Ana+Gorsel+Onizlemesi';

        productVideo.value = product.video || '';
        productDescription.value = product.description || '';
        productActive.checked = product.active || false;
        
        const existingExtraImages = Array.isArray(product.extraImages) ? product.extraImages : [];
        existingExtraImages.forEach(url => {
            addExtraImageInput(url);
        });

        editingProductId.value = productId;
        editingProductName.textContent = product.name;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        showMsg("DÃ¼zenlenecek Ã¼rÃ¼n bulunamadÄ±.", true);
    }
}

updateProductBtn.addEventListener("click", async () => {
    const productId = editingProductId.value;
    if (!productId) return; 

    const name = productName.value.trim();
    const price = parseFloat(productPrice.value);
    const oldPriceRaw = productOldPrice.value.trim();
    const oldPrice = oldPriceRaw ? parseFloat(oldPriceRaw) : null;

    const category = productCategorySelect.value;
    const image = productImage.value.trim();
    const video = productVideo.value.trim();
    const extraImages = collectExtraImages(); 
    const desc = productDescription.value.trim();
    const active = productActive.checked;
    const variants = productVariants;
    
    const hierarchy = getCategoryHierarchyPath(category);


    if (!name || isNaN(price) || !category || !image) { 
        showMsg("ÃœrÃ¼n adÄ±, fiyat, kategori ve ana gÃ¶rsel zorunludur.", true); 
        return; 
    }
    
    if (oldPrice !== null && isNaN(oldPrice)) {
        showMsg("Eski fiyat geÃ§erli bir sayÄ± olmalÄ±dÄ±r.", true);
        return;
    }

    try {
        const productRef = doc(db, "homeProducts", productId);
        await updateDoc(productRef, {
            name, price, old_price: oldPrice, category, hierarchy, image, video, extraImages, description: desc, active, variants,
            updatedAt: new Date()
        });
        resetProductForm(false); 
        await loadProducts(); 
        showMsg("ÃœrÃ¼n baÅŸarÄ±yla gÃ¼ncellendi!", false);
    } catch (e) {
        showMsg("GÃ¼ncelleme hatasÄ±: " + e.message, true);
    }
});


// --- PRODUCT CRUD (ADD/DELETE/LOAD) (AynÄ± KaldÄ±) ---
addProductBtn.addEventListener("click", async ()=>{
    if(editingProductId.value) return; 

    const name=productName.value.trim();
    const price=parseFloat(productPrice.value); 
    
    const oldPriceRaw = productOldPrice.value.trim();
    const oldPrice = oldPriceRaw ? parseFloat(oldPriceRaw) : null;
    
    const category=productCategorySelect.value;
    const image=productImage.value.trim();
    const video=productVideo.value.trim();
    const extraImages = collectExtraImages(); 
    const desc=productDescription.value.trim();
    const active=productActive.checked;
    const variants = productVariants;

    const hierarchy = getCategoryHierarchyPath(category);


    if (!name || isNaN(price) || !category || !image) { 
        showMsg("ÃœrÃ¼n adÄ±, fiyat, kategori ve ana gÃ¶rsel zorunludur.", true); 
        return; 
    }
    
    if (oldPrice !== null && isNaN(oldPrice)) {
        showMsg("Eski fiyat geÃ§erli bir sayÄ± olmalÄ±dÄ±r.", true);
        return;
    }

    try{
        await addDoc(collection(db,"homeProducts"),{
            name,price,old_price: oldPrice, category, hierarchy, image, video, extraImages, description:desc, active, variants, createdAt:new Date()
        });
        resetProductForm(false);
        await loadProducts(); 
        showMsg("ÃœrÃ¼n baÅŸarÄ±yla eklendi", false);
    }catch(e){ 
        showMsg("Ekleme hatasÄ±: " + e.message, true);
    }
});
refreshProductsBtn.addEventListener("click",loadProducts);

async function loadProducts(){
    if (!auth.currentUser || auth.currentUser.email !== ADMIN_EMAIL) return;

    productList.innerHTML="<i class='ri-loader-4-line animate-spin'></i> ÃœrÃ¼nler yÃ¼kleniyor...";
    try {
        const snap=await getDocs(collection(db,"homeProducts")); 
        productList.innerHTML="";
        currentProducts = [];

        if(snap.empty){ productList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek Ã¼rÃ¼n bulunamadÄ±.</p>"; return; }

        snap.forEach(docSnap=>{
            const d=docSnap.data();
            currentProducts.push({ id: docSnap.id, ...d });
            
            const currentPrice = d.price || 0;
            const oldPrice = d.old_price || 0;
            
            let priceHtml;
            if (oldPrice > currentPrice) {
                priceHtml = `<div class="flex items-end gap-2">
                    <span class="font-extrabold text-xl text-primary">${currentPrice.toFixed(2)} â‚º</span>
                    <span class="text-sm text-gray-400 line-through">${oldPrice.toFixed(2)} â‚º</span>
                </div>`;
            } else {
                priceHtml = `<span class="font-extrabold text-xl text-primary">${currentPrice.toFixed(2)} â‚º</span>`;
            }
            
            const extraImagesCount = Array.isArray(d.extraImages) ? d.extraImages.length : 0;
            const totalVariantImages = (d.variants || []).reduce((sum, v) => sum + (Array.isArray(v.extraImages) ? v.extraImages.length : 0), 0);
            const totalVariantVideos = (d.variants || []).reduce((sum, v) => sum + (Array.isArray(v.extraVideos) ? v.extraVideos.length : 0), 0);
            
            const allMedia = [
                ...(d.extraImages || []),
                ...(d.variants || []).flatMap(v => v.extraImages || [])
            ].filter(url => url && typeof url === 'string');
            
            const extraImagesCountHtml = extraImagesCount > 0 
                ? `<span class="text-xs text-gray-500 mr-2 flex items-center gap-1"><i class="ri-image-line"></i> ${extraImagesCount} Ek</span>`
                : '';
            
            const variantMediaHtml = (totalVariantImages > 0 || totalVariantVideos > 0 || (Array.isArray(d.variants) && d.variants.length > 0))
                ? `<div class="text-xs text-purple-600 mt-1 flex items-center gap-2">
                    <i class="ri-list-check"></i> ${d.variants ? d.variants.length : 0} Varyant
                    ${totalVariantImages > 0 ? `<span class="text-green-600 flex items-center"><i class="ri-image-line"></i> ${totalVariantImages} GÃ¶rsel</span>` : ''}
                    ${totalVariantVideos > 0 ? `<span class="text-blue-600 flex items-center"><i class="ri-video-line"></i> ${totalVariantVideos} Video</span>` : ''}
                  </div>`
                : '';

            const allMediaPreview = allMedia.map(url => `
                <img src="${url}" 
                    class="w-10 h-10 object-cover inline-block mr-1 my-1 rounded border product-image-preview" 
                    onerror="this.onerror=null;this.src='https://placehold.co/40x40/ccc/fff?text=?'">
            `).join("");


            const el=document.createElement("div");
            el.className="p-3 bg-white rounded shadow-md flex flex-col justify-between";
            
            el.innerHTML=`
              <div>
                <div class="font-semibold text-lg">${d.name} <span class="text-xs ${d.active?"text-green-600":"text-red-600"}">${d.active?"(Aktif)":"(Pasif)"}</span></div>
                <div class="text-sm text-gray-600">${d.category}</div>
                <div class="text-sm my-1">${d.description||""}</div>
                <div class="text-primary font-bold text-xl">${priceHtml}</div>
                
                <img src="${d.image}" class="w-full h-36 object-cover my-2 rounded border product-image-preview" onerror="this.onerror=null;this.src='https://placehold.co/300x144/ccc/fff?text=Gorsel+Yok';" />
                
                <div class="mt-2 flex items-center flex-wrap">
                    ${extraImagesCountHtml}
                    ${d.video ? `<span class="text-xs text-blue-500 mr-2 flex items-center gap-1"><i class="ri-video-line"></i> Ana Video</span>` : ''}
                </div>

                <div class="mt-2 border-t pt-2">
                    <p class="text-xs font-semibold text-gray-700 mb-1">Ek Medya Ã–nizlemesi (${allMedia.length} Adet GÃ¶rsel):</p>
                    <div class="flex flex-wrap max-h-24 overflow-y-auto">
                        ${allMedia.length > 0 ? allMediaPreview : '<span class="text-xs text-gray-400">Ek medya yok.</span>'}
                    </div>
                </div>

                ${variantMediaHtml}
              </div>
              <div class="flex gap-2 mt-3 pt-3 border-t">
                <button data-id="${docSnap.id}" class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition-colors flex items-center gap-1"><i class="ri-edit-line"></i> DÃ¼zenle</button>
                <button data-id="${docSnap.id}" class="delete-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors flex items-center gap-1"><i class="ri-delete-bin-line"></i> Sil</button>
              </div>
            `;
            
            el.querySelector(".delete-btn").addEventListener("click",async(e)=>{ 
                const id = e.target.dataset.id;
                await deleteDoc(doc(db,"homeProducts",id)); 
                await loadProducts(); 
                showMsg("ÃœrÃ¼n silindi", false); 
            });

            el.querySelector(".edit-btn").addEventListener("click", (e) => {
                editProduct(e.target.dataset.id);
            });

            productList.appendChild(el);
        });
    } catch (e) {
        showMsg("ÃœrÃ¼n yÃ¼kleme hatasÄ±: " + e.message, true);
    }
}
</script>
</body>
</html>
