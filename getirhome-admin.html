<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Getir Home Admin | Getir KÄ±brÄ±s</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow p-4">
  <div class="max-w-6xl mx-auto flex items-center justify-between">
    <h1 class="text-xl font-bold text-blue-700">Getir Home â€” YÃ¶netim</h1>
    <div class="flex items-center gap-3">
      <span id="admin-email" class="text-gray-600"></span>
      <button id="logoutBtn" class="text-sm text-red-600 hidden">Ã‡Ä±kÄ±ÅŸ Yap</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-6">

<section id="login-screen" class="text-center py-12 hidden">
  <h2 class="text-2xl mb-4">Admin GiriÅŸi</h2>
  <button id="googleSignIn" class="bg-blue-600 text-white px-5 py-2 rounded">Google ile GiriÅŸ Yap</button>
</section>

<section id="admin-panel" class="hidden card bg-white p-6">

  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-semibold">YÃ¶netim Paneli</h2>
      <p class="text-sm text-gray-500">Banner, Kategori ve ÃœrÃ¼n yÃ¶netimi</p>
    </div>
    <div class="flex gap-2">
      <button id="tabBanner" class="px-4 py-2 bg-blue-600 text-white rounded">Banner</button>
      <button id="tabCategory" class="px-4 py-2 bg-gray-100 rounded">Kategori</button>
      <button id="tabProduct" class="px-4 py-2 bg-gray-100 rounded">ÃœrÃ¼n</button>
    </div>
  </div>

  <div id="sectionBanner">
    <h3 class="font-semibold mb-3">ðŸ–¼ Banner YÃ¶netimi</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
      <input id="bannerUrl" placeholder="Banner gÃ¶rsel URL" class="border p-2 rounded col-span-2" />
      <div class="flex gap-2">
        <button id="addBannerBtn" class="bg-green-600 text-white px-4 py-2 rounded">Ekle</button>
        <button id="refreshBannerBtn" class="bg-gray-200 px-4 py-2 rounded">Yenile</button>
      </div>
    </div>
    <div id="bannerList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
  </div>

  <div id="sectionCategory" class="hidden">
    <h3 class="font-semibold mb-3">ðŸ—‚ Kategori YÃ¶netimi</h3>
    <div class="flex gap-3 mb-4">
      <input id="categoryName" placeholder="Kategori adÄ±" class="border p-2 rounded w-full" />
      <select id="parentCategory" class="border p-2 rounded">
        <option value="">Ãœst Kategori</option>
      </select>
      <button id="addCategoryBtn" class="bg-green-600 text-white px-4 py-2 rounded">Ekle</button>
    </div>
    <div id="categoryList" class="space-y-2"></div>
  </div>

  <div id="sectionProduct" class="hidden">
    <h3 class="font-semibold mb-3">ðŸ›’ ÃœrÃ¼n YÃ¶netimi</h3>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
      <input id="productName" placeholder="ÃœrÃ¼n adÄ±" class="border p-2 rounded" />
      <input id="productPrice" placeholder="Fiyat (â‚º)" class="border p-2 rounded" />
      <select id="productCategorySelect" class="border p-2 rounded">
        <option value="">Kategori seÃ§</option>
      </select>
      <input id="productDescription" placeholder="ÃœrÃ¼n aÃ§Ä±klamasÄ±" class="border p-2 rounded md:col-span-3" />
      <input id="productImage" placeholder="Ana gÃ¶rsel URL" class="border p-2 rounded" />
      <input id="productVideo" placeholder="Video URL (opsiyonel)" class="border p-2 rounded" />
      <input id="productExtraImages" placeholder="Ek gÃ¶rseller (URL, virgÃ¼l ile)" class="border p-2 rounded md:col-span-3" />
      <input id="productActive" type="checkbox" class="mt-2" /> <label class="text-sm">Aktif</label>
    </div>

    <div class="flex gap-2 mb-6">
      <button id="addProductBtn" class="bg-blue-600 text-white px-4 py-2 rounded">ÃœrÃ¼n Ekle</button>
      <button id="refreshProductsBtn" class="bg-gray-200 px-4 py-2 rounded">Yenile</button>
    </div>

    <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
  </div>

</section>

<div id="msg" class="mt-4 text-sm text-red-600"></div>
</main>

<footer class="text-center text-gray-400 py-8">
Â© 2025 Getir KÄ±brÄ±s
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
  authDomain: "kibris-6b4f7.firebaseapp.com",
  projectId: "kibris-6b4f7",
  storageBucket: "kibris-6b4f7.appspot.com",
  messagingSenderId: "141262926171",
  appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
  measurementId: "G-JL9P6BRZTD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();
const ADMIN_EMAIL = "emirmob09@gmail.com";

const loginScreen = document.getElementById("login-screen");
const googleSignIn = document.getElementById("googleSignIn");
const adminPanel = document.getElementById("admin-panel");
const adminEmailSpan = document.getElementById("admin-email");
const logoutBtn = document.getElementById("logoutBtn");
const msg = document.getElementById("msg");

const tabBanner = document.getElementById("tabBanner");
const tabCategory = document.getElementById("tabCategory");
const tabProduct = document.getElementById("tabProduct");
const sectionBanner = document.getElementById("sectionBanner");
const sectionCategory = document.getElementById("sectionCategory");
const sectionProduct = document.getElementById("sectionProduct");

const bannerUrl = document.getElementById("bannerUrl");
const addBannerBtn = document.getElementById("addBannerBtn");
const bannerList = document.getElementById("bannerList");
const refreshBannerBtn = document.getElementById("refreshBannerBtn");

const categoryName = document.getElementById("categoryName");
const parentCategory = document.getElementById("parentCategory");
const addCategoryBtn = document.getElementById("addCategoryBtn");
const categoryList = document.getElementById("categoryList");

const productName = document.getElementById("productName");
const productPrice = document.getElementById("productPrice");
const productCategorySelect = document.getElementById("productCategorySelect");
const productImage = document.getElementById("productImage");
const productVideo = document.getElementById("productVideo");
const productExtraImages = document.getElementById("productExtraImages");
const productDescription = document.getElementById("productDescription");
const addProductBtn = document.getElementById("addProductBtn");
const productList = document.getElementById("productList");
const refreshProductsBtn = document.getElementById("refreshProductsBtn");
const productActive = document.getElementById("productActive");

// --- YARDIMCI ---
function showMsg(text, isError=true){ msg.textContent=text; msg.style.color=isError?"#b91c1c":"#065f46"; if(text) setTimeout(()=>{msg.textContent="";},5000);}
function activateTab(target){
  [sectionBanner,sectionCategory,sectionProduct].forEach(s=>s.classList.add("hidden"));
  [tabBanner,tabCategory,tabProduct].forEach(t=>t.classList.remove("bg-blue-600","text-white"));
  if(target==="banner"){sectionBanner.classList.remove("hidden"); tabBanner.classList.add("bg-blue-600","text-white");}
  if(target==="category"){sectionCategory.classList.remove("hidden"); tabCategory.classList.add("bg-blue-600","text-white");}
  if(target==="product"){sectionProduct.classList.remove("hidden"); tabProduct.classList.add("bg-blue-600","text-white");}
}
tabBanner.addEventListener("click",()=>activateTab("banner"));
tabCategory.addEventListener("click",()=>activateTab("category"));
tabProduct.addEventListener("click",()=>activateTab("product"));

// --- AUTH ---
onAuthStateChanged(auth, async (user)=>{
  try{
    if(!user){ loginScreen.classList.remove("hidden"); adminPanel.classList.add("hidden"); logoutBtn.classList.add("hidden"); adminEmailSpan.textContent=""; return; }
    if(user.email!==ADMIN_EMAIL){ alert("Bu panel sadece admin iÃ§in."); await signOut(auth); window.location.href="/getirhome.html"; return; }
    loginScreen.classList.add("hidden"); adminPanel.classList.remove("hidden"); logoutBtn.classList.remove("hidden"); adminEmailSpan.textContent=user.email;

    await loadBanners();
    await loadCategories();
    await loadProducts();
  }catch(e){ console.error(e); showMsg("Yetki hatasÄ±: "+e.message);}
});

googleSignIn.addEventListener("click",async()=>{ try{ await signInWithPopup(auth,provider);}catch(e){alert("GiriÅŸ hatasÄ±: "+e.message);} });
logoutBtn.addEventListener("click",async()=>{ await signOut(auth); window.location.href="/getirhome.html"; });

// --- BANNER CRUD ---
addBannerBtn.addEventListener("click", async ()=>{
  const url=bannerUrl.value.trim();
  if(!url){ showMsg("URL boÅŸ olamaz"); return;}
  // DÃ¼zeltme: "homeBanners"
  try{ await addDoc(collection(db,"homeBanners"),{url, createdAt:new Date()}); bannerUrl.value=""; await loadBanners(); showMsg("Banner eklendi!",false);}catch(e){ showMsg(e.message);}
});
refreshBannerBtn.addEventListener("click",loadBanners);

async function loadBanners(){
  bannerList.innerHTML="YÃ¼kleniyor...";
  // DÃ¼zeltme: "homeBanners"
  const snap=await getDocs(collection(db,"homeBanners"));
  bannerList.innerHTML="";
  
  // GÃœVENLÄ°K KONTROLÃœ
  if(snap.empty){
    bannerList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek banner bulunamadÄ±.</p>";
    return;
  }
  
  snap.forEach(docSnap=>{
    const d=docSnap.data();
    const el=document.createElement("div");
    el.className="flex justify-between items-center bg-gray-100 p-2 rounded";
    el.innerHTML=`<span>${d.url}</span> <button class="bg-red-600 text-white px-2 py-1 rounded">Sil</button>`;
    // DÃ¼zeltme: "homeBanners"
    el.querySelector("button").addEventListener("click",async()=>{ await deleteDoc(doc(db,"homeBanners",docSnap.id)); await loadBanners(); showMsg("Silindi!",false); });
    bannerList.appendChild(el);
  });
}

// --- CATEGORY CRUD ---
addCategoryBtn.addEventListener("click", async ()=>{
  const name=categoryName.value.trim(); if(!name){showMsg("Kategori adÄ± boÅŸ"); return;}
  try{
    // DÃ¼zeltme: "homeCategories"
    await addDoc(collection(db,"homeCategories"),{name,parent:parentCategory.value||null, createdAt:new Date()});
    categoryName.value=""; await loadCategories(); showMsg("Kategori eklendi",false);
  }catch(e){showMsg(e.message);}
});

async function loadCategories(){
  categoryList.innerHTML="YÃ¼kleniyor...";
  parentCategory.innerHTML='<option value="">Ãœst Kategori</option>';
  productCategorySelect.innerHTML='<option value="">Kategori seÃ§</option>';
  // DÃ¼zeltme: "homeCategories"
  const snap=await getDocs(collection(db,"homeCategories")); 
  categoryList.innerHTML="";Â 
  
  // GÃœVENLÄ°K KONTROLÃœ
  if(snap.empty){
    categoryList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek kategori bulunamadÄ±.</p>";
    return;
  }
  
  snap.forEach(docSnap=>{
    const d=docSnap.data();
    const el=document.createElement("div");
    el.className="flex justify-between items-center bg-gray-100 p-2 rounded";
    el.innerHTML=`<span>${d.parent?d.parent+" > ":""}${d.name}</span> <button class="bg-red-600 text-white px-2 py-1 rounded">Sil</button>`;
    // DÃ¼zeltme: "homeCategories"
    el.querySelector("button").addEventListener("click",async()=>{ await deleteDoc(doc(db,"homeCategories",docSnap.id)); await loadCategories(); showMsg("Silindi",false); });
    categoryList.appendChild(el);
    parentCategory.innerHTML+=`<option value="${d.name}">${d.name}</option>`;
    productCategorySelect.innerHTML+=`<option value="${d.name}">${d.name}</option>`;
  });
}

// --- PRODUCT CRUD ---
addProductBtn.addEventListener("click", async ()=>{
  const name=productName.value.trim();
  const price=parseFloat(productPrice.value);Â 
  const category=productCategorySelect.value;
  const image=productImage.value.trim();
  const video=productVideo.value.trim();
  // BoÅŸluklarÄ± temizler ve boÅŸ dizeleri filtreler
  const extraImages=productExtraImages.value.trim().split(",").map(x=>x.trim()).filter(Boolean); 
  const desc=productDescription.value.trim();
  const active=productActive.checked;

  if(!name || !price || !category || !image){ showMsg("ÃœrÃ¼n adÄ±, fiyat, kategori ve ana gÃ¶rsel zorunlu"); return; }
  try{
    // DÃ¼zeltme: "homeProducts"
    await addDoc(collection(db,"homeProducts"),{name,price,category,image,video,extraImages,description:desc,active,createdAt:new Date()});
    productName.value=""; productPrice.value=""; productCategorySelect.value=""; productImage.value=""; productVideo.value=""; productExtraImages.value=""; productDescription.value=""; productActive.checked=false;
    await loadProducts(); showMsg("ÃœrÃ¼n eklendi",false);
  }catch(e){ showMsg(e.message);}
});
refreshProductsBtn.addEventListener("click",loadProducts);

async function loadProducts(){
  productList.innerHTML="YÃ¼kleniyor...";
  // DÃ¼zeltme: "homeProducts"
  const snap=await getDocs(collection(db,"homeProducts")); 
  productList.innerHTML="";
  
  // GÃœVENLÄ°K KONTROLÃœ
  if(snap.empty){
    productList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek Ã¼rÃ¼n bulunamadÄ±.</p>";
    return;
  }

  snap.forEach(docSnap=>{
    const d=docSnap.data();
    const el=document.createElement("div");
    el.className="p-3 bg-gray-100 rounded";
    
    // MAP HATASI DÃœZELTMESÄ° (d.extraImages'Ä±n dizi olup olmadÄ±ÄŸÄ±nÄ± kontrol eder)
    const extraImagesHtml = (Array.isArray(d.extraImages) && d.extraImages.length > 0) 
      ? d.extraImages.map(url => `<img src="${url}" class="w-20 h-20 object-cover inline-block mr-2 my-1 rounded">`).join("")
      : ''; 

    el.innerHTML=`
      <div class="font-semibold">${d.name} ${d.active?"(Aktif)":"(Pasif)"}</div>
      <div class="text-sm text-gray-600">${d.category}</div>
      <div class="text-sm">${d.description||""}</div>
      <div class="text-blue-600 font-bold">${d.price} â‚º</div>
      <img src="${d.image}" class="w-full h-36 object-cover my-2 rounded" />
      ${d.video?`<video src="${d.video}" controls class="w-full h-36 my-2 rounded"></video>`:""}
      ${extraImagesHtml}
      <button class="mt-2 bg-red-600 text-white px-2 py-1 rounded">Sil</button>
    `;
    // DÃ¼zeltme: "homeProducts"
    el.querySelector("button").addEventListener("click",async()=>{ await deleteDoc(doc(db,"homeProducts",docSnap.id)); await loadProducts(); showMsg("ÃœrÃ¼n silindi",false); });
    productList.appendChild(el);
  });
}
</script>
</body>
</html>
