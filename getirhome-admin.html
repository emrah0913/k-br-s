<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Getir Home Admin | Getir KÄ±brÄ±s</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
Â  .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow p-4">
Â  <div class="max-w-6xl mx-auto flex items-center justify-between">
Â  Â  <h1 class="text-xl font-bold text-blue-700">Getir Home â€” YÃ¶netim</h1>
Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  <span id="admin-email" class="text-gray-600"></span>
Â  Â  Â  <button id="logoutBtn" class="text-sm text-red-600 hidden">Ã‡Ä±kÄ±ÅŸ Yap</button>
Â  Â  </div>
Â  </div>
</header>

<main class="max-w-6xl mx-auto p-6">

<section id="login-screen" class="text-center py-12 hidden">
Â  <h2 class="text-2xl mb-4">Admin GiriÅŸi</h2>
Â  <button id="googleSignIn" class="bg-blue-600 text-white px-5 py-2 rounded">Google ile GiriÅŸ Yap</button>
</section>

<section id="admin-panel" class="hidden card bg-white p-6">

Â  <div class="flex items-center justify-between mb-6">
Â  Â  <div>
Â  Â  Â  <h2 class="text-2xl font-semibold">YÃ¶netim Paneli</h2>
Â  Â  Â  <p class="text-sm text-gray-500">Banner, Kategori ve ÃœrÃ¼n yÃ¶netimi</p>
Â  Â  </div>
Â  Â  <div class="flex gap-2">
Â  Â  Â  <button id="tabBanner" class="px-4 py-2 bg-blue-600 text-white rounded">Banner</button>
Â  Â  Â  <button id="tabCategory" class="px-4 py-2 bg-gray-100 rounded">Kategori</button>
Â  Â  Â  <button id="tabProduct" class="px-4 py-2 bg-gray-100 rounded">ÃœrÃ¼n</button>
Â  Â  </div>
Â  </div>

Â  <div id="sectionBanner">
Â  Â  <h3 class="font-semibold mb-3">ðŸ–¼ Banner YÃ¶netimi</h3>
Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
Â  Â  Â  <input id="bannerUrl" placeholder="Banner gÃ¶rsel URL" class="border p-2 rounded col-span-2" />
Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  <button id="addBannerBtn" class="bg-green-600 text-white px-4 py-2 rounded">Ekle</button>
Â  Â  Â  Â  <button id="refreshBannerBtn" class="bg-gray-200 px-4 py-2 rounded">Yenile</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="bannerList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
Â  </div>

Â  <div id="sectionCategory" class="hidden">
Â  Â  <h3 class="font-semibold mb-3">ðŸ—‚ Kategori YÃ¶netimi</h3>
Â  Â  <div class="flex gap-3 mb-4">
Â  Â  Â  <input id="categoryName" placeholder="Kategori adÄ±" class="border p-2 rounded w-full" />
Â  Â  Â  <select id="parentCategory" class="border p-2 rounded">
Â  Â  Â  Â  <option value="">Ãœst Kategori</option>
Â  Â  Â  </select>
Â  Â  Â  <button id="addCategoryBtn" class="bg-green-600 text-white px-4 py-2 rounded">Ekle</button>
Â  Â  </div>
Â  Â  <div id="categoryList" class="space-y-2"></div>
Â  </div>

Â  <div id="sectionProduct" class="hidden">
Â  Â  <h3 class="font-semibold mb-3">ðŸ›’ ÃœrÃ¼n YÃ¶netimi</h3>

    <div id="editingStatus" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-4 hidden" role="alert">
        <p class="font-bold">DÃ¼zenleme Modu:</p>
        <p id="editingProductName"></p>
        <input type="hidden" id="editingProductId" />
    </div>

Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
Â  Â  Â  <input id="productName" placeholder="ÃœrÃ¼n adÄ±" class="border p-2 rounded" />
Â  Â  Â  <input id="productPrice" placeholder="Fiyat (â‚º)" class="border p-2 rounded" type="number" step="0.01"/>
Â  Â  Â  <select id="productCategorySelect" class="border p-2 rounded">
Â  Â  Â  Â  <option value="">Kategori seÃ§</option>
Â  Â  Â  </select>
Â  Â  Â  <input id="productDescription" placeholder="ÃœrÃ¼n aÃ§Ä±klamasÄ±" class="border p-2 rounded md:col-span-3" />
Â  Â  Â  <input id="productImage" placeholder="Ana gÃ¶rsel URL" class="border p-2 rounded" />
Â  Â  Â  <input id="productVideo" placeholder="Video URL (opsiyonel)" class="border p-2 rounded" />
Â  Â  Â  <input id="productExtraImages" placeholder="Ek gÃ¶rseller (URL, virgÃ¼l ile)" class="border p-2 rounded md:col-span-3" />
Â  Â  Â  <div class="flex items-center gap-2">
            <input id="productActive" type="checkbox" class="mt-2" /> 
            <label for="productActive" class="text-sm">Aktif</label>
        </div>
Â  Â  </div>

Â  Â  <div class="flex gap-2 mb-6">
Â  Â  Â  <button id="addProductBtn" class="bg-blue-600 text-white px-4 py-2 rounded">ÃœrÃ¼n Ekle</button>
      <button id="updateProductBtn" class="bg-yellow-600 text-white px-4 py-2 rounded hidden">Kaydet ve GÃ¼ncelle</button>
      <button id="cancelEditBtn" class="bg-gray-400 text-white px-4 py-2 rounded hidden">Ä°ptal</button>
Â  Â  Â  <button id="refreshProductsBtn" class="bg-gray-200 px-4 py-2 rounded">Yenile</button>
Â  Â  </div>

Â  Â  <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
Â  </div>

</section>

<div id="msg" class="mt-4 text-sm text-red-600"></div>
</main>

<footer class="text-center text-gray-400 py-8">
Â© 2025 Getir KÄ±brÄ±s
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
// setDoc/updateDoc fonksiyonunu kullanmak iÃ§in updateDoc ekledik.
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
Â  authDomain: "kibris-6b4f7.firebaseapp.com",
Â  projectId: "kibris-6b4f7",
Â  storageBucket: "kibris-6b4f7.appspot.com",
Â  messagingSenderId: "141262926171",
Â  appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
Â  measurementId: "G-JL9P6BRZTD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();
const ADMIN_EMAIL = "emirmob09@gmail.com";

const loginScreen = document.getElementById("login-screen");
const googleSignIn = document.getElementById("googleSignIn");
const adminPanel = document.getElementById("admin-panel");
const adminEmailSpan = document.getElementById("admin-email");
const logoutBtn = document.getElementById("logoutBtn");
const msg = document.getElementById("msg");

// --- Tablar ---
const tabBanner = document.getElementById("tabBanner");
const tabCategory = document.getElementById("tabCategory");
const tabProduct = document.getElementById("tabProduct");
const sectionBanner = document.getElementById("sectionBanner");
const sectionCategory = document.getElementById("sectionCategory");
const sectionProduct = document.getElementById("sectionProduct");

// --- Banner AlanlarÄ± ---
const bannerUrl = document.getElementById("bannerUrl");
const addBannerBtn = document.getElementById("addBannerBtn");
const bannerList = document.getElementById("bannerList");
const refreshBannerBtn = document.getElementById("refreshBannerBtn");

// --- Kategori AlanlarÄ± ---
const categoryName = document.getElementById("categoryName");
const parentCategory = document.getElementById("parentCategory");
const addCategoryBtn = document.getElementById("addCategoryBtn");
const categoryList = document.getElementById("categoryList");

// --- ÃœrÃ¼n AlanlarÄ± ---
const productName = document.getElementById("productName");
const productPrice = document.getElementById("productPrice");
const productCategorySelect = document.getElementById("productCategorySelect");
const productImage = document.getElementById("productImage");
const productVideo = document.getElementById("productVideo");
const productExtraImages = document.getElementById("productExtraImages");
const productDescription = document.getElementById("productDescription");
const productActive = document.getElementById("productActive");

const addProductBtn = document.getElementById("addProductBtn");
const updateProductBtn = document.getElementById("updateProductBtn"); // YENÄ°
const cancelEditBtn = document.getElementById("cancelEditBtn"); // YENÄ°
const productList = document.getElementById("productList");
const refreshProductsBtn = document.getElementById("refreshProductsBtn");
const editingStatus = document.getElementById("editingStatus"); // YENÄ°
const editingProductName = document.getElementById("editingProductName"); // YENÄ°
const editingProductId = document.getElementById("editingProductId"); // YENÄ°

let currentProducts = []; // ÃœrÃ¼nleri global olarak tutmak iÃ§in

// --- YARDIMCI ---
function showMsg(text, isError=true){ msg.textContent=text; msg.style.color=isError?"#b91c1c":"#065f46"; if(text) setTimeout(()=>{msg.textContent="";},5000);}

// Formu temizler ve Ekle/GÃ¼ncelle butonlarÄ±nÄ± yÃ¶netir
function resetProductForm(isEditing = false) {
    productName.value = "";
    productPrice.value = "";
    productCategorySelect.value = "";
    productImage.value = "";
    productVideo.value = "";
    productExtraImages.value = "";
    productDescription.value = "";
    productActive.checked = false;
    editingProductId.value = "";

    if (isEditing) {
        addProductBtn.classList.add("hidden");
        updateProductBtn.classList.remove("hidden");
        cancelEditBtn.classList.remove("hidden");
        editingStatus.classList.remove("hidden");
    } else {
        addProductBtn.classList.remove("hidden");
        updateProductBtn.classList.add("hidden");
        cancelEditBtn.classList.add("hidden");
        editingStatus.classList.add("hidden");
    }
}

function activateTab(target){
Â  [sectionBanner,sectionCategory,sectionProduct].forEach(s=>s.classList.add("hidden"));
Â  [tabBanner,tabCategory,tabProduct].forEach(t=>t.classList.remove("bg-blue-600","text-white"));
Â  if(target==="banner"){sectionBanner.classList.remove("hidden"); tabBanner.classList.add("bg-blue-600","text-white");}
Â  if(target==="category"){sectionCategory.classList.remove("hidden"); tabCategory.classList.add("bg-blue-600","text-white");}
Â  if(target==="product"){sectionProduct.classList.remove("hidden"); tabProduct.classList.add("bg-blue-600","text-white"); resetProductForm(false);} // ÃœrÃ¼n sekmesine geÃ§ince formu sÄ±fÄ±rla
}

tabBanner.addEventListener("click",()=>activateTab("banner"));
tabCategory.addEventListener("click",()=>activateTab("category"));
tabProduct.addEventListener("click",()=>activateTab("product"));
cancelEditBtn.addEventListener("click",()=>resetProductForm(false)); // Ä°ptal butonu formu sÄ±fÄ±rlar

// --- AUTH ---
onAuthStateChanged(auth, async (user)=>{
Â  try{
Â  Â  if(!user){ loginScreen.classList.remove("hidden"); adminPanel.classList.add("hidden"); logoutBtn.classList.add("hidden"); adminEmailSpan.textContent=""; return; }
Â  Â  if(user.email!==ADMIN_EMAIL){ alert("Bu panel sadece admin iÃ§in."); await signOut(auth); window.location.href="/getirhome.html"; return; }
Â  Â  loginScreen.classList.add("hidden"); adminPanel.classList.remove("hidden"); logoutBtn.classList.remove("hidden"); adminEmailSpan.textContent=user.email;

Â  Â  await loadBanners();
Â  Â  await loadCategories();
Â  Â  await loadProducts();
Â  }catch(e){ console.error(e); showMsg("Yetki hatasÄ±: "+e.message);}
});

googleSignIn.addEventListener("click",async()=>{ try{ await signInWithPopup(auth,provider);}catch(e){alert("GiriÅŸ hatasÄ±: "+e.message);} });
logoutBtn.addEventListener("click",async()=>{ await signOut(auth); window.location.href="/getirhome.html"; });

// --- BANNER CRUD ---
// ... (Banner CRUD kÄ±smÄ± aynÄ± kalmÄ±ÅŸtÄ±r)

addBannerBtn.addEventListener("click", async ()=>{
Â  const url=bannerUrl.value.trim();
Â  if(!url){ showMsg("URL boÅŸ olamaz"); return;}
Â  try{ await addDoc(collection(db,"homeBanners"),{url, createdAt:new Date()}); bannerUrl.value=""; await loadBanners(); showMsg("Banner eklendi!",false);}catch(e){ showMsg(e.message);}
});
refreshBannerBtn.addEventListener("click",loadBanners);

async function loadBanners(){
Â  bannerList.innerHTML="YÃ¼kleniyor...";
Â  const snap=await getDocs(collection(db,"homeBanners"));
Â  bannerList.innerHTML="";
Â Â 
Â  if(snap.empty){
Â  Â  bannerList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek banner bulunamadÄ±.</p>";
Â  Â  return;
Â  }
Â Â 
Â  snap.forEach(docSnap=>{
Â  Â  const d=docSnap.data();
Â  Â  const el=document.createElement("div");
Â  Â  el.className="flex justify-between items-center bg-gray-100 p-2 rounded";
Â  Â  el.innerHTML=`<span>${d.url}</span> <button class="bg-red-600 text-white px-2 py-1 rounded">Sil</button>`;
Â  Â  el.querySelector("button").addEventListener("click",async()=>{ await deleteDoc(doc(db,"homeBanners",docSnap.id)); await loadBanners(); showMsg("Silindi!",false); });
Â  Â  bannerList.appendChild(el);
Â  });
}

// --- CATEGORY CRUD ---
// ... (Category CRUD kÄ±smÄ± aynÄ± kalmÄ±ÅŸtÄ±r)

addCategoryBtn.addEventListener("click", async ()=>{
Â  const name=categoryName.value.trim(); if(!name){showMsg("Kategori adÄ± boÅŸ"); return;}
Â  try{
Â  Â  await addDoc(collection(db,"homeCategories"),{name,parent:parentCategory.value||null, createdAt:new Date()});
Â  Â  categoryName.value=""; await loadCategories(); showMsg("Kategori eklendi",false);
Â  }catch(e){showMsg(e.message);}
});

async function loadCategories(){
Â  categoryList.innerHTML="YÃ¼kleniyor...";
Â  parentCategory.innerHTML='<option value="">Ãœst Kategori</option>';
Â  productCategorySelect.innerHTML='<option value="">Kategori seÃ§</option>';
Â  const snap=await getDocs(collection(db,"homeCategories"));Â 
Â  categoryList.innerHTML="";Â 
Â Â 
Â  if(snap.empty){
Â  Â  categoryList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek kategori bulunamadÄ±.</p>";
Â  Â  return;
Â  }
Â Â 
Â  snap.forEach(docSnap=>{
Â  Â  const d=docSnap.data();
Â  Â  const el=document.createElement("div");
Â  Â  el.className="flex justify-between items-center bg-gray-100 p-2 rounded";
Â  Â  el.innerHTML=`<span>${d.parent?d.parent+" > ":""}${d.name}</span> <button class="bg-red-600 text-white px-2 py-1 rounded">Sil</button>`;
Â  Â  el.querySelector("button").addEventListener("click",async()=>{ await deleteDoc(doc(db,"homeCategories",docSnap.id)); await loadCategories(); showMsg("Silindi",false); });
Â  Â  categoryList.appendChild(el);
Â  Â  parentCategory.innerHTML+=`<option value="${d.name}">${d.name}</option>`;
Â  Â  productCategorySelect.innerHTML+=`<option value="${d.name}">${d.name}</option>`;
Â  });
}

// --- PRODUCT DÃœZENLEME MANTIÄžI ---

// Yeni: ÃœrÃ¼n verilerini form alanlarÄ±na yÃ¼kler
function editProduct(productId) {
    const product = currentProducts.find(p => p.id === productId);

    if (product) {
        productName.value = product.name;
        productPrice.value = product.price;
        productCategorySelect.value = product.category || '';
        productImage.value = product.image || '';
        productVideo.value = product.video || '';
        // Ek gÃ¶rselleri virgÃ¼lle ayrÄ±lmÄ±ÅŸ metne dÃ¶nÃ¼ÅŸtÃ¼r
        productExtraImages.value = (Array.isArray(product.extraImages) ? product.extraImages.join(', ') : '');
        productDescription.value = product.description || '';
        productActive.checked = product.active || false;

        // DÃ¼zenleme modunu aktifleÅŸtir
        editingProductId.value = productId;
        editingProductName.textContent = product.name;
        resetProductForm(true); // DÃ¼zenleme butonlarÄ±nÄ± gÃ¶ster
        window.scrollTo({ top: 0, behavior: 'smooth' }); // SayfayÄ± yukarÄ± kaydÄ±r
    } else {
        showMsg("DÃ¼zenlenecek Ã¼rÃ¼n bulunamadÄ±.", true);
    }
}

// Yeni: ÃœrÃ¼nÃ¼ GÃ¼ncelleme Ä°ÅŸlevi
updateProductBtn.addEventListener("click", async () => {
    const productId = editingProductId.value;
    if (!productId) { showMsg("DÃ¼zenlenecek Ã¼rÃ¼n seÃ§ili deÄŸil.", true); return; }

    const name = productName.value.trim();
    const price = parseFloat(productPrice.value);
    const category = productCategorySelect.value;
    const image = productImage.value.trim();
    const video = productVideo.value.trim();
    const extraImages = productExtraImages.value.trim().split(",").map(x => x.trim()).filter(Boolean);
    const desc = productDescription.value.trim();
    const active = productActive.checked;

    if (!name || !price || !category || !image) { showMsg("ÃœrÃ¼n adÄ±, fiyat, kategori ve ana gÃ¶rsel zorunlu", true); return; }

    try {
        const productRef = doc(db, "homeProducts", productId);
        await updateDoc(productRef, {
            name, price, category, image, video, extraImages, description: desc, active,
            updatedAt: new Date() // GÃ¼ncelleme zamanÄ±nÄ± kaydet
        });
        resetProductForm(false); // Formu temizle ve Ekle moduna dÃ¶n
        await loadProducts(); 
        showMsg("ÃœrÃ¼n baÅŸarÄ±yla gÃ¼ncellendi!", false);
    } catch (e) {
        showMsg("GÃ¼ncelleme hatasÄ±: " + e.message, true);
    }
});


// --- PRODUCT CRUD (ADD/DELETE/LOAD) ---
addProductBtn.addEventListener("click", async ()=>{
Â  // DÃ¼zenleme modunda deÄŸilse ekleme yap
Â  if(editingProductId.value) return; 

Â  const name=productName.value.trim();
Â  const price=parseFloat(productPrice.value);Â 
Â  const category=productCategorySelect.value;
Â  const image=productImage.value.trim();
Â  const video=productVideo.value.trim();
Â  // BoÅŸluklarÄ± temizler ve boÅŸ dizeleri filtreler
Â  const extraImages=productExtraImages.value.trim().split(",").map(x=>x.trim()).filter(Boolean);Â 
Â  const desc=productDescription.value.trim();
Â  const active=productActive.checked;

Â  if(!name || !price || !category || !image){ showMsg("ÃœrÃ¼n adÄ±, fiyat, kategori ve ana gÃ¶rsel zorunlu"); return; }
Â  try{
Â  Â  await addDoc(collection(db,"homeProducts"),{name,price,category,image,video,extraImages,description:desc,active,createdAt:new Date()});
Â  Â  resetProductForm(false);
Â  Â  await loadProducts(); showMsg("ÃœrÃ¼n eklendi",false);
Â  }catch(e){ showMsg(e.message);}
});
refreshProductsBtn.addEventListener("click",loadProducts);

async function loadProducts(){
Â  productList.innerHTML="YÃ¼kleniyor...";
Â  const snap=await getDocs(collection(db,"homeProducts"));Â 
Â  productList.innerHTML="";
  currentProducts = []; // Listeyi sÄ±fÄ±rla
Â Â 
Â  if(snap.empty){
Â  Â  productList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek Ã¼rÃ¼n bulunamadÄ±.</p>";
Â  Â  return;
Â  }

Â  snap.forEach(docSnap=>{
Â  Â  const d=docSnap.data();
    // ÃœrÃ¼nÃ¼ global listeye ekle (dÃ¼zenleme iÃ§in lazÄ±m)
    currentProducts.push({ id: docSnap.id, ...d });

Â  Â  const el=document.createElement("div");
Â  Â  el.className="p-3 bg-gray-100 rounded flex flex-col justify-between";
Â  Â Â 
Â  Â  // MAP HATASI DÃœZELTMESÄ° (d.extraImages'Ä±n dizi olup olmadÄ±ÄŸÄ±nÄ± kontrol eder)
Â  Â  const extraImagesHtml = (Array.isArray(d.extraImages) && d.extraImages.length > 0)Â 
Â  Â  Â  ? d.extraImages.map(url => `<img src="${url}" class="w-20 h-20 object-cover inline-block mr-2 my-1 rounded">`).join("")
Â  Â  Â  : '';Â 

Â  Â  el.innerHTML=`
Â  Â  Â  <div>
Â  Â  Â  Â  <div class="font-semibold">${d.name} <span class="text-xs ${d.active?"text-green-600":"text-red-600"}">${d.active?"(Aktif)":"(Pasif)"}</span></div>
Â  Â  Â  Â  <div class="text-sm text-gray-600">${d.category}</div>
Â  Â  Â  Â  <div class="text-sm">${d.description||""}</div>
Â  Â  Â  Â  <div class="text-blue-600 font-bold">${d.price} â‚º</div>
Â  Â  Â  Â  <img src="${d.image}" class="w-full h-36 object-cover my-2 rounded" />
Â  Â  Â  Â  ${d.video?`<video src="${d.video}" controls class="w-full h-36 my-2 rounded"></video>`:""}
Â  Â  Â  Â  ${extraImagesHtml}
Â  Â  Â  </div>
Â  Â  Â  <div class="flex gap-2 mt-3">
            <button data-id="${docSnap.id}" class="edit-btn bg-yellow-500 text-white px-3 py-1 rounded text-sm">DÃ¼zenle</button>
Â  Â  Â  Â  <button data-id="${docSnap.id}" class="delete-btn bg-red-600 text-white px-3 py-1 rounded text-sm">Sil</button>
      </div>
Â  Â  `;
Â  Â  
    // Silme ve DÃ¼zenleme butonlarÄ± iÃ§in event listener'larÄ± ekle
Â  Â  el.querySelector(".delete-btn").addEventListener("click",async(e)=>{ 
        const id = e.target.dataset.id;
        await deleteDoc(doc(db,"homeProducts",id)); 
        await loadProducts(); 
        showMsg("ÃœrÃ¼n silindi",false); 
    });

    el.querySelector(".edit-btn").addEventListener("click", (e) => {
        editProduct(e.target.dataset.id); // DÃ¼zenleme fonksiyonunu Ã§aÄŸÄ±r
    });

Â  Â  productList.appendChild(el);
Â  });
}
</script>
</body>
</html>
