<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Getir Home Admin | Getir KÄ±brÄ±s</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">
<style>
Â  .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow p-4">
Â  <div class="max-w-6xl mx-auto flex items-center justify-between">
Â  Â  <h1 class="text-xl font-bold text-blue-700">Getir Home â€” YÃ¶netim</h1>
Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  <span id="admin-email" class="text-gray-600"></span>
Â  Â  Â  <button id="logoutBtn" class="text-sm text-red-600 hidden">Ã‡Ä±kÄ±ÅŸ Yap</button>
Â  Â  </div>
Â  </div>
</header>

<main class="max-w-6xl mx-auto p-6">

<section id="login-screen" class="text-center py-12 hidden">
Â  <h2 class="text-2xl mb-4">Admin GiriÅŸi</h2>
Â  <button id="googleSignIn" class="bg-blue-600 text-white px-5 py-2 rounded flex items-center mx-auto gap-2"><i class="ri-google-fill"></i> Google ile GiriÅŸ Yap</button>
</section>

<section id="admin-panel" class="hidden card bg-white p-6">

Â  <div class="flex items-center justify-between mb-6">
Â  Â  <div>
Â  Â  Â  <h2 class="text-2xl font-semibold">YÃ¶netim Paneli</h2>
Â  Â  Â  <p class="text-sm text-gray-500">Banner, Kategori ve ÃœrÃ¼n yÃ¶netimi</p>
Â  Â  </div>
Â  Â  <div class="flex gap-2">
Â  Â  Â  <button id="tabBanner" class="px-4 py-2 bg-blue-600 text-white rounded">Banner</button>
Â  Â  Â  <button id="tabCategory" class="px-4 py-2 bg-gray-100 rounded">Kategori</button>
Â  Â  Â  <button id="tabProduct" class="px-4 py-2 bg-gray-100 rounded">ÃœrÃ¼n</button>
Â  Â  </div>
Â  </div>

Â  <div id="sectionBanner">
Â  Â  <h3 class="font-semibold mb-3">ðŸ–¼ Banner YÃ¶netimi</h3>
    <div id="banner-form-area" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
Â  Â  Â  <input id="bannerUrl" placeholder="Banner gÃ¶rsel URL" class="border p-2 rounded col-span-2" />
Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  <button id="addBannerBtn" class="bg-green-600 text-white px-4 py-2 rounded w-1/2">Ekle</button>
Â  Â  Â  Â  <button id="refreshBannerBtn" class="bg-gray-200 px-4 py-2 rounded w-1/2">Yenile</button>
Â  Â  Â  </div>
    </div>
Â  Â  <div id="bannerList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
Â  </div>

Â  <div id="sectionCategory" class="hidden">
Â  Â  <h3 class="font-semibold mb-3">ðŸ—‚ Kategori YÃ¶netimi</h3>
    <div id="category-form-area" class="flex gap-3 mb-4">
Â  Â  Â  <input id="categoryName" placeholder="Kategori adÄ±" class="border p-2 rounded w-full" />
Â  Â  Â  <select id="parentCategory" class="border p-2 rounded">
Â  Â  Â  Â  <option value="">Ãœst Kategori</option>
Â  Â  Â  </select>
Â  Â  Â  <button id="addCategoryBtn" class="bg-green-600 text-white px-4 py-2 rounded">Ekle</button>
    </div>
Â  Â  <div id="categoryList" class="space-y-2"></div>
Â  </div>

Â  <div id="sectionProduct" class="hidden">
Â  Â  <h3 class="font-semibold mb-3">ðŸ›’ ÃœrÃ¼n YÃ¶netimi</h3>

    <div id="editingStatus" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-4 hidden" role="alert">
        <p class="font-bold">DÃ¼zenleme Modu:</p>
        <p id="editingProductName"></p>
        <input type="hidden" id="editingProductId" />
    </div>

Â  Â  <div id="product-form-area" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 border p-4 rounded-lg bg-gray-50">
Â  Â  Â  <input id="productName" placeholder="ÃœrÃ¼n adÄ±" class="border p-2 rounded" />
Â  Â  Â  <input id="productPrice" placeholder="Fiyat (â‚º)" class="border p-2 rounded" type="number" step="0.01"/>
Â  Â  Â  <select id="productCategorySelect" class="border p-2 rounded">
Â  Â  Â  Â  <option value="">Kategori seÃ§</option>
Â  Â  Â  </select>
Â  Â  Â  <input id="productDescription" placeholder="ÃœrÃ¼n aÃ§Ä±klamasÄ±" class="border p-2 rounded md:col-span-3" />
Â  Â  Â  <input id="productImage" placeholder="Ana gÃ¶rsel URL" class="border p-2 rounded" />
Â  Â  Â  <input id="productVideo" placeholder="Video URL (opsiyonel)" class="border p-2 rounded" />
Â  Â  Â  <input id="productExtraImages" placeholder="Ek gÃ¶rseller (URL, virgÃ¼l ile)" class="border p-2 rounded md:col-span-3" />
Â  Â  Â  <div class="flex items-center gap-2">
            <input id="productActive" type="checkbox" class="mt-2" /> 
            <label for="productActive" class="text-sm">Aktif</label>
        </div>
Â  Â  </div>

Â  Â  <div class="flex gap-2 mb-6">
Â  Â  Â  <button id="addProductBtn" class="bg-blue-600 text-white px-4 py-2 rounded"><i class="ri-add-line"></i> ÃœrÃ¼n Ekle</button>
      <button id="updateProductBtn" class="bg-yellow-600 text-white px-4 py-2 rounded hidden"><i class="ri-save-line"></i> Kaydet ve GÃ¼ncelle</button>
      <button id="cancelEditBtn" class="bg-gray-400 text-white px-4 py-2 rounded hidden"><i class="ri-close-line"></i> Ä°ptal</button>
Â  Â  Â  <button id="refreshProductsBtn" class="bg-gray-200 px-4 py-2 rounded"><i class="ri-refresh-line"></i> Yenile</button>
Â  Â  </div>

Â  Â  <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
Â  </div>

</section>

<div id="msg" class="mt-4 text-sm text-red-600"></div>
</main>

<footer class="text-center text-gray-400 py-8">
Â© 2025 Getir KÄ±brÄ±s
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
Â  authDomain: "kibris-6b4f7.firebaseapp.com",
Â  projectId: "kibris-6b4f7",
Â  storageBucket: "kibris-6b4f7.appspot.com",
Â  messagingSenderId: "141262926171",
Â  appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
Â  measurementId: "G-JL9P6BRZTD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();
const ADMIN_EMAIL = "emirmob09@gmail.com"; // BURAYI KENDÄ° ADMÄ°N EMAIL'Ä°NÄ°ZLE DEÄžÄ°ÅžTÄ°RMEYÄ° UNUTMAYIN!

// --- DOM Elementleri (KÄ±saltÄ±ldÄ±) ---
const loginScreen = document.getElementById("login-screen");
const googleSignIn = document.getElementById("googleSignIn");
const adminPanel = document.getElementById("admin-panel");
const adminEmailSpan = document.getElementById("admin-email");
const logoutBtn = document.getElementById("logoutBtn");
const msg = document.getElementById("msg");

const tabBanner = document.getElementById("tabBanner");
const tabProduct = document.getElementById("tabProduct");
const sectionProduct = document.getElementById("sectionProduct");

const productName = document.getElementById("productName");
const productPrice = document.getElementById("productPrice");
const productCategorySelect = document.getElementById("productCategorySelect");
const productImage = document.getElementById("productImage");
const productVideo = document.getElementById("productVideo");
const productExtraImages = document.getElementById("productExtraImages");
const productDescription = document.getElementById("productDescription");
const productActive = document.getElementById("productActive");

const addProductBtn = document.getElementById("addProductBtn");
const updateProductBtn = document.getElementById("updateProductBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const productList = document.getElementById("productList");
const editingStatus = document.getElementById("editingStatus");
const editingProductName = document.getElementById("editingProductName");
const editingProductId = document.getElementById("editingProductId");
// DiÄŸer tÃ¼m elementler...

let currentProducts = [];

// --- YARDIMCI ---
function showMsg(text, isError=true){ msg.textContent=text; msg.style.color=isError?"#b91c1c":"#065f46"; if(text) setTimeout(()=>{msg.textContent="";},5000);}

function resetProductForm(isEditing = false) {
    productName.value = "";
    productPrice.value = "";
    productCategorySelect.value = "";
    productImage.value = "";
    productVideo.value = "";
    productExtraImages.value = "";
    productDescription.value = "";
    productActive.checked = false;
    editingProductId.value = "";

    if (isEditing) {
        addProductBtn.classList.add("hidden");
        updateProductBtn.classList.remove("hidden");
        cancelEditBtn.classList.remove("hidden");
        editingStatus.classList.remove("hidden");
    } else {
        addProductBtn.classList.remove("hidden");
        updateProductBtn.classList.add("hidden");
        cancelEditBtn.classList.add("hidden");
        editingStatus.classList.add("hidden");
    }
}
// ... DiÄŸer fonksiyonlar (activateTab, Auth) burada devam ediyor ...
// ... loadBanners ve loadCategories fonksiyonlarÄ± burada devam ediyor ...
// ... addProductBtn event listener'Ä± burada devam ediyor ...

// --- PRODUCT DÃœZENLEME MANTIÄžI (GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž) ---
function editProduct(productId) {
    const product = currentProducts.find(p => p.id === productId);

    if (product) {
        productName.value = product.name || '';
        // FiyatÄ± string'e Ã§evirip atÄ±yoruz.
        productPrice.value = (product.price !== undefined && product.price !== null) ? String(product.price) : ''; 
        productCategorySelect.value = product.category || '';
        productImage.value = product.image || '';
        productVideo.value = product.video || '';
        
        // Ek gÃ¶rselleri doÄŸru ÅŸekilde string'e dÃ¶nÃ¼ÅŸtÃ¼rme
        if (Array.isArray(product.extraImages) && product.extraImages.length > 0) {
            productExtraImages.value = product.extraImages.join(', ');
        } else {
            productExtraImages.value = '';
        }

        productDescription.value = product.description || '';
        productActive.checked = product.active || false;

        editingProductId.value = productId;
        editingProductName.textContent = product.name;
        
        resetProductForm(true); 
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        showMsg("DÃ¼zenlenecek Ã¼rÃ¼n bulunamadÄ±.", true);
    }
}

// KRÄ°TÄ°K DÃœZELTME: updateProductBtn olay dinleyicisi
updateProductBtn.addEventListener("click", async () => {
    const productId = editingProductId.value;
    if (!productId) {
        showMsg("Hata: GÃ¼ncellenecek Ã¼rÃ¼n ID'si bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.", true);
        return;
    } 

    const name = productName.value.trim();
    const priceInput = productPrice.value.trim(); 
    const price = parseFloat(priceInput);
    const category = productCategorySelect.value;
    const image = productImage.value.trim();
    const video = productVideo.value.trim();
    const extraImages = productExtraImages.value.trim().split(",").map(x => x.trim()).filter(Boolean);
    const desc = productDescription.value.trim();
    const active = productActive.checked;

    if (!name || isNaN(price) || price <= 0 || !category || !image) { 
        showMsg("Zorunlu alanlarÄ± (Ad, GeÃ§erli Fiyat, Kategori, GÃ¶rsel) doldurun.", true); 
        return; 
    }
    
    updateProductBtn.disabled = true;
    updateProductBtn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> GÃ¼ncelleniyor...';


    try {
        const productRef = doc(db, "homeProducts", productId);
        await updateDoc(productRef, {
            name, 
            price, 
            category, 
            image, 
            video, 
            extraImages, 
            description: desc, 
            active,
            updatedAt: new Date()
        });

        resetProductForm(false); 
        await loadProducts(); 
        showMsg("ÃœrÃ¼n baÅŸarÄ±yla gÃ¼ncellendi!", false);

    } catch (e) {
        console.error("Firebase GÃ¼ncelleme HatasÄ±:", e);
        showMsg("GÃ¼ncelleme hatasÄ± oluÅŸtu: " + e.message + " (Yetki hatasÄ± olabilir)", true);
    } finally {
        updateProductBtn.disabled = false;
        updateProductBtn.innerHTML = '<i class="ri-save-line"></i> Kaydet ve GÃ¼ncelle';
    }
});


// loadProducts fonksiyonu Harita hatasÄ± iÃ§in kontrol ile gÃ¼ncellendi
async function loadProducts(){
Â  productList.innerHTML="<i class='ri-loader-4-line animate-spin'></i> ÃœrÃ¼nler yÃ¼kleniyor...";
Â  try {
        const snap=await getDocs(collection(db,"homeProducts"));Â 
        productList.innerHTML="";
        currentProducts = [];

    Â  Â  if(snap.empty){ productList.innerHTML="<p class='text-gray-500'>YÃ¼klenecek Ã¼rÃ¼n bulunamadÄ±.</p>"; return; }

    Â  Â  snap.forEach(docSnap=>{
    Â  Â  Â  const d=docSnap.data();
            currentProducts.push({ id: docSnap.id, ...d });

    Â  Â  Â  Â  const el=document.createElement("div");
    Â  Â  Â  Â  el.className="p-3 bg-white rounded shadow-md flex flex-col justify-between";
    Â  Â  Â  Â Â 
    Â  Â  Â  Â  // KRÄ°TÄ°K: extraImages kontrolÃ¼ (Undefined hatasÄ±nÄ± engeller)
    Â  Â  Â  Â  const extraImagesArray = Array.isArray(d.extraImages) ? d.extraImages : [];
    Â  Â  Â  Â  const extraImagesHtml = extraImagesArray.length > 0
    Â  Â  Â  Â  Â  ? extraImagesArray.map(url => `<img src="${url}" class="w-16 h-16 object-cover inline-block mr-2 my-1 rounded border">`).join("")
    Â  Â  Â  Â  Â  : '';Â 

    Â  Â  Â  Â  el.innerHTML=`
    Â  Â  Â  Â  Â  <div>
    Â  Â  Â  Â  Â  Â  <div class="font-semibold text-lg">${d.name} <span class="text-xs ${d.active?"text-green-600":"text-red-600"}">${d.active?"(Aktif)":"(Pasif)"}</span></div>
    Â  Â  Â  Â  Â  Â  <div class="text-sm text-gray-600">${d.category}</div>
    Â  Â  Â  Â  Â  Â  <div class="text-sm my-1">${d.description||""}</div>
    Â  Â  Â  Â  Â  Â  <div class="text-blue-600 font-bold">${(d.price || 0).toFixed(2)} â‚º</div>
    Â  Â  Â  Â  Â  Â  <img src="${d.image}" class="w-full h-36 object-cover my-2 rounded border" />
    Â  Â  Â  Â  Â  Â  ${extraImagesHtml}
    Â  Â  Â  Â  Â  </div>
    Â  Â  Â  Â  Â  <div class="flex gap-2 mt-3 pt-3 border-t">
                    <button data-id="${docSnap.id}" class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition-colors flex items-center gap-1"><i class="ri-edit-line"></i> DÃ¼zenle</button>
    Â  Â  Â  Â  Â  Â  <button data-id="${docSnap.id}" class="delete-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors flex items-center gap-1"><i class="ri-delete-bin-line"></i> Sil</button>
              </div>
    Â  Â  Â  Â  `;
    Â  Â  Â  Â  
    Â  Â  Â  Â  el.querySelector(".delete-btn").addEventListener("click",async(e)=>{ 
                const id = e.target.dataset.id;
                await deleteDoc(doc(db,"homeProducts",id)); 
                await loadProducts(); 
                showMsg("ÃœrÃ¼n silindi",false); 
            });

            el.querySelector(".edit-btn").addEventListener("click", (e) => {
                editProduct(e.target.dataset.id);
            });

    Â  Â  Â  Â  productList.appendChild(el);
    Â  Â  });
    } catch (e) {
        console.error("loadProducts Hata:", e);
        productList.innerHTML = `<p class='text-red-600'>ÃœrÃ¼nler yÃ¼klenemedi. Yetki veya baÄŸlantÄ± hatasÄ±: ${e.message}</p>`;
    }
}
</script>
</body>
</html>
