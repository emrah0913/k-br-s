<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Müşteri Yorumları ve Puanları | Getir Kıbrıs</title>
    <meta name="description" content="Getir Kıbrıs kullanıcılarının Trendyol ve Hepsiburada siparişleri hakkındaki yorumlarını okuyun ve siz de deneyiminizi paylaşın.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">

    <meta name="google-signin-client_id" content="141262926171-kcofk0ogdaq2dqnod01q47os04utmgvj.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // SİZİN TARAFLINDAN SAĞLANAN FIREBASE KONFİGÜRASYONU
        const firebaseConfig = {
            apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
            authDomain: "kibris-6b4f7.firebaseapp.com",
            projectId: "kibris-6b4f7",
            storageBucket: "kibris-6b4f7.firebasestorage.app",
            messagingSenderId: "141262926171",
            appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
            measurementId: "G-JL9P6BRZTD"
        };

        // Firebase'i Başlat ve Servisleri Tanımla
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
    <script>
        // Tailwind CSS Konfigürasyonu
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5d3ebc',
                        secondary: '#ffd300'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    borderRadius: {
                        'button': '8px',
                        DEFAULT: '8px',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9f9f9; 
        }
        /* Yıldız Stilleri */
        .stars input[type="radio"]:checked ~ label::before {
            color: #ffd300; 
        }
        .stars label:hover,
        .stars label:hover ~ label {
            color: #ffd300; 
        }
        .stars label {
            font-family: 'RemixIcon' !important;
            font-style: normal;
            font-size: 24px;
            color: #ddd;
            transition: color 0.2s;
            cursor: pointer;
        }
        .stars label::before {
            content: "\e8a1"; /* ri-star-fill unicode */
        }
        .stars input[type="radio"] {
            display: none;
        }
        .stars {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }
    </style>
</head>
<body class="bg-gray-50">

<div class="w-full max-w-screen-lg mx-auto relative min-h-screen pb-16">

    <header class="fixed top-0 w-full bg-white shadow-sm z-50 px-4 py-3 flex items-center">
        <div class="flex-1"></div>
        <div class="flex flex-col items-center">
            <img src="logom.png" alt="Getir Kıbrıs" class="h-12"> 
            <a href="index.html" class="text-sm font-medium text-primary mt-1">Ana Sayfa</a>
        </div>
        <div class="flex-1 flex justify-end">
            <div id="auth-button" class="w-8 h-8 flex items-center justify-center">
                <button id="login-btn" class="text-xs text-primary font-medium cursor-pointer">
                    <i class="ri-google-fill ri-lg"></i>
                </button>
                <div id="profile-container" class="hidden">
                    <img id="profile-img" src="" alt="Profil" class="w-8 h-8 rounded-full cursor-pointer">
                </div>
            </div>
        </div>
    </header>

    <main class="pt-20 p-4">
        <section id="reviews-section" class="bg-white rounded-lg shadow-lg mx-auto p-6 mb-8 max-w-2xl">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center border-b-4 border-primary pb-3 tracking-tight">
                ⭐ Müşteri Yorumları ve Puanları
            </h1>
            <p class="text-center text-gray-600 mb-6">Hizmetimizden memnun kaldınız mı? Lütfen deneyiminizi paylaşın!</p>

            <div id="comment-form-container" class="border border-gray-200 p-4 rounded-lg mb-6" style="display:none;">
                <h3 class="text-xl font-semibold mb-3 text-primary">Yorumunuzu Ekleyin</h3>
                <form id="comment-form" class="space-y-3">
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Puanınız:</label>
                        <div class="stars">
                            <input type="radio" id="star5" name="rating" value="5" required><label for="star5" title="5 Puan"></label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 Puan"></label>
                            <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 Puan"></label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 Puan"></label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 Puan"></label>
                        </div>
                    </div>
                    
                    <textarea id="comment-text" placeholder="Hizmetimiz hakkındaki görüşlerinizi yazın..." rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm" required></textarea>
                    
                    <button type="submit" class="w-full bg-secondary text-primary py-3 rounded-button font-semibold hover:bg-secondary/90 transition-colors cursor-pointer flex items-center justify-center gap-2">
                        <i class="ri-send-plane-line"></i>
                        <span>Yorumu Gönder</span>
                    </button>
                    <p id="comment-status" class="text-sm text-center mt-2 text-green-600 hidden"></p>
                </form>
            </div>

            <div id="login-to-comment" class="flex flex-col items-center justify-center p-6 bg-primary/5 rounded-lg border border-primary/10">
                <p class="text-gray-700 mb-3 font-medium">Yorum Yapmak ve Puan Vermek İçin Lütfen Giriş Yapın:</p>
                <div id="google-login-button" class="g-signin2" data-onsuccess="onSignIn" data-width="240" data-height="40" data-longtitle="true" data-theme="dark"></div>
            </div>

            <div id="approved-comments-list" class="space-y-4 mt-8">
                </div>

        </section>
    </main>
</div>

<script>
    let currentUser = null;

    // 1. Google Girişi Başarılı Olunca Çalışacak Fonksiyon
    function onSignIn(googleUser) {
        const profile = googleUser.getBasicProfile();
        // Kullanıcı bilgilerini global değişkene kaydet
        currentUser = {
            id: profile.getId(), 
            name: profile.getName(),
            email: profile.getEmail(),
            imageUrl: profile.getImageUrl(),
            token: googleUser.getAuthResponse().id_token
        };

        // Görünümü güncelle
        document.getElementById('profile-img').src = currentUser.imageUrl;
        document.getElementById('profile-container').classList.remove('hidden');
        document.getElementById('login-btn').classList.add('hidden');
        document.getElementById('login-to-comment').style.display = 'none';
        document.getElementById('comment-form-container').style.display = 'block';
    }

    // 2. Yorum Formu Gönderildiğinde Çalışacak Fonksiyon (FIRESTORE)
    document.getElementById('comment-form').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!currentUser) {
            alert("Yorum yapabilmek için lütfen önce Google ile giriş yapın.");
            return;
        }

        const ratingElement = document.querySelector('input[name="rating"]:checked');
        const commentText = document.getElementById('comment-text').value.trim();
        const commentStatus = document.getElementById('comment-status');

        if (!ratingElement || !commentText) {
            alert("Lütfen puanınızı seçin ve yorumunuzu yazın.");
            return;
        }
        
        const commentData = {
            userId: currentUser.id,
            userName: currentUser.name,
            userPhoto: currentUser.imageUrl,
            rating: parseInt(ratingElement.value),
            commentText: commentText,
            isApproved: false, // Yönetici onayı bekliyor
            createdAt: firebase.firestore.FieldValue.serverTimestamp() // Sunucu Zaman Damgası
        };
        
        commentStatus.textContent = "Yorumunuz gönderiliyor...";
        commentStatus.classList.remove('hidden', 'text-green-600', 'text-red-600');
        commentStatus.classList.add('text-gray-600');
        
        // Firestore'a veri kaydı ('comments' koleksiyonuna)
        db.collection("comments").add(commentData)
        .then(() => {
            commentStatus.textContent = "Yorumunuz başarıyla gönderildi ve yönetici onayını bekliyor. 🎉";
            commentStatus.classList.remove('text-gray-600');
            commentStatus.classList.add('text-green-600');
            document.getElementById('comment-form').reset();
            document.querySelectorAll('.stars input[type="radio"]').forEach(radio => radio.checked = false);
            commentStatus.classList.remove('hidden');
        })
        .catch((error) => {
            console.error("Yorum kaydetme hatası:", error);
            commentStatus.textContent = "Hata: Yorum kaydedilemedi. Lütfen tekrar deneyin.";
            commentStatus.classList.remove('text-gray-600');
            commentStatus.classList.add('text-red-600');
            commentStatus.classList.remove('hidden');
        });
    });
    
    // Google Sign-Out Fonksiyonu
    document.getElementById('profile-img').addEventListener('click', function() {
        if (confirm("Çıkış yapmak istediğinizden emin misiniz?")) {
            if (typeof gapi !== 'undefined' && gapi.auth2) {
                const auth2 = gapi.auth2.getAuthInstance();
                auth2.signOut().then(function () {
                    currentUser = null;
                    document.getElementById('profile-container').classList.add('hidden');
                    document.getElementById('login-btn').classList.remove('hidden');
                    document.getElementById('login-to-comment').style.display = 'flex';
                    document.getElementById('comment-form-container').style.display = 'none';
                });
            } else {
                currentUser = null;
                document.getElementById('profile-container').classList.add('hidden');
                document.getElementById('login-btn').classList.remove('hidden');
                document.getElementById('login-to-comment').style.display = 'flex';
                document.getElementById('comment-form-container').style.display = 'none';
            }
        }
    });

    // Yıldız HTML'i üreten yardımcı fonksiyon
    function generateStars(rating) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                html += '<i class="ri-star-fill"></i>';
            } else {
                html += '<i class="ri-star-line text-gray-300"></i>';
            }
        }
        return html;
    }

    // 3. Onaylanmış Yorumları Çekip Listeleme Fonksiyonu (FIRESTORE)
    function fetchApprovedComments() {
        const listContainer = document.getElementById('approved-comments-list');
        listContainer.innerHTML = '<h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Kullanıcı Deneyimleri</h3><p class="text-gray-500 text-center">Yorumlar yükleniyor...</p>';

        // Firestore sorgusu: isApproved = true olanları, en yeniyi üste koyarak getir.
        db.collection("comments")
          .where("isApproved", "==", true) 
          .orderBy("createdAt", "desc")
          .get()
          .then((querySnapshot) => {
            listContainer.innerHTML = '<h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Kullanıcı Deneyimleri</h3>';
            
            if (querySnapshot.empty) {
                listContainer.insertAdjacentHTML('beforeend', '<p class="text-gray-500 text-center">Henüz onaylanmış bir yorum bulunmamaktadır.</p>');
                return;
            }

            querySnapshot.forEach((doc) => {
                const comment = doc.data();
                
                const starsHtml = generateStars(comment.rating);
                // Tarih formatlama
                const dateString = comment.createdAt 
                    ? new Date(comment.createdAt.seconds * 1000).toLocaleDateString('tr-TR') 
                    : 'Tarih Yok';
                
                const commentElement = `
                    <div class="comment-card bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <img src="${comment.userPhoto || 'https://via.placeholder.com/40'}" alt="${comment.userName}" class="w-8 h-8 rounded-full mr-2">
                                <p class="font-semibold text-primary">${comment.userName}</p>
                            </div>
                            <div class="star-rating text-secondary text-lg">
                                ${starsHtml}
                            </div>
                        </div>
                        <p class="text-sm text-gray-700">${comment.commentText}</p>
                        <p class="text-xs text-gray-500 mt-2 text-right">${dateString}</p>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', commentElement);
            });
          })
          .catch((error) => {
              console.error("Yorumları yükleme hatası:", error);
              listContainer.innerHTML = '<p class="text-red-500 text-center">Yorumlar yüklenirken bir hata oluştu.</p>';
          });
    }

    // Sayfa yüklendiğinde yorumları çek
    document.addEventListener('DOMContentLoaded', fetchApprovedComments);
</script>

</body>
</html>
