<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Paneli</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0094da;
      --accent: #ffcb05;
      --dark: #232323;
      --light-bg: #f7fafc;
      --white: #fff;
      --gray: #ececec;
      --radius: 16px;
      --shadow: 0 4px 24px rgba(0,0,0,0.07);
      --danger: #e74c3c;
      --danger-bg: #ffeaea;
      --success: #24a85c;
      --success-bg: #e1f8e7;
      --info-bg: #eafdff;
      --info: #1880a7;
    }
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      background: var(--light-bg);
      color: var(--dark);
      min-height: 100vh;
    }
    .admin-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 12px 50px 12px;
    }
    h1 {
      color: var(--primary);
      margin-bottom: 16px;
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -.5px;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 22px;
    }
    .toolbar input, .toolbar select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1.2px solid var(--gray);
      font-size: 1rem;
      background: var(--white);
      margin-right: 5px;
    }
    .toolbar button {
      padding: 8px 15px;
      border-radius: var(--radius);
      border: none;
      font-weight: 600;
      background: var(--primary);
      color: var(--white);
      font-size: 1rem;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: background .15s;
    }
    .toolbar button:hover { background: #007dc1; }
    .toolbar .out-btn {
      background: var(--danger) !important;
      margin-left: auto;
    }
    .toolbar .out-btn:hover { background: #b91c1c !important; }
    .summary-box {
      background: var(--info-bg);
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 22px;
      color: var(--info);
      font-weight: 600;
      font-size: 1.07rem;
      display: flex;
      gap: 28px;
      flex-wrap: wrap;
    }
    .orders-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 10px;
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 36px;
    }
    .orders-table th, .orders-table td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--gray);
      font-size: 1rem;
      text-align: left;
      vertical-align: top;
    }
    .orders-table th {
      background: var(--light-bg);
      color: var(--primary);
      font-weight: 700;
    }
    .orders-table tr:last-child td {
      border-bottom: none;
    }
    .status-select {
      padding: 5px 8px;
      border-radius: 7px;
      border: 1px solid var(--gray);
      background: var(--info-bg);
      color: var(--primary);
      font-weight: 600;
    }
    .delete-btn {
      background: var(--danger-bg);
      color: var(--danger);
      border: none;
      border-radius: 6px;
      padding: 5px 10px;
      cursor: pointer;
      font-weight: 600;
      transition: background .14s, color .14s;
    }
    .delete-btn:hover { background: var(--danger); color: var(--white); }
    .modal-bg {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.15);
      z-index: 10001;
      justify-content: center;
      align-items: center;
      transition: background .2s;
    }
    .modal {
      background: var(--white);
      border-radius: 18px;
      padding: 32px 24px 22px 24px;
      min-width: 340px;
      box-shadow: var(--shadow);
      text-align: left;
      max-width: 98vw;
      position: relative;
    }
    .modal-close {
      position: absolute;
      right: 14px;
      top: 8px;
      background: none;
      border: none;
      color: var(--danger);
      font-size: 1.6rem;
      font-weight: bold;
      cursor: pointer;
    }
    .modal h2 {
      color: var(--primary);
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: -.2px;
    }
    .modal input[type="password"] {
      width: 100%;
      margin-bottom: 12px;
      font-size: 1.07rem;
    }
    .modal button {
      width: 100%;
      margin-top: 2px;
    }
    .modal .error-msg {
      color: var(--danger);
      font-weight: 600;
      margin-top: 12px;
      font-size: 1rem;
      display: none;
    }
    .success-info {
      background: var(--success-bg);
      color: var(--success);
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      margin-bottom: 14px;
      text-align: center;
      font-size: 1.05rem;
      display: none;
    }
    .error-info {
      background: var(--danger-bg);
      color: var(--danger);
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      margin-bottom: 14px;
      text-align: center;
      font-size: 1.05rem;
      display: none;
    }
    /* Müşteriler modalı */
    .customer-group {
      margin-bottom: 18px;
      background: var(--light-bg);
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.03);
    }
    .customer-group b {
      color: var(--primary);
      font-size: 1.04rem;
    }
    .customer-group ul {
      margin: 8px 0 0 2px;
      padding-left: 16px;
      font-size: .99rem;
    }
    @media (max-width: 900px) {
      .summary-box { flex-direction: column; gap: 10px; }
      .admin-container { padding: 17px 2vw 24px 2vw; }
      .modal { min-width: 0; width: 98vw; }
      .orders-table th, .orders-table td { font-size: .94rem; }
    }
    @media (max-width: 540px) {
      h1 { font-size: 1.25rem; }
      .modal { padding: 18px 4vw 12px 4vw; }
    }
  </style>
</head>
<body>
  <!-- Şifreli giriş ekranı -->
  <div id="loginModal" class="modal-bg" style="display:flex;">
    <div class="modal">
      <button class="modal-close" onclick="document.getElementById('loginModal').style.display='none';">&times;</button>
      <h2>Admin Girişi</h2>
      <input type="password" id="adminPassword" placeholder="Şifre">
      <button onclick="adminLogin()">Giriş Yap</button>
      <div id="loginError" class="error-msg"></div>
    </div>
  </div>

  <div class="admin-container" style="display:none;" id="adminPanel">
    <h1>Admin Paneli</h1>
    <div class="toolbar">
      <input type="text" id="searchSiparisKodu" placeholder="Sipariş Kodu ile ara">
      <input type="text" id="searchMusteri" placeholder="Müşteri adı ile ara">
      <input type="date" id="startDate">
      <span style="color:var(--gray);">—</span>
      <input type="date" id="endDate">
      <button onclick="filterOrders()">Filtrele</button>
      <button onclick="clearFilters()">Temizle</button>
      <button onclick="showCustomers()">Kayıtlı Müşteriler</button>
      <button class="out-btn" onclick="adminLogout()">Çıkış Yap</button>
    </div>
    <div class="summary-box" id="summaryBox">
      <span>Yükleniyor...</span>
    </div>
    <div class="success-info" id="successInfo"></div>
    <div class="error-info" id="errorInfo"></div>
    <table class="orders-table" id="ordersTable">
      <thead>
        <tr>
          <th>Müşteri</th>
          <th>Sipariş Kodu</th>
          <th>Adres</th>
          <th>Telefon</th>
          <th>Kategori</th>
          <th>Toplam Tutar</th>
          <th>Durum</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody>
        <!-- Siparişler JS ile eklenecek -->
      </tbody>
    </table>
  </div>

  <!-- Müşteriler Modalı -->
  <div id="customersModal" class="modal-bg">
    <div class="modal" style="max-width:520px;">
      <button class="modal-close" onclick="closeCustomersModal()">&times;</button>
      <h2>Kayıtlı Müşteriler</h2>
      <div id="customersList">
        <!-- Müşteri bilgileri JS ile eklenecek -->
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // 1. FIREBASE CONFIG (Senin sağladığın config)
    const firebaseConfig = {
      apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
      authDomain: "kibris-6b4f7.firebaseapp.com",
      projectId: "kibris-6b4f7",
      storageBucket: "kibris-6b4f7.firebasestorage.app",
      messagingSenderId: "141262926171",
      appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
      measurementId: "G-JL9P6BRZTD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. ADMIN ŞİFRESİ
    const ADMIN_PASSWORD = "ornekSifre123"; // Burayı değiştir!

    // UI referansları
    const adminPanel = document.getElementById("adminPanel");
    const loginModal = document.getElementById("loginModal");
    const loginError = document.getElementById("loginError");
    const successInfo = document.getElementById("successInfo");
    const errorInfo = document.getElementById("errorInfo");

    function adminLogin() {
      const pw = document.getElementById('adminPassword').value;
      if(pw === ADMIN_PASSWORD){
        loginModal.style.display = 'none';
        adminPanel.style.display = '';
        document.getElementById('adminPassword').value = "";
        loginError.style.display = "none";
        loadOrders(); // Girişte siparişleri yükle
      } else {
        loginError.innerText = "Hatalı şifre!";
        loginError.style.display = "";
      }
    }
    function adminLogout() {
      adminPanel.style.display = 'none';
      loginModal.style.display = 'flex';
      errorInfo.style.display = "none";
      successInfo.style.display = "none";
    }

    // SİPARİŞLERİ FIRESTORE'DAN ÇEK
    let allOrders = [];
    async function loadOrders() {
      document.querySelector("#summaryBox").innerHTML = "<span>Yükleniyor...</span>";
      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";
      allOrders = [];
      try {
        const snap = await db.collection("siparisler").orderBy("createdAt", "desc").get();
        snap.forEach(doc => {
          const data = doc.data();
          allOrders.push({ ...data, id: doc.id });
        });
        renderOrders(allOrders);
        renderSummary(allOrders);
      } catch(e) {
        tbody.innerHTML = `<tr><td colspan="8" style="color:var(--danger);font-weight:600;">Siparişler yüklenemedi.</td></tr>`;
        document.querySelector("#summaryBox").innerHTML = "Siparişler yüklenemedi!";
      }
    }
    function renderOrders(orders) {
      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";
      if(!orders.length) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Kayıt yok.</td></tr>`;
        return;
      }
      for(const o of orders) {
        tbody.innerHTML += `
          <tr>
            <td>${o.email || "-"}</td>
            <td>${o.siparisKodu || "-"}</td>
            <td>${o.sehir ? (o.sehir + "<br>" + (o.acikAdres||"")) : "-"}</td>
            <td>${o.telefon || "-"}</td>
            <td>${o.kategori || "-"}</td>
            <td>${o.toplamTutar ? o.toplamTutar + " TL" : "-"}</td>
            <td>
              <select class="status-select" data-id="${o.id}" onchange="updateStatus('${o.id}', this.value)">
                <option ${o.durum=="Yeni"?'selected':''}>Yeni</option>
                <option ${o.durum=="Hazırlanıyor"?'selected':''}>Hazırlanıyor</option>
                <option ${o.durum=="Kargoda"?'selected':''}>Kargoda</option>
                <option ${o.durum=="Teslim Edildi"?'selected':''}>Teslim Edildi</option>
                <option ${o.durum=="İptal"?'selected':''}>İptal</option>
              </select>
            </td>
            <td>
              <button class="delete-btn" onclick="deleteOrder('${o.id}')">Sil</button>
            </td>
          </tr>
        `;
      }
    }
    function renderSummary(orders) {
      // Kategori bazlı toplam tutar
      const summary = {};
      for(const o of orders) {
        if(!o.kategori || !o.toplamTutar) continue;
        if(!summary[o.kategori]) summary[o.kategori]=0;
        summary[o.kategori] += Number(o.toplamTutar);
      }
      let html = "";
      for(const k in summary) {
        html += `<span>${k}: <b>${summary[k]} TL</b></span>`;
      }
      document.getElementById('summaryBox').innerHTML = html || "<span>Kayıt yok.</span>";
    }
    // Durum güncelleme
    async function updateStatus(id, newStatus) {
      try {
        await db.collection("siparisler").doc(id).update({ durum: newStatus });
        successInfo.innerText = "Durum güncellendi.";
        successInfo.style.display = "";
        setTimeout(()=>successInfo.style.display="none", 1300);
      } catch(e) {
        errorInfo.innerText = "Durum güncellenemedi!";
        errorInfo.style.display = "";
        setTimeout(()=>errorInfo.style.display="none", 2000);
      }
    }
    // Sipariş silme
    async function deleteOrder(id) {
      if(!confirm("Siparişi silmek istediğinize emin misiniz?")) return;
      try {
        await db.collection("siparisler").doc(id).delete();
        loadOrders();
        successInfo.innerText = "Sipariş silindi.";
        successInfo.style.display = "";
        setTimeout(()=>successInfo.style.display="none", 1300);
      } catch(e) {
        errorInfo.innerText = "Sipariş silinemedi!";
        errorInfo.style.display = "";
        setTimeout(()=>errorInfo.style.display="none", 2000);
      }
    }
    // Filtreleme
    window.filterOrders = function() {
      let kod = document.getElementById('searchSiparisKodu').value.trim().toLowerCase();
      let musteri = document.getElementById('searchMusteri').value.trim().toLowerCase();
      let start = document.getElementById('startDate').value;
      let end = document.getElementById('endDate').value;
      let filtered = allOrders.filter(o => {
        let ok = true;
        if(kod && !(o.siparisKodu||"").toLowerCase().includes(kod)) ok = false;
        if(musteri && !(o.email||"").toLowerCase().includes(musteri)) ok = false;
        if(start) {
          let d = o.createdAt && o.createdAt.toDate ? o.createdAt.toDate() : (o.createdAt instanceof Date ? o.createdAt : null);
          if(!d || d < new Date(start)) ok = false;
        }
        if(end) {
          let d = o.createdAt && o.createdAt.toDate ? o.createdAt.toDate() : (o.createdAt instanceof Date ? o.createdAt : null);
          if(!d || d > new Date(end + "T23:59:59")) ok = false;
        }
        return ok;
      });
      renderOrders(filtered);
      renderSummary(filtered);
    }
    window.clearFilters = function() {
      document.getElementById('searchSiparisKodu').value = "";
      document.getElementById('searchMusteri').value = "";
      document.getElementById('startDate').value = "";
      document.getElementById('endDate').value = "";
      renderOrders(allOrders);
      renderSummary(allOrders);
    }
    // Kayıtlı müşteriler modalı
    window.showCustomers = function() {
      document.getElementById('customersModal').style.display = 'flex';
      let musteriMap = {};
      for(const o of allOrders) {
        if(!o.email) continue;
        if(!musteriMap[o.email]) musteriMap[o.email] = { siparisler: [], telefon: o.telefon, adres: (o.sehir||'')+" "+(o.acikAdres||'') };
        musteriMap[o.email].siparisler.push(o);
      }
      let html = "";
      for(const e in musteriMap) {
        const m = musteriMap[e];
        html += `<div class="customer-group"><b>${e}</b>
        <br>Telefon: <span>${m.telefon||"-"}</span>
        <br>Adres: <span>${m.adres||"-"}</span>
        <ul>`;
        for(const s of m.siparisler) {
          html += `<li>${s.siparisKodu || "-"} | ${s.kategori || "-"} | ${s.toplamTutar || "-"} TL | ${s.durum || "Yeni"}</li>`;
        }
        html += `</ul></div>`;
      }
      document.getElementById('customersList').innerHTML = html || "Kayıt yok.";
    }
    window.closeCustomersModal = function() {
      document.getElementById('customersModal').style.display = 'none';
    }
  </script>
</body>
</html>
