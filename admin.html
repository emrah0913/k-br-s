<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Paneli</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ... Buraya kadar tüm stiller aynı (değiştirmene gerek yok) ... */
    /* Burada stiller önceki verdiğimle birebir aynı, giriş modalı yerine Google için .modal'a ek style: */
    .google-btn {
      background: #fff;
      color: #444;
      border: 1px solid #ddd;
      font-weight: 600;
      font-family: inherit;
      border-radius: 8px;
      padding: 10px 22px;
      font-size: 1.09rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.09);
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      margin: 0 auto;
      transition: background .13s;
    }
    .google-btn:hover { background: #fafbfc; }
    .google-logo {
      width: 22px;
      height: 22px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <!-- Google ile Giriş ekranı -->
  <div id="loginModal" class="modal-bg" style="display:flex;">
    <div class="modal">
      <h2>Google ile Giriş Yap</h2>
      <button class="google-btn" onclick="googleSignIn()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-logo" alt="Google">
        Google hesabı ile giriş yap
      </button>
      <div id="loginError" class="error-msg"></div>
    </div>
  </div>

  <div class="admin-container" style="display:none;" id="adminPanel">
    <h1>Admin Paneli</h1>
    <div class="toolbar">
      <input type="text" id="searchSiparisKodu" placeholder="Sipariş Kodu ile ara">
      <input type="text" id="searchMusteri" placeholder="Müşteri adı ile ara">
      <input type="date" id="startDate">
      <span style="color:var(--gray);">—</span>
      <input type="date" id="endDate">
      <button onclick="filterOrders()">Filtrele</button>
      <button onclick="clearFilters()">Temizle</button>
      <button onclick="showCustomers()">Kayıtlı Müşteriler</button>
      <button class="out-btn" onclick="adminLogout()">Çıkış Yap</button>
    </div>
    <div class="summary-box" id="summaryBox">
      <span>Yükleniyor...</span>
    </div>
    <div class="success-info" id="successInfo"></div>
    <div class="error-info" id="errorInfo"></div>
    <table class="orders-table" id="ordersTable">
      <thead>
        <tr>
          <th>Müşteri</th>
          <th>Sipariş Kodu</th>
          <th>Adres</th>
          <th>Telefon</th>
          <th>Kategori</th>
          <th>Toplam Tutar</th>
          <th>Durum</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody>
        <!-- Siparişler JS ile eklenecek -->
      </tbody>
    </table>
  </div>

  <!-- Müşteriler Modalı -->
  <div id="customersModal" class="modal-bg">
    <div class="modal" style="max-width:520px;">
      <button class="modal-close" onclick="closeCustomersModal()">&times;</button>
      <h2>Kayıtlı Müşteriler</h2>
      <div id="customersList">
        <!-- Müşteri bilgileri JS ile eklenecek -->
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // Senin Firebase config'in:
    const firebaseConfig = {
      apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
      authDomain: "kibris-6b4f7.firebaseapp.com",
      projectId: "kibris-6b4f7",
      storageBucket: "kibris-6b4f7.appspot.com",
      messagingSenderId: "141262926171",
      appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
      measurementId: "G-JL9P6BRZTD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Sadece belirli email'ler admin olsun istiyorsan:
    // const ADMIN_EMAILS = ["seninmailin@gmail.com", "baskaadmin@site.com"];
    // (Aşağıda kodda yorumlu şekilde gösterdim.)

    // Google ile giriş fonksiyonu
    function googleSignIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          // Eğer belirli admin email'leri isteniyorsa burası:
          // if (ADMIN_EMAILS.length && !ADMIN_EMAILS.includes(result.user.email)) {
          //   auth.signOut();
          //   document.getElementById('loginError').innerText = "Bu Google hesabının admin yetkisi yok!";
          //   document.getElementById('loginError').style.display = "";
          //   return;
          // }
          document.getElementById('loginModal').style.display = 'none';
          document.getElementById('adminPanel').style.display = '';
          document.getElementById('loginError').style.display = "none";
          loadOrders();
        })
        .catch((error) => {
          document.getElementById('loginError').innerText = "Giriş başarısız: " + error.message;
          document.getElementById('loginError').style.display = "";
        });
    }

    // Çıkış
    function adminLogout() {
      firebase.auth().signOut().then(() => {
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('loginModal').style.display = 'flex';
        document.getElementById('successInfo').style.display = "none";
        document.getElementById('errorInfo').style.display = "none";
      });
    }

    // Oturum kontrolü (her sayfa yenilemede)
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('adminPanel').style.display = '';
        loadOrders();
      } else {
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('loginModal').style.display = 'flex';
      }
    });

    // --- Sipariş, filtre, müşteri vs. kodlarının tamamı aynı şekilde devam ediyor ---
    // ... (Aşağıdaki kodlar paneldeki tüm işlevleri SİLME, DURUM, FİLTRELEME vs. aynen korur) ...

    let allOrders = [];
    async function loadOrders() {
      document.querySelector("#summaryBox").innerHTML = "<span>Yükleniyor...</span>";
      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";
      allOrders = [];
      try {
        const snap = await db.collection("siparisler").orderBy("createdAt", "desc").get();
        snap.forEach(doc => {
          const data = doc.data();
          allOrders.push({ ...data, id: doc.id });
        });
        renderOrders(allOrders);
        renderSummary(allOrders);
      } catch(e) {
        tbody.innerHTML = `<tr><td colspan="8" style="color:var(--danger);font-weight:600;">Siparişler yüklenemedi.</td></tr>`;
        document.querySelector("#summaryBox").innerHTML = "Siparişler yüklenemedi!";
      }
    }
    function renderOrders(orders) {
      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";
      if(!orders.length) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Kayıt yok.</td></tr>`;
        return;
      }
      for(const o of orders) {
        tbody.innerHTML += `
          <tr>
            <td>${o.email || "-"}</td>
            <td>${o.siparisKodu || "-"}</td>
            <td>${o.sehir ? (o.sehir + "<br>" + (o.acikAdres||"")) : "-"}</td>
            <td>${o.telefon || "-"}</td>
            <td>${o.kategori || "-"}</td>
            <td>${o.toplamTutar ? o.toplamTutar + " TL" : "-"}</td>
            <td>
              <select class="status-select" data-id="${o.id}" onchange="updateStatus('${o.id}', this.value)">
                <option ${o.durum=="Yeni"?'selected':''}>Yeni</option>
                <option ${o.durum=="Hazırlanıyor"?'selected':''}>Hazırlanıyor</option>
                <option ${o.durum=="Kargoda"?'selected':''}>Kargoda</option>
                <option ${o.durum=="Teslim Edildi"?'selected':''}>Teslim Edildi</option>
                <option ${o.durum=="İptal"?'selected':''}>İptal</option>
              </select>
            </td>
            <td>
              <button class="delete-btn" onclick="deleteOrder('${o.id}')">Sil</button>
            </td>
          </tr>
        `;
      }
    }
    function renderSummary(orders) {
      // Kategori bazlı toplam tutar
      const summary = {};
      for(const o of orders) {
        if(!o.kategori || !o.toplamTutar) continue;
        if(!summary[o.kategori]) summary[o.kategori]=0;
        summary[o.kategori] += Number(o.toplamTutar);
      }
      let html = "";
      for(const k in summary) {
        html += `<span>${k}: <b>${summary[k]} TL</b></span>`;
      }
      document.getElementById('summaryBox').innerHTML = html || "<span>Kayıt yok.</span>";
    }
    // Durum güncelleme
    async function updateStatus(id, newStatus) {
      try {
        await db.collection("siparisler").doc(id).update({ durum: newStatus });
        document.getElementById('successInfo').innerText = "Durum güncellendi.";
        document.getElementById('successInfo').style.display = "";
        setTimeout(()=>document.getElementById('successInfo').style.display="none", 1300);
      } catch(e) {
        document.getElementById('errorInfo').innerText = "Durum güncellenemedi!";
        document.getElementById('errorInfo').style.display = "";
        setTimeout(()=>document.getElementById('errorInfo').style.display="none", 2000);
      }
    }
    // Sipariş silme
    async function deleteOrder(id) {
      if(!confirm("Siparişi silmek istediğinize emin misiniz?")) return;
      try {
        await db.collection("siparisler").doc(id).delete();
        loadOrders();
        document.getElementById('successInfo').innerText = "Sipariş silindi.";
        document.getElementById('successInfo').style.display = "";
        setTimeout(()=>document.getElementById('successInfo').style.display="none", 1300);
      } catch(e) {
        document.getElementById('errorInfo').innerText = "Sipariş silinemedi!";
        document.getElementById('errorInfo').style.display = "";
        setTimeout(()=>document.getElementById('errorInfo').style.display="none", 2000);
      }
    }
    // Filtreleme
    window.filterOrders = function() {
      let kod = document.getElementById('searchSiparisKodu').value.trim().toLowerCase();
      let musteri = document.getElementById('searchMusteri').value.trim().toLowerCase();
      let start = document.getElementById('startDate').value;
      let end = document.getElementById('endDate').value;
      let filtered = allOrders.filter(o => {
        let ok = true;
        if(kod && !(o.siparisKodu||"").toLowerCase().includes(kod)) ok = false;
        if(musteri && !(o.email||"").toLowerCase().includes(musteri)) ok = false;
        if(start) {
          let d = o.createdAt && o.createdAt.toDate ? o.createdAt.toDate() : (o.createdAt instanceof Date ? o.createdAt : null);
          if(!d || d < new Date(start)) ok = false;
        }
        if(end) {
          let d = o.createdAt && o.createdAt.toDate ? o.createdAt.toDate() : (o.createdAt instanceof Date ? o.createdAt : null);
          if(!d || d > new Date(end + "T23:59:59")) ok = false;
        }
        return ok;
      });
      renderOrders(filtered);
      renderSummary(filtered);
    }
    window.clearFilters = function() {
      document.getElementById('searchSiparisKodu').value = "";
      document.getElementById('searchMusteri').value = "";
      document.getElementById('startDate').value = "";
      document.getElementById('endDate').value = "";
      renderOrders(allOrders);
      renderSummary(allOrders);
    }
    // Kayıtlı müşteriler modalı
    window.showCustomers = function() {
      document.getElementById('customersModal').style.display = 'flex';
      let musteriMap = {};
      for(const o of allOrders) {
        if(!o.email) continue;
        if(!musteriMap[o.email]) musteriMap[o.email] = { siparisler: [], telefon: o.telefon, adres: (o.sehir||'')+" "+(o.acikAdres||'') };
        musteriMap[o.email].siparisler.push(o);
      }
      let html = "";
      for(const e in musteriMap) {
        const m = musteriMap[e];
        html += `<div class="customer-group"><b>${e}</b>
        <br>Telefon: <span>${m.telefon||"-"}</span>
        <br>Adres: <span>${m.adres||"-"}</span>
        <ul>`;
        for(const s of m.siparisler) {
          html += `<li>${s.siparisKodu || "-"} | ${s.kategori || "-"} | ${s.toplamTutar || "-"} TL | ${s.durum || "Yeni"}</li>`;
        }
        html += `</ul></div>`;
      }
      document.getElementById('customersList').innerHTML = html || "Kayıt yok.";
    }
    window.closeCustomersModal = function() {
      document.getElementById('customersModal').style.display = 'none';
    }
  </script>
</body>
</html>
