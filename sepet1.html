<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepetim | Getir Kıbrıs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#5d3ebc' } } }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="max-w-screen-lg mx-auto p-4">
    <header class="flex justify-between items-center py-4 border-b bg-white px-4 rounded-xl shadow-sm">
        <div class="flex gap-4">
            <a href="index.html"><img src="getirkibris-logo.png" class="h-6"></a>
            <a href="getirhome.html"><img src="getirhome-logo.png" class="h-6"></a>
        </div>
        <h1 class="font-bold text-lg">Sepetim</h1>
    </header>

    <main id="main-content" class="mt-6">
        <div class="flex flex-col lg:flex-row gap-6">
            <div class="flex-grow space-y-4">
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h2 class="font-bold mb-4 flex items-center gap-2"><i class="ri-shopping-bag-line text-primary"></i> Ürünler</h2>
                    <div id="cart-items-list" class="space-y-6"></div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h2 class="font-bold mb-4">Teslimat</h2>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer">
                            <input type="radio" name="delivery-type" value="warehouse" checked onchange="updateSummary()"> Depodan Teslim
                        </label>
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer">
                            <input type="radio" name="delivery-type" value="home" onchange="updateSummary()"> Adrese Teslim
                        </label>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-80">
                <div class="bg-white p-6 rounded-xl shadow-sm border sticky top-4">
                    <h2 class="font-bold border-b pb-2 mb-4">Sipariş Özeti</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between text-gray-500"><span>Ara Toplam</span><span id="subtotal">0.00 ₺</span></div>
                        <div id="delivery-row" class="flex justify-between text-gray-500 hidden"><span>Teslimat</span><span id="delivery-fee">0.00 ₺</span></div>
                        <div class="flex justify-between font-bold text-lg border-t pt-2 mt-2"><span>Toplam</span><span id="grand-total">0.00 ₺</span></div>
                    </div>
                    <button id="confirm-btn" class="w-full bg-primary text-white py-3 rounded-lg font-bold mt-6 hover:opacity-90 transition-all">Siparişi Onayla</button>
                </div>
            </div>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, getDoc, addDoc, deleteDoc, writeBatch, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY", authDomain: "kibris-6b4f7.firebaseapp.com", projectId: "kibris-6b4f7", storageBucket: "kibris-6b4f7.firebasestorage.app", messagingSenderId: "141262926171", appId: "1:141262926171:web:07226845e51d4bbc0dea7e" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let cartItems = [], currentUser = null, pricing = { categoryRates: {}, cityFees: {} };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const pSnap = await getDoc(doc(db, "settings", "pricing"));
            if (pSnap.exists()) pricing = pSnap.data();
            
            onSnapshot(collection(db, "users", user.uid, "cart"), (snap) => {
                cartItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCart();
                updateSummary();
            });
        } else { window.location.href = "index.html"; }
    });

    function renderCart() {
        const list = document.getElementById("cart-items-list");
        const rates = pricing.categoryRates || {};

        list.innerHTML = cartItems.map(item => {
            const fee = (item.productPrice || 0) * (rates[item.category] || 0);
            const finalPrice = item.orderMethod === 'service' ? (item.productPrice || 0) + fee : fee;
            
            const isHome = item.orderMethod === 'service';
            
            // --- LİNK VE İSİM DÜZELTMESİ ---
            // Eğer isHome (GetirHome) ise detay sayfasına, değilse (Market) productLink'e gider.
            const itemUrl = isHome ? `getirhome.html?view=detail&id=${item.id}` : (item.productLink || "#");
            const displayName = item.productName || item.productLink || "Market Ürünü";

            return `
                <div class="flex items-center gap-4 border-b pb-4 last:border-0">
                    ${isHome ? `<img src="${item.image}" class="w-16 h-16 object-contain rounded-lg border p-1 bg-white">` : ''}
                    
                    <div class="flex-1 min-w-0">
                        <a href="${itemUrl}" ${!isHome ? 'target="_blank"' : ''} class="font-bold text-sm text-gray-800 hover:text-primary transition-colors flex items-center gap-1">
                            <span class="truncate">${displayName}</span>
                            ${isHome ? '<i class="ri-home-4-line text-xs opacity-50"></i>' : '<i class="ri-external-link-line text-xs opacity-50"></i>'}
                        </a>
                        <p class="text-xs text-gray-400 mt-1">${finalPrice.toFixed(2)} ₺</p>
                    </div>

                    <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                        <button onclick="changeQty('${item.id}', -1)" class="w-7 h-7 hover:bg-white rounded transition-all">-</button>
                        <span class="text-xs font-bold w-4 text-center">${item.quantity}</span>
                        <button onclick="changeQty('${item.id}', 1)" class="w-7 h-7 hover:bg-white rounded transition-all">+</button>
                    </div>

                    <div class="text-right min-w-[80px]">
                        <p class="font-bold text-sm text-primary">${(finalPrice * item.quantity).toFixed(2)} ₺</p>
                        <button onclick="deleteItem('${item.id}')" class="text-red-400 hover:text-red-600 mt-1"><i class="ri-delete-bin-line"></i></button>
                    </div>
                </div>`;
        }).join('');
    }

    window.changeQty = async (id, delta) => {
        const item = cartItems.find(i => i.id === id);
        const newQty = Math.max(1, item.quantity + delta);
        if(newQty !== item.quantity) await updateDoc(doc(db, "users", currentUser.uid, "cart", id), { quantity: newQty });
    };

    window.deleteItem = async (id) => {
        if(confirm("Silinsin mi?")) await deleteDoc(doc(db, "users", currentUser.uid, "cart", id));
    };

    window.updateSummary = () => {
        const rates = pricing.categoryRates || {};
        const subtotal = cartItems.reduce((acc, item) => {
            const fee = item.productPrice * (rates[item.category] || 0);
            const price = item.orderMethod === 'service' ? item.productPrice + fee : fee;
            return acc + (price * item.quantity);
        }, 0);

        document.getElementById("subtotal").textContent = subtotal.toFixed(2) + " ₺";
        document.getElementById("grand-total").textContent = subtotal.toFixed(2) + " ₺";
    };

    document.getElementById("confirm-btn").onclick = async () => {
        if(cartItems.length === 0) return;
        const btn = document.getElementById("confirm-btn");
        btn.disabled = true; btn.textContent = "İşleniyor...";
        
        try {
            const orderData = {
                userId: currentUser.uid,
                orderDate: serverTimestamp(),
                status: 'pending_payment',
                items: cartItems,
                totals: { grandTotal: parseFloat(document.getElementById("grand-total").textContent) }
            };
            await addDoc(collection(db, "orders"), orderData);
            const batch = writeBatch(db);
            cartItems.forEach(i => batch.delete(doc(db, "users", currentUser.uid, "cart", i.id)));
            await batch.commit();
            alert("Sipariş başarıyla oluşturuldu!");
            window.location.href = "index.html";
        } catch (e) { alert("Hata!"); btn.disabled = false; btn.textContent = "Onayla"; }
    };
</script>
</body>
</html>
